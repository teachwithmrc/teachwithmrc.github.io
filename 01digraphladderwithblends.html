<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Digraph Word Ladder</title>

  <!-- Use the combined file that includes BOTH base and blend ladders -->
  <script src="digraphs_master_FINAL_v2-2.js" defer></script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    @font-face { font-family: 'BoxesFont'; src: url('fonts/boxes2.otf') format('opentype'); }
    @font-face { font-family: 'UnderlineFont'; src: url('fonts/underlines.otf') format('opentype'); }

    body { font-family: 'Poppins', sans-serif; margin: 10px; text-align: center; }

    h1 { font-size: 32px; margin-bottom: 2px; }
    .subtitle { font-size: 16px; margin-bottom: 8px; }

    button { font-size: 16px; padding: 4px 8px; margin: 4px; cursor: pointer; }
    label { margin: 0 6px; font-size: 16px; }

    .pattern { font-size: 100px; line-height: 1; margin-top: 4px; }

    #copyright { font-size: 12px; text-align: right; width: 100%; }

    @media print {
      body * { visibility: hidden; }
      #ladderOutput, #ladderOutput * { visibility: visible; }
      #ladderOutput { position: absolute; top: 0; left: 0; width: 100%; margin: 0; padding: 10px; box-sizing: border-box; }
      @page { margin: 0.5in; }
    }
  </style>
</head>
<body>

  <div style="text-align:left; font-size:16px; margin-bottom:4px;">
    Name _____________________
  </div>

  <h1>Digraph Word Ladder</h1>
  <p class="subtitle"><strong>Directions:</strong> Start at the top of the ladder and spell the correct words.</p>

  <!-- NEW: Mode selector -->
  <div style="margin-bottom:8px;">
    <strong>Format:</strong>
    <label><input type="radio" name="ladderMode" value="base" checked> Base (Digraphs)</label>
    <label><input type="radio" name="ladderMode" value="with"> Include Blends</label>
    <label><input type="radio" name="ladderMode" value="only"> Only Blends</label>
  </div>

  <div style="margin-bottom:8px;">
    <label><input type="radio" name="cellStyle" value="elkonin" checked> Elkonin Boxes</label>
    <label><input type="radio" name="cellStyle" value="underlines"> Underlines</label>
    <label><input type="checkbox" id="boldChanged" checked> Bold Changed Part</label>
  </div>

  <div>
    <button onclick="generateLadder()">Generate Ladder</button>
    <button onclick="window.print()">Print Page</button>
  </div>

  <div id="ladderOutput" style="margin-top:8px; margin-bottom:60px;"></div>

  <script>
    // --- helpers (unchanged from your working page) ---
    function splitWordByPattern(word, pattern) {
      const chunks = [];
      let i = 0;
      for (let j = 0; j < pattern.length; j++) {
        const len = pattern[j] === '2' ? 2 : 1; // your digraph file uses 1/2, not 1/2/3
        chunks.push(word.slice(i, i + len));
        i += len;
      }
      return chunks;
    }

    function getChangedMap(prevWord, word, prevPattern, pattern) {
      const prevChunks = splitWordByPattern(prevWord, prevPattern);
      const wordChunks = splitWordByPattern(word, pattern);
      const n = Math.max(pattern.length, prevPattern.length);
      const changed = new Array(n);
      for (let i = 0; i < n; i++) changed[i] = (prevChunks[i] || '') !== (wordChunks[i] || '');
      return changed;
    }

    function renderPatternHTML({ pattern, useFont, boldChanged, changedMap }) {
      const isUnderline = useFont === 'UnderlineFont';
      return Array.from(pattern).map((digit, i) => {
        const makeBold = boldChanged && changedMap && changedMap[i];
        const spacing = isUnderline ? 'display:inline-block;margin:0 6px;' : '';
        const weight = makeBold ? 'font-weight:700;' : '';
        return `<span style="${spacing}${weight}">${digit}</span>`;
      }).join('');
    }

    function getChunkHint(prevWord, word, prevPattern, pattern) {
      const prevChunks = splitWordByPattern(prevWord, prevPattern);
      const wordChunks = splitWordByPattern(word, pattern);
      for (let i = 0; i < Math.min(prevChunks.length, wordChunks.length); i++) {
        if (prevChunks[i] !== wordChunks[i]) return `${prevChunks[i]} → ${wordChunks[i]}`;
      }
      return '? → ?';
    }

    // --- NEW: choose ladders for the selected mode ---
    function pickLaddersForMode(mode) {
      const base = (typeof digraphWordLadders !== 'undefined' && Array.isArray(digraphWordLadders)) ? digraphWordLadders : [];
      const blends = (typeof digraphBlendLadders !== 'undefined' && Array.isArray(digraphBlendLadders)) ? digraphBlendLadders : [];

      if (mode === 'base') return base;

      // If Include Blends: prefer the blends set; if empty, fall back to base.
      if (mode === 'with') return blends.length ? blends : base;

      // If Only Blends: require from the blends set; if none, show an error later.
      if (mode === 'only') return blends;

      return base;
    }

    function generateLadder() {
      // data check (both base and blends live in the combined file)
      if (typeof rWordPatterns === 'undefined' || typeof rWordImages === 'undefined') {
        alert('❌ Error: Patterns/Images not loaded. Check your script src path.');
        return;
      }

      const mode = document.querySelector('input[name="ladderMode"]:checked').value;
      const ladders = pickLaddersForMode(mode);
      if (!ladders || !Array.isArray(ladders) || ladders.length === 0) {
        const msg = (mode === 'only')
          ? '❌ No digraph ladders available that include blends.'
          : '❌ No digraph ladders available.';
        alert(msg);
        return;
      }

      const cellStyle = document.querySelector('input[name="cellStyle"]:checked').value;
      const useFont = cellStyle === 'underlines' ? 'UnderlineFont' : 'BoxesFont';
      const boldChanged = document.getElementById('boldChanged').checked;

      const ladder = ladders[Math.floor(Math.random() * ladders.length)];

      const rowsHTML = ladder.map((word, idx) => {
        const isFirst = idx === 0;
        const isLast = idx === ladder.length - 1;
        const prevWord = ladder[idx - 1] || '';

        const pattern = (typeof digraphWordPatterns !== 'undefined' && digraphWordPatterns[word]) ? digraphWordPatterns[word] : '?';
        const prevPattern = (typeof digraphWordPatterns !== 'undefined' && digraphWordPatterns[prevWord]) ? digraphWordPatterns[prevWord] : '?';

        const changedMap = (!isFirst && boldChanged) ? getChangedMap(prevWord, word, prevPattern, pattern) : null;

        const patternHTML = isFirst ? '' : renderPatternHTML({ pattern, useFont, boldChanged, changedMap });

        const wordDisplay = isFirst
          ? `<div style="font-size:32px;font-weight:600;letter-spacing:2px;font-family:'Poppins', sans-serif;">${word}</div>`
          : `<div class="pattern" style="font-family:'${useFont}', monospace; font-size:${useFont === 'UnderlineFont' ? '85px' : '100px'}; letter-spacing:0px;">${patternHTML}</div>`;

        const imgSrc = (typeof digraphWordImages !== 'undefined' && digraphWordImages[word])
          ? digraphWordImages[word]
          : 'https://via.placeholder.com/110?text=?';

        const imageTD = `<td style="padding:5px 7px;width:140px;"><img src="${imgSrc}" alt="${word}" style="width:110px;height:110px;object-fit:contain;"></td>`;

        const borders = !isLast
          ? 'border-bottom:4px solid #000;border-left:4px solid #000;border-right:4px solid #000;'
          : 'border-left:4px solid #000;border-right:4px solid #000;';

        const wordTD = `<td style="padding:5px 7px;${borders}">${wordDisplay}</td>`;

        const hintTD = isFirst
          ? `<td style="padding:3px 5px;width:170px;"></td>`
          : `<td style="padding:3px 5px;width:170px;">
               <div style="display:flex;justify-content:center;align-items:center;background:#f0f0f0;border:3px solid #000;border-radius:12px;padding:6px 10px;font-size:22px;text-align:center;">
                 ${getChunkHint(prevWord, word, prevPattern, pattern)}
               </div>
             </td>`;

        return `<tr>${imageTD}${wordTD}${hintTD}</tr>`;
      }).join('');

      const ladderHTML = `
        <div style="display:flex;flex-direction:column;align-items:center;width:98%;margin:0 auto;">
          <div style="text-align:center;margin-bottom:4px;">
            <h2 style="margin-bottom:1px;font-size:24px;">Digraph Word Ladder${mode==='with' ? ' — Include Blends' : mode==='only' ? ' — Only Blends' : ''}</h2>
            <p style="margin-top:0;font-size:12px;"><strong>Directions:</strong> Start at the top of the ladder and spell the correct words.</p>
          </div>
          <table style="border-collapse:collapse;margin:0 auto;width:100%;max-width:600px;">
            ${rowsHTML}
          </table>
          <br><br>
          <div id="copyright">Copyright - InterventionStation.com - @TeachwithMrC</div>
        </div>
      `;
      document.getElementById('ladderOutput').innerHTML = ladderHTML;
    }
  </script>
</body>
</html>
