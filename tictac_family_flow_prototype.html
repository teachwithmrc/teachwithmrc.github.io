<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Phonics Tic-Tac-Toe Builder (2x2 Prototype)</title>

  <script>
    // Same flexible loading style as your working game so data resolves in multiple locations.
    (function loadData() {
      const paths = [
        // Absolute-from-site-root (works on GitHub Pages at root)
        '/ladder/fluencyDataFull_v8-2_clean.js',
        '/ladder/fluencyDataFull_v6.js',
        // Relative-from-current-page (works when page is opened locally/from repo)
        'ladder/fluencyDataFull_v8-2_clean.js',
        'ladder/fluencyDataFull_v6.js',
        // Same-folder fallback
        'fluencyDataFull_v8-2_clean.js',
        'fluencyDataFull_v6.js',
        '/fluencyDataFull_v8-2_clean.js'
      ];
      let i = 0;
      function tryNext() {
        if (i >= paths.length) return;
        const s = document.createElement('script');
        s.src = paths[i++];
        s.onload = () => {
          if (window.fluencyWords || window.fluencySentences || window.fluencyData) {
            window.__fluencyLoaded = true;
            window.__fluencyPath = s.src;
            const el = document.getElementById('dataStatus');
            if (el) el.textContent = `Data loaded: ${window.__fluencyPath}`;
          } else {
            tryNext();
          }
        };
        s.onerror = () => {
          const el = document.getElementById('dataStatus');
          if (el) el.textContent = `Trying data path: ${paths[i] || 'none left'}`;
          tryNext();
        };
        document.head.appendChild(s);
      }
      tryNext();
    })();
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg1: #edf7ff;
      --bg2: #f4fff1;
      --ink: #233746;
      --card: #ffffff;
      --line: #d7e6f4;
      --x: #e53935;
      --o: #1e88e5;
      --win: #43a047;
      --pill: #eef5ff;
      --accent: #1976d2;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 22px;
      font-family: 'Poppins', sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 9% 11%, #fff 0 8%, transparent 9%),
        radial-gradient(circle at 88% 17%, #fff 0 6%, transparent 7%),
        linear-gradient(140deg, var(--bg1), var(--bg2));
    }

    .app { max-width: 1140px; margin: 0 auto; }
    h1 { text-align: center; margin: 0 0 6px; font-size: 34px; }
    .sub { text-align: center; margin: 0 0 14px; color: #476074; }
    .data-status {
      text-align: center;
      margin: 0 0 10px;
      font-size: 12px;
      color: #3f5c73;
      font-weight: 600;
    }

    .panel {
      background: var(--card);
      border: 2px solid #000;
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 8px 20px rgba(31, 59, 84, 0.09);
    }

    .grid-2x2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items: stretch;
    }

    .cell-card {
      border: 2px solid #000;
      border-radius: 12px;
      padding: 10px;
      background: #fff;
      min-height: 160px;
    }
    .cell-card.compact {
      min-height: 112px;
      padding: 8px;
    }

    .cell-title {
      margin: 0 0 8px;
      text-align: center;
      font-size: 18px;
      font-weight: 700;
    }
    .cell-card.compact .cell-title {
      font-size: 15px;
      margin-bottom: 6px;
    }

    .family-picker {
      display: grid;
      grid-template-columns: repeat(2, minmax(140px, 1fr));
      gap: 8px;
    }

    .family-btn {
      border: 2px solid #000;
      border-radius: 10px;
      background: #fff;
      padding: 10px;
      font-size: 15px;
      font-weight: 700;
      text-align: left;
      cursor: pointer;
      line-height: 1.2;
    }

    .family-btn small {
      display: block;
      font-weight: 600;
      font-size: 11px;
      opacity: 0.8;
      margin-top: 4px;
    }

    .selected-family {
      border: 2px solid #000;
      border-radius: 12px;
      padding: 12px;
      text-align: left;
      background: #eef6ff;
    }

    .selected-family .name {
      font-size: 21px;
      font-weight: 700;
      line-height: 1.15;
      margin-bottom: 4px;
    }

    .selected-family .hint {
      font-size: 13px;
      color: #3f566a;
      margin-bottom: 8px;
    }

    .btn-small {
      border: 2px solid #000;
      background: #fff;
      border-radius: 9px;
      padding: 6px 10px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
    }

    .skills-wrap {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      min-height: 40px;
    }

    .skill-btn {
      border: 2px solid #000;
      border-radius: 999px;
      background: #fff;
      padding: 8px 12px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
    }

    .skill-btn.active {
      background: var(--accent);
      color: #fff;
      border-color: #125ea8;
    }

    .choice-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .option-btn {
      border: 2px solid #000;
      border-radius: 10px;
      background: #fff;
      padding: 10px;
      text-align: center;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
    }
    .cell-card.compact .option-btn {
      padding: 7px;
      font-size: 13px;
      border-radius: 8px;
    }

    .option-btn.active { background: #d2efff; }

    .summary {
      margin-top: 10px;
      border: 2px dashed #58718a;
      border-radius: 12px;
      padding: 10px;
      background: #f8fbff;
      font-size: 15px;
      line-height: 1.35;
      min-height: 62px;
    }

    .controls {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      border: 2px solid #000;
      border-radius: 10px;
      background: #fff;
      padding: 10px 14px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
    }

    .btn.play {
      background: linear-gradient(135deg, #ff9f1c, #ff6b6b);
      color: #fff;
      border: none;
      padding: 11px 16px;
    }

    .game-card {
      margin-top: 12px;
      background: var(--card);
      border: 2px solid #000;
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 8px 20px rgba(31, 59, 84, 0.09);
    }

    .game-title { text-align: center; font-size: 25px; font-weight: 700; margin-bottom: 8px; }

    .meta {
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .pill {
      background: var(--pill);
      border-radius: 999px;
      padding: 5px 10px;
      font-weight: 700;
    }

    .x { color: var(--x); }
    .o { color: var(--o); }

    .board {
      width: min(640px, 100%);
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .square {
      border: none;
      border-radius: 12px;
      background: linear-gradient(180deg, #f8fbff, #edf5ff);
      box-shadow: inset 0 0 0 3px var(--line);
      min-height: 162px;
      padding: 8px;
      display: grid;
      grid-template-rows: 1fr auto;
      align-items: center;
      cursor: pointer;
    }

    .square:disabled { cursor: not-allowed; opacity: 0.88; }
    .square.win { outline: 5px solid var(--win); }

    .prompt {
      text-align: center;
      font-weight: 700;
      font-size: 26px;
      line-height: 1.06;
      word-break: break-word;
    }

    .prompt.sentence { font-size: 21px; line-height: 1.14; }
    .prompt.sentence.long { font-size: 19px; line-height: 1.12; }
    .prompt.sentence.very-long { font-size: 17px; line-height: 1.08; }

    .mark {
      text-align: center;
      height: 56px;
      line-height: 56px;
      font-size: 52px;
      font-weight: 700;
    }

    .empty {
      border: 2px dashed #8ba1b8;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      color: #486277;
      font-weight: 600;
      min-height: 220px;
      display: grid;
      place-items: center;
      background: #fbfdff;
    }

    @media (max-width: 1040px) {
      .family-picker { grid-template-columns: 1fr; }
      .square { min-height: 130px; }
      .prompt { font-size: 20px; }
      .prompt.sentence { font-size: 17px; }
      .prompt.sentence.long { font-size: 15px; }
      .prompt.sentence.very-long { font-size: 14px; }
    }

    @media (max-width: 860px) {
      .grid-2x2 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Tic-Tac-Toe Game Builder</h1>
    <p class="sub">Pick a family, pick exact skills, then press Play.</p>
    <div id="dataStatus" class="data-status">Loading fluency data...</div>

    <div class="panel">
      <div class="grid-2x2">
        <section class="cell-card">
          <h2 class="cell-title">Skill Family</h2>
          <div id="familyStage"></div>
        </section>

        <section class="cell-card">
          <h2 class="cell-title">Select Skills</h2>
          <div id="skillsWrap" class="skills-wrap">Choose a skill family first.</div>
        </section>

        <section class="cell-card compact">
          <h2 class="cell-title">Blends</h2>
          <div id="blendRow" class="choice-row">
            <button class="option-btn active" data-blends="no">No (3 sounds)</button>
            <button class="option-btn" data-blends="yes">Yes (4+ sounds)</button>
          </div>
        </section>

        <section class="cell-card compact">
          <h2 class="cell-title">Content Type</h2>
          <div id="modeRow" class="choice-row">
            <button class="option-btn active" data-mode="words">Words</button>
            <button class="option-btn" data-mode="sentences">Sentences</button>
            <button class="option-btn" data-mode="both" style="grid-column: span 2;">Words + Sentences</button>
          </div>
        </section>
      </div>

      <div id="summary" class="summary">Choose a skill family to begin.</div>

      <div class="controls">
        <button id="playBtn" class="btn play">Play</button>
        <button id="newWordsBtn" class="btn">New Words</button>
        <button id="resetScoreBtn" class="btn">Reset Score</button>
      </div>
    </div>

    <div class="game-card">
      <div class="game-title">Phonics Tic-Tac-Toe</div>
      <div id="meta" class="meta"></div>
      <div id="gameArea" class="empty">Press <strong>Play</strong> after choosing skills.</div>
    </div>
  </div>

  <script>
    const FAMILY_MAP = {
      "CVC Short Vowels": {
        tone: '#1976d2', hint: 'Short vowel practice',
        skills: ["Short A", "Short E", "Short I", "Short O", "Short U", "Mixed CVC", "FLSZ"]
      },
      "Digraphs": {
        tone: '#8e24aa', hint: '2-letter sounds',
        skills: ["ck", "sh", "th", "ch", "wh", "Digraphs Mixed"]
      },
      "Glued Sounds": {
        tone: '#2e7d32', hint: '-all, -ng, -nk',
        skills: ["-all", "-ng", "-nk", "Glued Mixed"]
      },
      "Silent E (VCe)": {
        tone: '#ef6c00', hint: 'a_e, i_e, o_e, u_e',
        skills: ["a_e", "i_e", "o_e", "u_e", "Mixed VCe"]
      },
      "R-Controlled": {
        tone: '#3f51b5', hint: 'ar, or, er/ir/ur',
        skills: ["ar", "or", "er/ir/ur", "Mixed R-Controlled"]
      },
      "Vowel Teams": {
        tone: '#d81b60', hint: 'ai/ay, ee/ea, ...',
        skills: ["Long A (ai/ay)", "Long E (ee/ea)", "Long I (igh/y/ie)", "Long O (oa/ow/oe)", "Long U (oo/ew/ue)", "Mixed Vowel Teams"]
      },
      "Diphthongs": {
        tone: '#00897b', hint: 'oy/oi, ow/ou',
        skills: ["Diphthongs (oy/oi)", "Diphthongs (ow/ou)"]
      },
      "Variant Vowels": {
        tone: '#f9a825', hint: 'au/aw, oo variant',
        skills: ["Variant Vowels (au/aw)", "Variant Vowel (oo)"]
      },
      "Soft C/G Endings": {
        tone: '#455a64', hint: '-ce, -ge, -dge',
        skills: ["Soft C (-ce)", "Soft G (-ge)", "Soft G (-dge)"]
      }
    };

    const PREFIX = {
      "Short A": "0.1 - Short A", "Short O": "0.2 - Short O", "Short I": "0.3 - Short I", "Short U": "0.4 - Short U", "Short E": "0.5 - Short E", "FLSZ": "0.6 - FLSZ",
      "ck": "1.1 - ck", "sh": "1.2 - sh", "th": "1.3 - th", "ch": "1.4 - ch", "wh": "1.5 - wh",
      "-all": "3.1 - all", "-ng": "3.2 - ng", "-nk": "3.3 - nk",
      "a_e": "2.1 - a_e", "i_e": "2.2 - i_e", "o_e": "2.3 - o_e", "u_e": "2.4 - u_e",
      "ar": "4.1 - ar", "or": "4.2 - or", "er/ir/ur": "4.3 - er, ir, ur",
      "Soft C (-ce)": "10.1 - ce", "Soft G (-ge)": "10.2 - ge", "Soft G (-dge)": "10.3 - dge"
    };

    const MIXED_RULES = {
      "Mixed CVC": ["0.1 - Short A", "0.5 - Short E", "0.3 - Short I", "0.2 - Short O", "0.4 - Short U", "0.6 - FLSZ"],
      "Digraphs Mixed": ["1.1 - ck", "1.2 - sh", "1.3 - th", "1.4 - ch", "1.5 - wh"],
      "Glued Mixed": ["3.1 - all", "3.2 - ng", "3.3 - nk"],
      "Mixed VCe": ["2.1 - a_e", "2.2 - i_e", "2.3 - o_e", "2.4 - u_e"],
      "Mixed R-Controlled": ["4.1 - ar", "4.2 - or", "4.3 - er, ir, ur"],
      "Long A (ai/ay)": ["6.1 - ay", "6.2 - ai"],
      "Long E (ee/ea)": ["6.4 - ee", "6.5 - ea"],
      "Long I (igh/y/ie)": ["6.6 - igh", "6.7 - Final y", "6.8 - ie"],
      "Long O (oa/ow/oe)": ["6.9 - oa", "6.10 - ow", "6.11 - oe"],
      "Long U (oo/ew/ue)": ["6.12 - oo (long u)", "6.13 - ew", "6.14 - ue"],
      "Mixed Vowel Teams": ["6.1 - ay", "6.2 - ai", "6.4 - ee", "6.5 - ea", "6.6 - igh", "6.7 - Final y", "6.8 - ie", "6.9 - oa", "6.10 - ow", "6.11 - oe", "6.12 - oo (long u)", "6.13 - ew", "6.14 - ue"],
      "Diphthongs (oy/oi)": ["7.4 - oy", "7.3 - oi"],
      "Diphthongs (ow/ou)": ["7.2 - ow", "7.1 - ou"],
      "Variant Vowels (au/aw)": ["7.5 - aw", "7.6 - au"],
      "Variant Vowel (oo)": ["7.7 - oo variant"]
    };

    const LINES = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];

    let activeFamily = null;
    const selectedSkills = new Set();
    let includeBlends = false;
    let mode = 'words';

    const game = {
      prompts: [],
      marks: Array(9).fill(''),
      turn: 'X',
      over: false,
      winLine: [],
      score: { X: 0, O: 0, T: 0 }
    };

    function wordsDict() { return (typeof fluencyWords !== 'undefined') ? fluencyWords : (window.fluencyData?.words || {}); }
    function sentsDict() { return (typeof fluencySentences !== 'undefined') ? fluencySentences : (window.fluencyData?.sentences || {}); }
    function readDict(dict, key) { return Array.isArray(dict[key]) ? dict[key] : []; }

    function shuffle(arr) {
      const a = Array.isArray(arr) ? arr.slice() : [];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function uniqueByLowercase(list) {
      const seen = new Set();
      const out = [];
      for (const item of (list || [])) {
        const v = String(item).trim();
        const k = v.toLowerCase();
        if (v && !seen.has(k)) {
          seen.add(k);
          out.push(v);
        }
      }
      return out;
    }

    function fillToN(list, n) {
      if (!list.length || n <= 0) return [];
      const out = [];
      let bag = shuffle(list);
      while (out.length < n) {
        if (!bag.length) bag = shuffle(list);
        out.push(bag.shift());
      }
      return out.slice(0, n);
    }

    function readWithBlends(dict, prefix, type, blends) {
      const tl = type.toLowerCase();
      let base = [];
      [ `${prefix} ${type}`, `${prefix} ${tl}`, `${prefix}` ].forEach(k => base = base.concat(readDict(dict, k)));

      if (blends) {
        const bPrefix = prefix.replace(' - ', 'b - ');
        const candidates = [
          `${prefix} with Blends ${type}`, `${prefix} with blends ${type}`,
          `${prefix} with Blends ${tl}`, `${prefix} with blends ${tl}`,
          `${prefix} with BLENDS ${type}`,
          `${bPrefix} with Blends ${type}`, `${bPrefix} with blends ${type}`,
          `${bPrefix} with Blends ${tl}`, `${bPrefix} with blends ${tl}`
        ];
        for (const k of candidates) {
          const got = readDict(dict, k);
          if (got.length) return got.length < 9 ? uniqueByLowercase(got.concat(base)) : got;
        }
      }

      return base;
    }

    function getList(label, type, blends) {
      const dict = type === 'Words' ? wordsDict() : sentsDict();

      if (Object.prototype.hasOwnProperty.call(MIXED_RULES, label)) {
        let all = [];
        for (const p of MIXED_RULES[label]) all = all.concat(readWithBlends(dict, p, type, blends));
        return all;
      }

      const prefix = PREFIX[label];
      if (prefix) return readWithBlends(dict, prefix, type, blends);

      const want = label.toLowerCase();
      const t1 = ' ' + type;
      const t2 = ' ' + type.toLowerCase();
      const guess = Object.keys(dict).find(k => k.toLowerCase().includes(want) && (k.endsWith(t1) || k.endsWith(t2)));
      return guess ? readDict(dict, guess) : [];
    }

    function winningLine(marks) {
      return LINES.find(([a,b,c]) => marks[a] && marks[a] === marks[b] && marks[b] === marks[c]) || null;
    }

    function renderFamilyStage() {
      const host = document.getElementById('familyStage');

      if (!activeFamily) {
        const picker = document.createElement('div');
        picker.className = 'family-picker';

        Object.entries(FAMILY_MAP).forEach(([name, cfg]) => {
          const btn = document.createElement('button');
          btn.className = 'family-btn';
          btn.style.borderColor = cfg.tone;
          btn.innerHTML = `${name}<small>${cfg.hint}</small>`;
          btn.addEventListener('click', () => {
            activeFamily = name;
            selectedSkills.clear();
            renderFamilyStage();
            renderSkills();
            renderSummary();
          });
          picker.appendChild(btn);
        });

        host.innerHTML = '';
        host.appendChild(picker);
        return;
      }

      const cfg = FAMILY_MAP[activeFamily];
      host.innerHTML = `
        <div class="selected-family" style="border-color:${cfg.tone}; background:${cfg.tone}1A;">
          <div class="name">${activeFamily}</div>
          <div class="hint">${cfg.hint}</div>
          <button id="changeFamilyBtn" class="btn-small">Change Skill Family</button>
        </div>
      `;

      document.getElementById('changeFamilyBtn').addEventListener('click', () => {
        activeFamily = null;
        selectedSkills.clear();
        renderFamilyStage();
        renderSkills();
        renderSummary();
      });
    }

    function renderSkills() {
      const wrap = document.getElementById('skillsWrap');
      wrap.innerHTML = '';

      if (!activeFamily) {
        wrap.textContent = 'Choose a skill family first.';
        return;
      }

      FAMILY_MAP[activeFamily].skills.forEach(skill => {
        const btn = document.createElement('button');
        btn.className = 'skill-btn' + (selectedSkills.has(skill) ? ' active' : '');
        btn.textContent = skill;
        btn.addEventListener('click', () => {
          if (selectedSkills.has(skill)) selectedSkills.delete(skill);
          else selectedSkills.add(skill);
          renderSkills();
          renderSummary();
        });
        wrap.appendChild(btn);
      });
    }

    function renderSummary() {
      const box = document.getElementById('summary');

      if (!activeFamily) {
        box.textContent = 'Choose a skill family to begin.';
        return;
      }

      const skills = Array.from(selectedSkills);
      const blendText = includeBlends ? 'with blends' : 'without blends';
      const modeText = mode === 'both' ? 'words + sentences' : mode;

      if (!skills.length) {
        box.innerHTML = `You selected <strong>${activeFamily}</strong>. Now pick one or more exact skills on the top right.`;
        return;
      }

      box.innerHTML = `Hit Play: Your game will include <strong>${activeFamily}</strong> - <strong>${skills.join(', ')}</strong>, <strong>${blendText}</strong>, using <strong>${modeText}</strong>.`;
    }

    function renderMeta() {
      const meta = document.getElementById('meta');
      const skills = Array.from(selectedSkills);
      meta.innerHTML = `
        <div class="pill">Turn: <span class="${game.turn === 'X' ? 'x' : 'o'}">${game.turn}</span></div>
        <div class="pill">Skills: ${skills.length ? skills.join(' • ') : '—'}</div>
        <div class="pill">X Wins: <span class="x">${game.score.X}</span></div>
        <div class="pill">O Wins: <span class="o">${game.score.O}</span></div>
        <div class="pill">Ties: ${game.score.T}</div>
      `;
    }

    function renderGameArea() {
      const area = document.getElementById('gameArea');
      if (!area) return;

      if (!game.prompts.length) {
        area.className = 'empty';
        area.innerHTML = 'Press <strong>Play</strong> after choosing skills.';
        return;
      }

      area.className = 'board';
      area.innerHTML = '';

      game.prompts.forEach((text, idx) => {
        const mark = game.marks[idx] || '';
        const isSentence = String(text).includes(' ');
        const sentenceClass = isSentence
          ? (String(text).length > 42 ? ' very-long' : String(text).length > 28 ? ' long' : '')
          : '';

        const btn = document.createElement('button');
        btn.className = 'square' + (game.winLine.includes(idx) ? ' win' : '');
        btn.disabled = !!mark || game.over;
        btn.innerHTML = `<div class="prompt ${isSentence ? 'sentence' : ''}${sentenceClass}">${text}</div><div class="mark ${mark === 'X' ? 'x' : mark === 'O' ? 'o' : ''}">${mark}</div>`;
        btn.addEventListener('click', () => makeMove(idx));
        area.appendChild(btn);
      });
      renderMeta();
    }

    function makeMove(idx) {
      if (game.over || game.marks[idx]) return;
      game.marks[idx] = game.turn;

      const line = winningLine(game.marks);
      if (line) {
        game.over = true;
        game.winLine = line;
        game.score[game.turn] += 1;
      } else if (game.marks.every(Boolean)) {
        game.over = true;
        game.score.T += 1;
      } else {
        game.turn = game.turn === 'X' ? 'O' : 'X';
      }

      renderGameArea();
    }

    function buildPrompts(skills) {
      const total = 9;

      if (mode === 'words') {
        const pool = uniqueByLowercase(skills.flatMap(s => getList(s, 'Words', includeBlends)));
        if (!pool.length) {
          const fallback = uniqueByLowercase(skills.flatMap(s => getList(s, 'Sentences', includeBlends)));
          return fillToN(shuffle(fallback), total);
        }
        return fillToN(shuffle(pool), total);
      }

      if (mode === 'sentences') {
        const pool = uniqueByLowercase(skills.flatMap(s => getList(s, 'Sentences', includeBlends)));
        if (!pool.length) {
          const fallback = uniqueByLowercase(skills.flatMap(s => getList(s, 'Words', includeBlends)));
          return fillToN(shuffle(fallback), total);
        }
        return fillToN(shuffle(pool), total);
      }

      const words = uniqueByLowercase(skills.flatMap(s => getList(s, 'Words', includeBlends)));
      const sents = uniqueByLowercase(skills.flatMap(s => getList(s, 'Sentences', includeBlends)));

      if (!words.length && !sents.length) return [];
      if (!words.length) return fillToN(shuffle(sents), total);
      if (!sents.length) return fillToN(shuffle(words), total);

      const w = fillToN(shuffle(words), 5);
      const s = fillToN(shuffle(sents), 4);
      return shuffle(w.concat(s));
    }

    function dataLoaded() {
      return !!(window.fluencyWords || window.fluencySentences || window.fluencyData);
    }

    function playGame(useNewWords) {
      if (!dataLoaded()) {
        const msg = window.__fluencyLoaded
          ? 'Fluency script loaded, but no usable data object was found.'
          : 'Fluency data is not loaded yet. Wait 1-2 seconds and try again, or refresh.';
        return alert(msg);
      }
      if (!activeFamily) return alert('Pick a skill family first.');

      const skills = Array.from(selectedSkills);
      if (!skills.length) return alert('Pick at least one exact skill on the top right.');

      if (useNewWords || !game.prompts.length) {
        const prompts = buildPrompts(skills);
        if (prompts.length < 9) {
          return alert('Not enough content found from the JS data for those settings.');
        }
        game.prompts = prompts;
      }

      game.marks = Array(9).fill('');
      game.turn = 'X';
      game.over = false;
      game.winLine = [];

      renderMeta();
      renderGameArea();
      document.querySelector('.game-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    document.querySelectorAll('#blendRow .option-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#blendRow .option-btn').forEach(x => x.classList.remove('active'));
        btn.classList.add('active');
        includeBlends = btn.dataset.blends === 'yes';
        renderSummary();
      });
    });

    document.querySelectorAll('#modeRow .option-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#modeRow .option-btn').forEach(x => x.classList.remove('active'));
        btn.classList.add('active');
        mode = btn.dataset.mode;
        renderSummary();
      });
    });

    document.getElementById('playBtn').addEventListener('click', () => playGame(true));
    document.getElementById('newWordsBtn').addEventListener('click', () => playGame(true));
    document.getElementById('resetScoreBtn').addEventListener('click', () => {
      game.score = { X: 0, O: 0, T: 0 };
      renderMeta();
    });

    renderFamilyStage();
    renderSkills();
    renderSummary();
    renderMeta();
  </script>
</body>
</html>
