<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Word Mapping Generator</title>
  <script src="newtry_FULL.js" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --cvc:#e9f2ff;          --cvc-selected:#1976d2;
      --dig:#f3e9ff;          --dig-selected:#8e24aa;
      --glued:#e8fff4;        --glued-selected:#2e7d32;
      --vce:#fff5e6;          --vce-selected:#ef6c00;
      --rctrl:#f0f5ff;        --rctrl-selected:#3f51b5;
      --vteams:#fff0f6;       --vteams-selected:#d81b60;
      --dip:#eefcfb;          --dip-selected:#00897b;
      --variant:#fff8e1;      --variant-selected:#f9a825;
      --soft:#eef4ff;         --soft-selected:#455a64;

      --chip-bg:#f3f6fb; --chip-text:#263238; --chip-x:#546e7a;
    }

    @font-face { font-family:'BoxesFont'; src:url('fonts/boxes2.otf') format('opentype'); }
    @font-face { font-family:'UnderlineFont'; src:url('fonts/underlines.otf') format('opentype'); }

    body { font-family:'Poppins',sans-serif; margin:28px; text-align:center; background:#fafafa; }
    h1 { font-size: 36px; margin-bottom: 6px; }
    .subtitle { color:#555; margin:0 0 14px; }

    /* Overall table layout */
    /* Overall grid layout */
    .layout { width:100%; max-width:1100px; margin:0 auto 14px auto; display:grid; grid-template-columns: minmax(260px,1fr) max-content; grid-template-rows: 1fr 1fr; gap:12px; align-items:stretch; }
    .layout .left { grid-column:1; grid-row:1 / span 2; }
    .layout .right-top { grid-column:2; grid-row:1; }
    .layout .right-bottom { grid-column:2; grid-row:2; }
    /* grid variant: no table cells used */
    /* left placement handled in grid definition above */
    /* right placement handled by .right-top / .right-bottom in grid */

    /* Card containers */
    .table-section { border:2px solid #000; padding:16px; width:100%; box-sizing:border-box; text-align:left; border-radius:12px; background:#fff; height:100%; }
    .section-label { font-weight:700; font-size:20px; margin-bottom:12px; text-align:center; }

    /* Step 1 blocks with headers + arrows both sides */
    .skill-block { border:1px solid #bbb; border-radius:12px; overflow:hidden; margin-bottom:12px; background:#fff; }
    .skill-header {
      display:flex; align-items:center; justify-content:center;
      padding:12px 16px; font-weight:700; font-size:22px; cursor:pointer; user-select:none;
    }
    .skill-header .arrow { font-size:30px; line-height:1; margin:0 14px; width:30px; text-align:center; }
    .skill-header .title { white-space:nowrap; }
    .skills-inner { display:flex; justify-content:center; flex-wrap:wrap; gap:12px; padding:14px; }
    .skills-inner.collapsed { display:none; }

    /* Category backgrounds */
    .bg-cvc   .skill-header { background:var(--cvc); }
    .bg-dig   .skill-header { background:var(--dig); }
    .bg-glued .skill-header { background:var(--glued); }
    .bg-vce   .skill-header { background:var(--vce); }
    .bg-rctrl .skill-header { background:var(--rctrl); }
    .bg-vteams .skill-header{ background:var(--vteams); }
    .bg-dip   .skill-header { background:var(--dip); }
    .bg-variant .skill-header{ background:var(--variant); }
    .bg-soft  .skill-header { background:var(--soft); }

    /* Skill buttons */
    .skill-button{
      border:2px solid #000; padding:10px 16px; border-radius:16px;
      font-weight:700; font-size:16px; cursor:pointer; background:#fff;
      transition:transform .08s ease, background-color .2s ease, color .2s ease, box-shadow .2s ease;
      user-select:none; line-height:1.2; min-height:44px;
    }
    .skill-button:active{ transform:translateY(1px); }

    /* Selected colors by category */
    .skill-button.cvc.selected{ background:var(--cvc-selected); color:#fff; }
    .skill-button.dig.selected{ background:var(--dig-selected); color:#fff; }
    .skill-button.glued.selected{ background:var(--glued-selected); color:#fff; }
    .skill-button.vce.selected{ background:var(--vce-selected); color:#fff; }
    .skill-button.rctrl.selected{ background:var(--rctrl-selected); color:#fff; }
    .skill-button.vteams.selected{ background:var(--vteams-selected); color:#fff; }
    .skill-button.dip.selected{ background:var(--dip-selected); color:#fff; }
    .skill-button.variant.selected{ background:var(--variant-selected); color:#fff; }
    .skill-button.soft.selected{ background:var(--soft-selected); color:#fff; }

    /* Force wrap after Long I in Vowel Teams */
    .skills-inner .break { flex-basis:100%; height:0; }

    /* Chips */
    .chips-title { margin-top:12px; text-align:center; font-weight:700; font-size:16px; }
    .chips-wrap { margin-top:8px; display:flex; justify-content:center; flex-wrap:wrap; gap:8px; }
    .chip {
      background:var(--chip-bg); color:var(--chip-text);
      border:none; border-radius:999px; padding:8px 12px; font-size:14px;
      display:flex; align-items:center; gap:10px; box-shadow:inset 0 0 0 1px rgba(0,0,0,0.06);
    }
    .chip .x {
      width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center;
      font-weight:700; font-size:12px; cursor:pointer; background:#e8edf2; color:var(--chip-x); transition:background .15s;
    }
    .chip .x:hover { background:#dfe7ee; }

    /* Actions */
    .option-grid { display:flex; justify-content:center; flex-wrap:wrap; gap:12px; margin-top:10px; }
    .option-box { padding:12px 16px; border:2px solid #000; border-radius:12px; cursor:pointer; transition: background-color 0.2s, color 0.2s, transform .08s; font-size:16px; font-weight:600; }
    .option-box:active { transform:translateY(1px); }
    .option-box.selected { background-color:#d9c9ff; }

    /* Keep Step 3 visible while scrolling */
    .actions-sticky { position:sticky; top:8px; z-index:50; background:#fff; }

    /* Worksheet Layout */
    .word-table { width:100%; border-collapse:collapse; margin-top:20px; border:2px solid black; }
    .word-table td { width:50%; text-align:center; vertical-align:middle; padding:24px 0; border:2px solid black; }
    .worksheet-title { font-size:40px; margin-bottom:5px; font-weight:700; }
    .worksheet-directions { font-size:22px; margin-bottom:20px; }
    .word { font-size:28px; font-weight:700; margin-bottom:12px; }
    .pattern {
      font-size:60px; transform:scale(1.5); display:inline-block;
      font-family:'BoxesFont', monospace; font-weight:normal; line-height:1;
      margin-top:12px; margin-bottom:16px;
    }
    .pattern.underlines { font-family:'UnderlineFont', monospace; font-weight:normal; letter-spacing:0; }
    .pattern.underlines span { display:inline-block; margin:0 2px; }

    /* Screen preview page sizing so it doesn't stretch full width */
    @media screen {
      #output { display:flex; justify-content:center; padding:16px 0; }
      #output .page {
        width: 8.5in;                 /* match Letter width */
        max-width: calc(100% - 32px); /* keep small margins on tiny screens */
        background:#fff;
        box-shadow: 0 6px 20px rgba(0,0,0,.12);
        padding: 0.5in;               /* nice margins around content */
        border: 2px solid #000;       /* optional: mimic printed border */
        border-radius: 8px;
      }
      #output .worksheet-title,
      #output .worksheet-directions,
      #output .word-table,
      #output #copyright { max-width: 100%; margin-left:auto; margin-right:auto; }
      #output .word-table { width:100%; }
    }

    /* Keep print perfect (remove preview decorations) */
    @media print {
      #output .page { width:auto; padding:0; box-shadow:none; border:none; }
    }

    /* Hide individual Soft C / Soft G buttons, keep Soft Endings */
    .skill-button[data-skill="Soft C"], .skill-button[data-skill="Soft G"] { display:none; }

    /* Print */
    #copyright { font-size:12px; text-align:right; margin-top:12px; display:none; }
    @media print {
      body { margin:0; }
      .table-section, button, .chips-title, .chips-wrap, .subtitle, .layout { display:none !important; }
      #output { margin:0; }
      .worksheet-title { font-size:20px; margin-bottom:2px; }
      .worksheet-directions { font-size:14px; margin-bottom:8px; }
      #copyright { display:block; }
      #floatingActions { display:none !important; }
    }

    /* Mobile */
    @media (max-width: 900px) {
      .layout { display:block; border-spacing:0; }
      .layout .left, .layout .right { width:100%; }
      .skill-header .title { font-size:22px; }
      .skill-header .arrow { font-size:30px; }
      .skill-button { padding:14px 22px; font-size:20px; min-height:56px; }
      .chips-title { font-size:18px; }
      .chip { font-size:16px; padding:10px 14px; }
      .option-box { font-size:18px; padding:14px 18px; }
      .actions-sticky { position:static; }
    }

    /* Compact Desktop */
    @media (min-width: 992px) {
      h1 { font-size: 22px; margin-bottom: 2px; }
      .table-section { padding:12px; }
      .section-label { font-size:16px; margin-bottom:8px; }
      .skill-block { margin-bottom:8px; border-radius:10px; }
      .skill-header { padding:8px 10px; font-size:16px; }
      .skill-header .arrow { font-size:18px; margin:0 8px; width:18px; }
      .skills-inner { padding:8px; gap:8px; }
      .skill-button { padding:6px 10px; font-size:14px; min-height:34px; border-radius:10px; }
      .chips-title { font-size:14px; margin-top:8px; }
      .chip { padding:6px 10px; font-size:12px; gap:8px; }
      .chip .x { width:16px; height:16px; font-size:11px; }
      .option-box { padding:10px 12px; font-size:14px; }
      .worksheet-title { font-size:34px; }
      .worksheet-directions { font-size:18px; }
      .word { font-size:24px; }
      .pattern { font-size:52px; margin-top:10px; margin-bottom:14px; }
      .pattern.underlines span { margin:0 1.5px; }
    }
  </style>
</head>
<body>
  <h1>Word Mapping Generator</h1>
  <div class="subtitle">Build targeted sound-mapping worksheets in one click.</div>

  <!-- 2x2 TABLE LAYOUT: Step 1 left (spans rows), Step 2 top-right, Step 3 bottom-right -->
  <div class="layout">
    <div class="left">
      <!-- STEP 1 -->
      <div id="step1" class="table-section">
        <div class="section-label">Step 1: Select Skills</div>
        
        <div class="skill-block bg-cvc">
          <div class="skill-header" data-target="cvc">
            <span class="arrow">▲</span>
            <span class="title">CVC Short Vowels</span>
            <span class="arrow">▲</span>
          </div>
          <div class="skills-inner" id="section-cvc">
            <button class="skill-button cvc" data-skill="Short A">Short A</button>
            <button class="skill-button cvc" data-skill="Short E">Short E</button>
            <button class="skill-button cvc" data-skill="Short I">Short I</button>
            <button class="skill-button cvc" data-skill="Short O">Short O</button>
            <button class="skill-button cvc" data-skill="Short U">Short U</button>
            <button class="skill-button cvc" data-skill="Mixed CVC">Mixed CVC</button>
            <button class="skill-button cvc" data-skill="FLSZ Words">FLSZ</button>
          </div>
        </div>

        <div class="skill-block bg-dig">
          <div class="skill-header" data-target="dig">
            <span class="arrow">▼</span>
            <span class="title">Digraphs</span>
            <span class="arrow">▼</span>
          </div>
          <div class="skills-inner collapsed" id="section-dig">
            <button class="skill-button dig" data-skill="Digraph(ck)">ck</button>
            <button class="skill-button dig" data-skill="Digraph(sh)">sh</button>
            <button class="skill-button dig" data-skill="Digraph(th)">th</button>
            <button class="skill-button dig" data-skill="Digraph(ch)">ch</button>
            <button class="skill-button dig" data-skill="Digraph(wh)">wh</button>
            <button class="skill-button dig" data-skill="Digraphs Mixed">Digraphs Mixed</button>
          </div>
        </div>

        <div class="skill-block bg-glued">
          <div class="skill-header" data-target="glued">
            <span class="arrow">▼</span>
            <span class="title">Glued Sounds</span>
            <span class="arrow">▼</span>
          </div>
          <div class="skills-inner collapsed" id="section-glued">
            <button class="skill-button glued" data-skill="Glued(all)">-all</button>
            <button class="skill-button glued" data-skill="Glued(-ng)">-ng</button>
            <button class="skill-button glued" data-skill="Glued(-nk)">-nk</button>
            <button class="skill-button glued" data-skill="Glued Mixed">Glued Mixed</button>
          </div>
        </div>

        <div class="skill-block bg-vce">
          <div class="skill-header" data-target="vce">
            <span class="arrow">▼</span>
            <span class="title">Silent E (VCe)</span>
            <span class="arrow">▼</span>
          </div>
          <div class="skills-inner collapsed" id="section-vce">
            <button class="skill-button vce" data-skill="VCe(a_e)">a_e</button>
            <button class="skill-button vce" data-skill="VCe(i_e)">i_e</button>
            <button class="skill-button vce" data-skill="VCe(o_e)">o_e</button>
            <button class="skill-button vce" data-skill="VCe(u_e)">u_e</button>
            <button class="skill-button vce" data-skill="Mixed VCe">Mixed VCe</button>
          </div>
        </div>

        <div class="skill-block bg-rctrl">
          <div class="skill-header" data-target="rctrl">
            <span class="arrow">▼</span>
            <span class="title">R-Controlled</span>
            <span class="arrow">▼</span>
          </div>
          <div class="skills-inner collapsed" id="section-rctrl">
            <button class="skill-button rctrl" data-skill="R-Controlled(ar)">ar</button>
            <button class="skill-button rctrl" data-skill="R-Controlled(or)">or</button>
            <button class="skill-button rctrl" data-skill="R-Controlled(er,ir,ur)">er/ir/ur</button>
            <button class="skill-button rctrl" data-skill="Mixed R-Controlled">Mixed R-Controlled</button>
          </div>
        </div>

        <div class="skill-block bg-vteams">
          <div class="skill-header" data-target="vteams">
            <span class="arrow">▼</span>
            <span class="title">Vowel Teams</span>
            <span class="arrow">▼</span>
          </div>
          <div class="skills-inner collapsed" id="section-vteams">
            <button class="skill-button vteams" data-skill="Long A (ai/ay)">Long A (ai/ay)</button>
            <button class="skill-button vteams" data-skill="Long E (ee/ea)">Long E (ee/ea)</button>
            <button class="skill-button vteams" data-skill="Long I (igh/y/ie)">Long I (igh/y/ie)</button>
            <span class="break"></span>
            <button class="skill-button vteams" data-skill="Long O (oa/ow/oe)">Long O (oa/ow/oe)</button>
            <button class="skill-button vteams" data-skill="Long U (oo/ew/ue)">Long U (oo/ew/ue)</button>
            <button class="skill-button vteams" data-skill="Mixed Vowel Teams">Mixed Vowel Teams</button>
          </div>
        </div>

        <div class="skill-block bg-dip">
          <div class="skill-header" data-target="dip">
            <span class="arrow">▼</span>
            <span class="title">Diphthongs</span>
            <span class="arrow">▼</span>
          </div>
          <div class="skills-inner collapsed" id="section-dip">
            <button class="skill-button dip" data-skill="Diphthongs (oy/oi)">oy/oi</button>
            <button class="skill-button dip" data-skill="Diphthongs (ow/ou)">ow/ou</button>
          </div>
        </div>

        <div class="skill-block bg-variant">
          <div class="skill-header" data-target="variant">
            <span class="arrow">▼</span>
            <span class="title">Variant Vowels</span>
            <span class="arrow">▼</span>
          </div>
          <div class="skills-inner collapsed" id="section-variant">
            <button class="skill-button variant" data-skill="Variant Vowels (au/aw)">au/aw</button>
            <button class="skill-button variant" data-skill="Variant Vowel (oo)">oo</button>
          </div>
        </div>

        <div class="skill-block bg-soft">
          <div class="skill-header" data-target="soft">
            <span class="arrow">▼</span>
            <span class="title">Soft C/G Endings</span>
            <span class="arrow">▼</span>
          </div>
          <div class="skills-inner collapsed" id="section-soft">
            <button class="skill-button soft" data-skill="Soft Endings">Soft C/G Endings (-ce/-ge/-dge)</button>
          </div>
        </div>
      </div>
    </div>

    <div class="right-top">
      <!-- STEP 2 -->
      <div class="table-section tight">
        <div class="section-label">Step 2: Include Blends?</div>
        <div class="option-grid">
          <div class="option-box" id="includeBlendsYes">Yes (4+ sounds)</div>
          <div class="option-box" id="includeBlendsNo">No (3 sounds)</div>
        </div>
      </div>
    </div>

    <div class="right-bottom">
      <!-- STEP 3 -->
      <div class="table-section actions-sticky tight">
        <div class="section-label">Step 3: Generate & Print</div>
        <div style="margin:6px 0 12px; text-align:center;">
          <label style="margin-right:12px; font-size:16px;"><input type="radio" name="cellStyle" value="boxes" checked> Elkonin Boxes</label>
          <label style="font-size:16px;"><input type="radio" name="cellStyle" value="underlines"> Underlines</label>
        </div>

        <div class="chips-title">Skills Selected:</div>
        <div id="chips" class="chips-wrap"></div>

        <div style="text-align:center; margin-top:10px;">
          <button id="btnGenerate" style="font-size: 18px; padding: 10px 24px;">Generate</button>
          <button onclick="window.print()" style="font-size: 18px; padding: 10px 24px;">Print</button>
        </div>
      </div>
    </div>
  </div>

  <!-- OUTPUT -->
  <div id="output"></div>

  <!-- Desktop-only floating actions -->
  <div id="floatingActions" style="
    position: fixed; right: 16px; bottom: 16px; z-index: 1000;
    background:#ffffff; border:2px solid #000; border-radius:12px;
    box-shadow: 0 6px 20px rgba(0,0,0,.15); padding:10px 12px;
    display:none; gap:8px; align-items:center;">
    <button id="fabGenerate" style="font-size:14px; padding:8px 12px;">Generate</button>
    <button id="fabPrint" style="font-size:14px; padding:8px 12px;">Print</button>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // CSS.escape polyfill
  if (typeof CSS === 'undefined' || typeof CSS.escape !== 'function') {
    window.CSS = window.CSS || {};
    CSS.escape = CSS.escape || function(sel){ return (sel+'').replace(/[^a-zA-Z0-9_-]/g,'\\\\$&'); };
  }

  let selectedSkills = new Set();
  let includeBlends = null;

  // Toggle headers (▼ closed, ▲ open)
  document.querySelectorAll('.skill-header').forEach(header => {
    header.addEventListener('click', () => {
      const target = header.getAttribute('data-target');
      const inner = document.getElementById('section-' + target);
      const arrows = header.querySelectorAll('.arrow');
      const isCollapsed = inner.classList.contains('collapsed');
      if (isCollapsed) {
        inner.classList.remove('collapsed');
        arrows.forEach(a => a.textContent = '▲');
      } else {
        inner.classList.add('collapsed');
        arrows.forEach(a => a.textContent = '▼');
      }
    });
  });

  // Skill button toggle
  document.querySelectorAll('.skill-button').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const skill = btn.dataset.skill;
      if (selectedSkills.has(skill)) {
        selectedSkills.delete(skill);
        btn.classList.remove('selected');
      } else {
        selectedSkills.add(skill);
        btn.classList.add('selected');
      }
      renderChips();
    });
  });

  // Chips UI
  function renderChips(){
    const wrap = document.getElementById('chips');
    if (!wrap) return;
    wrap.innerHTML = '';
    Array.from(selectedSkills).forEach(skill => {
      const chip = document.createElement('div');
      chip.className = 'chip';
      chip.innerHTML = `<span>${skill}</span><span class="x" title="Remove">×</span>`;
      chip.querySelector('.x').addEventListener('click', () => {
        selectedSkills.delete(skill);
        const btn = document.querySelector(`.skill-button[data-skill="${CSS.escape(skill)}"]`);
        if (btn) btn.classList.remove('selected');
        renderChips();
      });
      wrap.appendChild(chip);
    });
  }

  // Include Blends toggles (default No)
  const yes = document.getElementById('includeBlendsYes');
  const no  = document.getElementById('includeBlendsNo');
  includeBlends = false; no.classList.add('selected');
  yes.addEventListener('click', function(){ includeBlends = true; yes.classList.add('selected'); no.classList.remove('selected'); });
  no .addEventListener('click', function(){ includeBlends = false; no.classList.add('selected'); yes.classList.remove('selected'); });

  // Floating action bar (desktop only)
  function toggleFloatingBar(){
    const el = document.getElementById('floatingActions');
    if (!el) return;
    const isDesktop = window.matchMedia('(min-width: 992px)').matches;
    el.style.display = isDesktop ? 'flex' : 'none';
  }
  toggleFloatingBar();
  window.addEventListener('resize', toggleFloatingBar);
  document.getElementById('fabGenerate')?.addEventListener('click', () => {
    document.getElementById('btnGenerate')?.click();
  });
  document.getElementById('fabPrint')?.addEventListener('click', () => window.print());

  // Helpers
  function currentCellFont(){ return (document.querySelector('input[name="cellStyle"]:checked')?.value === 'underlines') ? 'UnderlineFont' : 'BoxesFont'; }
  function currentCellClass(){ return (document.querySelector('input[name="cellStyle"]:checked')?.value === 'underlines') ? 'underlines' : 'boxes'; }
  function renderPatternHTML(pattern, useUnder){ return useUnder ? Array.from(pattern).map(d=>`<span>${d}</span>`).join('') : pattern; }
  function shuffle(arr){ return [...arr].sort(() => Math.random() - 0.5); }

  // ===== Data fetch with -ng / -nk / Mix handling =====
  function getWordsForSkill(skill, source, blends) {
    const blendSuffixes = [" with Blends", " with Digraphs and Blends"];

    function fetchBase(base){
      if (!blends) return source[base] || [];
      let result = [];
      blendSuffixes.forEach(suffix => {
        const key = `${base}${suffix}`;
        if (source[key]) result = result.concat(source[key]);
      });
      return result;
    }

    function dedupe(list){
      const seen = new Set();
      const out = [];
      for (const w of list) {
        const key = (w && w.word && w.pattern) ? `${w.word}|${w.pattern}` : JSON.stringify(w);
        if (!seen.has(key)) { seen.add(key); out.push(w); }
      }
      return out;
    }

    switch (skill) {
      // Short vowels & Mixed CVC
      case "Short A": return fetchBase("Short A");
      case "Short E": return fetchBase("Short E");
      case "Short I": return fetchBase("Short I");
      case "Short O": return fetchBase("Short O");
      case "Short U": return fetchBase("Short U");
      case "Mixed CVC":
        return [].concat(
          fetchBase("Short A"), fetchBase("Short E"), fetchBase("Short I"),
          fetchBase("Short O"), fetchBase("Short U")
        );

      // Digraphs
      case "Digraph(ck)": return fetchBase("Digraph(ck)");
      case "Digraph(sh)": return fetchBase("Digraph(sh)");
      case "Digraph(th)": return fetchBase("Digraph(th)");
      case "Digraph(ch)": return fetchBase("Digraph(ch)");
      case "Digraph(wh)": return fetchBase("Digraph(wh)");
      case "Digraphs Mixed":
        return [].concat(
          fetchBase("Digraph(ck)"), fetchBase("Digraph(sh)"),
          fetchBase("Digraph(th)"), fetchBase("Digraph(ch)"),
          fetchBase("Digraph(wh)")
        );

      // Glued Sounds
      case "Glued(all)": return fetchBase("Glued(all)");
      case "Glued(-ng)":
        return dedupe([].concat(
          fetchBase("Glued(ang)"), fetchBase("Glued(ing)"),
          fetchBase("Glued(ong)"), fetchBase("Glued(ung)")
        ));
      case "Glued(-nk)":
        return dedupe([].concat(
          fetchBase("Glued(ank)"), fetchBase("Glued(ink)"),
          fetchBase("Glued(onk)"), fetchBase("Glued(unk)")
        ));
      case "Glued Mixed":
        return dedupe([].concat(
          fetchBase("Glued(all)"),
          fetchBase("Glued(ang)"), fetchBase("Glued(ing)"),
          fetchBase("Glued(ong)"), fetchBase("Glued(ung)"),
          fetchBase("Glued(ank)"), fetchBase("Glued(ink)"),
          fetchBase("Glued(onk)"), fetchBase("Glued(unk)")
        ));

      // VCe
      case "VCe(a_e)": return fetchBase("VCe(a_e)");
      case "VCe(i_e)": return fetchBase("VCe(i_e)");
      case "VCe(o_e)": return fetchBase("VCe(o_e)");
      case "VCe(u_e)": return fetchBase("VCe(u_e)");
      case "Mixed VCe":
        return [].concat(
          fetchBase("VCe(a_e)"), fetchBase("VCe(i_e)"),
          fetchBase("VCe(o_e)"), fetchBase("VCe(u_e)")
        );

      // R-Controlled
      case "R-Controlled(ar)": return fetchBase("R-Controlled(ar)");
      case "R-Controlled(or)": return fetchBase("R-Controlled(or)");
      case "R-Controlled(er,ir,ur)": return fetchBase("R-Controlled(er,ir,ur)");
      case "Mixed R-Controlled":
        return [].concat(
          fetchBase("R-Controlled(ar)"), fetchBase("R-Controlled(or)"),
          fetchBase("R-Controlled(er,ir,ur)")
        );

      // Vowel Teams
      case "Long A (ai/ay)": return [].concat(fetchBase("Long A(ai)"), fetchBase("Long A(ay)"));
      case "Long E (ee/ea)": return [].concat(fetchBase("Long E(ee)"), fetchBase("Long E(ea)"));
      case "Long I (igh/y/ie)": return [].concat(fetchBase("Long I(igh)"), fetchBase("Long I(y)"), fetchBase("Long I(ie)"));
      case "Long O (oa/ow/oe)": return [].concat(fetchBase("Long O(oa)"), fetchBase("Long O(ow)"), fetchBase("Long O(oe)"));
      case "Long U (oo/ew/ue)": return [].concat(fetchBase("Long U(oo)"), fetchBase("Long U(ew)"), fetchBase("Long U(ue)"));
      case "Mixed Vowel Teams":
        return [].concat(
          fetchBase("Long A(ai)"), fetchBase("Long A(ay)"),
          fetchBase("Long E(ee)"), fetchBase("Long E(ea)"),
          fetchBase("Long I(igh)"), fetchBase("Long I(y)"), fetchBase("Long I(ie)"),
          fetchBase("Long O(oa)"), fetchBase("Long O(ow)"), fetchBase("Long O(oe)"),
          fetchBase("Long U(oo)"), fetchBase("Long U(ew)"), fetchBase("Long U(ue)")
        );

      // Diphthongs
      case "Diphthongs (oy/oi)": return [].concat(fetchBase("Diphthong(oy)"), fetchBase("Diphthong(oi)"));
      case "Diphthongs (ow/ou)": return [].concat(fetchBase("Diphthong(ow)"), fetchBase("Diphthong(ou)"));

      // Variant vowels
      case "Variant Vowels (au/aw)": return [].concat(fetchBase("Variant Vowel(aw)"), fetchBase("Variant Vowel(au)"));
      case "Variant Vowel (oo)": return fetchBase("Variant Vowel(oo)");

      // Soft C/G endings only
      case "Soft Endings":
        return [].concat(fetchBase("Soft C(ce)"), fetchBase("Soft G(ge)"), fetchBase("Soft G(dge)"));

      default: return fetchBase(skill);
    }
  }

  // Generate worksheet
  function generatePage() {
    if (selectedSkills.size === 0) return alert("Select at least one skill!");
    if (includeBlends === null) return alert("Please choose Include Blends: Yes or No");
    if (typeof soundBoxWords === 'undefined') { alert("Missing data: soundBoxWords (check newtry_FULL.js is loaded)."); return; }

    const source = soundBoxWords;
    let allWords = [];
    selectedSkills.forEach(skill => { allWords = allWords.concat(getWordsForSkill(skill, source, includeBlends)); });
    if (allWords.length === 0) return alert("No words found for the selected skills.");

    while (allWords.length < 8) allWords = allWords.concat(allWords);
    allWords = shuffle(allWords).slice(0,8);

    const output = document.getElementById('output');
    output.innerHTML = '';

    const page = document.createElement('div');
    page.className = 'page';

    const title = document.createElement('div');
    title.className = 'worksheet-title';
    title.textContent = `${Array.from(selectedSkills).join(', ')} Word Mapping`;

    const directions = document.createElement('div');
    directions.className = 'worksheet-directions';
    directions.textContent = "Read each word, write it in the sound boxes correctly, read it again.";

    page.appendChild(title);
    page.appendChild(directions);

    const table = document.createElement('table');
    table.className = 'word-table';

    const useUnder = (document.querySelector('input[name="cellStyle"]:checked')?.value === 'underlines');
    const fontName = currentCellFont();
    const patternClass = currentCellClass();

    for (let r=0; r<4; r++){
      const tr = document.createElement('tr');
      for (let c=0; c<2; c++){
        const td = document.createElement('td');
        const idx = r*2 + c;
        if (idx < allWords.length) {
          const patternHTML = renderPatternHTML(allWords[idx].pattern, useUnder);
          td.innerHTML = `
            <div class="word">${allWords[idx].word}</div>
            <div class="pattern ${patternClass}" style="font-family:'${fontName}', monospace;">${patternHTML}</div>
          `;
        }
        tr.appendChild(td);
      }
      table.appendChild(tr);
    }
    page.appendChild(table);

    const copy = document.createElement('div');
    copy.id = 'copyright';
    copy.innerHTML = '<br>Copyright - InterventionStation.com - @TeachwithMrC';
    page.appendChild(copy);

    output.appendChild(page);

    output.scrollIntoView({ behavior:'smooth', block:'start' });
  }

  document.getElementById('btnGenerate').addEventListener('click', generatePage);
});
</script>
</body>
</html>
