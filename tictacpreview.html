<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tic Tac Toe Phonics Generator - PREVIEW MODE</title>

  <script src="fluencyDataFull_v8-2_clean.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --chip-bg:#f3f6fb; --chip-text:#263238; 
    }

    body { 
      font-family:'Poppins',sans-serif; margin:28px; text-align:center; background:#fafafa; 
      /* Prevent text selection */
      user-select: none; -webkit-user-select: none;
    }
    h1 { font-size: 32px; margin-bottom: 6px; }
    .subtitle { color:#555; margin:0 0 20px; }

    /* Feature Badge */
    .feature-badge {
      display: inline-block;
      background: #e3f2fd;
      color: #1565c0;
      font-weight: 800;
      padding: 8px 16px;
      border-radius: 99px;
      margin-bottom: 15px;
      border: 1px solid #bbdefb;
      font-size: 14px;
    }

    /* COMPACT CONTROL BAR */
    .controls-wrapper {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 20px;
      max-width: 850px;
      margin: 0 auto 20px auto;
      background: #fff;
      border: 2px solid #000;
      border-radius: 12px;
      padding: 15px 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    .options-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center; 
    }
    
    @media (min-width: 700px) {
      .options-group { align-items: flex-end; }
      .controls-wrapper { flex-wrap: nowrap; }
    }

    .option-row { display: flex; gap: 8px; }
    
    .option-box { 
      display: inline-block; 
      padding: 8px 14px; 
      border: 2px solid #000; 
      border-radius: 8px; 
      font-weight: 600; 
      font-size: 14px; 
      background: #fff; 
      cursor: pointer; 
      transition: 0.1s; 
    }
    .option-box:hover { transform: translateY(-1px); box-shadow: 0 2px 0 #000; }
    .option-box.selected { background-color: #111; color: #fff; }

    .actions-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
      min-width: 200px;
    }

    /* Button Styling */
    .try-me-btn {
      background: #111;
      color: #fff;
      border: 3px solid #000;
      font-size: 20px;
      font-weight: 800;
      padding: 12px 30px;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 5px 0 #444;
      transition: all 0.1s;
      width: 100%;
      white-space: nowrap;
    }
    .try-me-btn:active {
      transform: translateY(5px);
      box-shadow: none;
    }
    .print-btn {
      background: #f0f0f0;
      color: #999;
      border: 1px solid #ccc;
      font-size: 12px;
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: not-allowed;
      width: 100%;
    }

    #output { display:flex; justify-content:center; padding:0 0 20px 0; flex-direction:column; gap:20px; }

    .page { 
      width:8.5in; max-width:calc(100% - 32px);
      background:#fff; box-shadow:0 6px 20px rgba(0,0,0,.12);
      padding:0.5in; border:2px solid #000; border-radius:8px; 
      margin:0 auto; page-break-inside: avoid;
      text-align:center;
      position: relative;
    }
    .worksheet-title { font-size:28px; margin-bottom:6px; font-weight:700; }
    .skills-line{ font-size:14px; margin:6px 0 10px; }
    .worksheet-directions { font-size:16px; margin-bottom:12px; }

    .board-wrap { display:grid; grid-template-columns: 1fr 1fr; gap:20px; justify-content:center; max-width:900px; margin:0 auto; }

    .board-shell {
      display:flex; flex-direction:column; align-items:center; width:100%;
      border:3px solid #000; border-radius:16px;
      padding:8px 0; /* no left/right padding */
      background:#fff; box-sizing:border-box;
    }
    .board-label { font-weight:700; font-size:16px; margin-bottom:6px; }

    /* Screen grid size */
    .tic-tac-toe { table-layout: fixed; border-collapse: separate; border-spacing: 0; width: 300px; height: 300px; margin:0; }
    .tic-tac-toe td { border: none; width: 100px; height: 100px; padding: 0; vertical-align: middle; overflow: hidden; position:relative; }
    .tic-tac-toe td .cell {
      display:flex; align-items:center; justify-content:center;
      padding: 6px;
      width:100%; height:100%; line-height:1.2; box-sizing:border-box; text-align:center;
      overflow:hidden; word-break:break-word; overflow-wrap:anywhere;
    }
    .tic-tac-toe td .cell.word { font-size: 24px; white-space: nowrap; }
    .tic-tac-toe td .cell.sentence { font-size: 22px; line-height: 1.12; }
    .tic-tac-toe td .cell.sentence.long { font-size: 18px; line-height: 1.08; }
    .tic-tac-toe td .cell.sentence.very-long { font-size: 16px; line-height: 1.05; }
    .tic-tac-toe td.has-bottom { border-bottom: 6px solid #000; }
    .tic-tac-toe td.has-right { border-right: 6px solid #000; }

    #copyright { font-size:12px; text-align:right; margin-top:8px; display:block; }

    /* ========= PREVIEW MODE STYLES ========= */
    .preview-wrapper {
      position: relative;
      pointer-events: none;
    }

    .fomo-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;

      /* BLUR FILTER */
      backdrop-filter: blur(2.5px);
      -webkit-backdrop-filter: blur(2.5px);
      background: rgba(255, 255, 255, 0.1);

      /* WATERMARK */
      background-image: url("data:image/svg+xml,%3Csvg width='250' height='250' viewBox='0 0 250 250' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext x='20' y='150' fill='%23000' opacity='0.15' transform='rotate(-45 125 125)' font-family='Poppins' font-weight='900' font-size='32'%3EPREVIEW MODE%3C/text%3E%3C/svg%3E");
      
      pointer-events: auto;
    }

    .lock-card {
      background: #111;
      color: #fff;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.25);
      max-width: 400px;
      animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 2px solid #fff;
    }
    @keyframes popIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .lock-icon { font-size: 40px; margin-bottom: 15px; display:block; }
    .lock-title { font-size: 24px; font-weight: 900; margin-bottom: 10px; line-height:1.2; }
    .lock-desc { font-size: 14px; margin-bottom: 25px; opacity: 0.9; line-height: 1.5;}
    
    .cta-btn {
      display: inline-block;
      background: #fff;
      color: #111;
      text-decoration: none;
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 800;
      font-size: 16px;
      transition: all 0.2s;
    }
    .cta-btn:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(255,255,255,0.3); }

    /* Print Block */
    @media print {
      body { display: none !important; }
    }
  </style>
</head>

<body oncontextmenu="return false;">
  <h1>Tic Tac Toe Generator</h1>
  <div class="feature-badge">‚ö° Includes over 40+ Phonics Skills</div>
  <div class="subtitle">Select your settings and hit TRY ME to generate a random worksheet!</div>

  <div class="controls-wrapper">
    
    <div class="options-group">
      <div class="option-row" id="blendOptions">
        <div class="option-box selected" data-blends="no">No Blends</div>
        <div class="option-box" data-blends="yes">Include Blends</div>
      </div>

      <div class="option-row" id="contentOptions">
        <div class="option-box" data-mode="words">Words</div>
        <div class="option-box" data-mode="sentences">Sentences</div>
        <div class="option-box selected" data-mode="both">Mixed</div>
      </div>
    </div>

    <div class="actions-group">
      <button id="btnGenerate" class="try-me-btn">üé≤ TRY ME!</button>
      <button id="btnPrint" class="print-btn">üñ®Ô∏è Print Worksheet</button>
    </div>

  </div>

 <center><img src="images/chrome.png" class="no-print" style="margin-bottom:10px; opacity:0.8;"></center>

  <div class="preview-wrapper">
    <div class="fomo-overlay">
      <div class="lock-card">
        <span class="lock-icon">üîí</span>
        <div class="lock-title">Premium Resource</div>
        <div class="lock-desc">
          You are viewing a preview of the Tic-Tac-Toe Generator. 
          Upgrade to Intervention Station Premium to unlock all 40+ skills, printing, and watermark removal.
        </div>
        <a href="#" class="cta-btn">Unlock Full Access</a>
      </div>
    </div>

    <div id="output"></div>
  </div>

<script>
/* ===== Utilities ===== */
if (typeof CSS === 'undefined' || typeof CSS.escape !== 'function') {
  window.CSS = window.CSS || {};
  CSS.escape = CSS.escape || function(sel){
    return (sel + '').replace(/[^a-zA-Z0-9_-]/g, '\\$&');
  };
}
function toArray(x){
  if (Array.isArray(x)) return x.slice();
  if (x == null) return [];
  try { return Array.from(x); } catch { return []; }
}
function shuffle(list){
  const a = toArray(list);
  const n = a.length >>> 0;
  for (let i = n - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    const t = a[i]; a[i] = a[j]; a[j] = t;
  }
  return a;
}
function uniqueByLowercase(list){
  const seen = new Set();
  const out = [];
  for (const item of toArray(list)){
    const key = String(item).toLowerCase();
    if (!seen.has(key)) { seen.add(key); out.push(item); }
  }
  return out;
}
function fillToN(list, n){
  const base = toArray(list);
  if (base.length === 0 || !Number.isFinite(n) || n <= 0) return [];
  const out = [];
  let bag = shuffle(base);
  while (out.length < n){
    if (bag.length === 0){
      bag = shuffle(base);
      if (bag.length === 0) break;
    }
    out.push(bag.shift());
  }
  return out.slice(0, n);
}
function chunk36ToFour(cells){ return [0,9,18,27].map(i => cells.slice(i, i+9)); }

/* ===== Data keys/mapping ===== */
const PREFIX = {
  "Short A": "0.1 - Short A",
  "Short O": "0.2 - Short O",
  "Short I": "0.3 - Short I",
  "Short U": "0.4 - Short U",
  "Short E": "0.5 - Short E",
  "FLSZ":    "0.6 - FLSZ",

  "ck": "1.1 - ck",
  "sh": "1.2 - sh",
  "th": "1.3 - th",
  "ch": "1.4 - ch",
  "wh": "1.5 - wh",

  "-all": "3.1 - all",
  "-ng":  "3.2 - ng",
  "-nk":  "3.3 - nk",

  "a_e": "2.1 - a_e",
  "i_e": "2.2 - i_e",
  "o_e": "2.3 - o_e",
  "u_e": "2.4 - u_e",

  "ar": "4.1 - ar",
  "or": "4.2 - or",
  "er/ir/ur": "4.3 - er, ir, ur",

  "Soft C (-ce)": "10.1 - ce",
  "Soft G (-ge)": "10.2 - ge",
  "Soft G (-dge)": "10.3 - dge"
};

const MIXED_RULES = {
  "Mixed CVC": ["0.1 - Short A","0.5 - Short E","0.3 - Short I","0.2 - Short O","0.4 - Short U","0.6 - FLSZ"],
  "Digraphs Mixed": ["1.1 - ck","1.2 - sh","1.3 - th","1.4 - ch","1.5 - wh"],
  "Glued Mixed": ["3.1 - all","3.2 - ng","3.3 - nk"],

  "Mixed VCe": ["2.1 - a_e","2.2 - i_e","2.3 - o_e","2.4 - u_e"],
  "Mixed R-Controlled": ["4.1 - ar","4.2 - or","4.3 - er, ir, ur"],

  "Long A (ai/ay)": ["6.1 - ay","6.2 - ai"],
  "Long E (ee/ea)": ["6.4 - ee","6.5 - ea"],
  "Long I (igh/y/ie)": ["6.6 - igh","6.7 - Final y","6.8 - ie"],
  "Long O (oa/ow/oe)": ["6.9 - oa","6.10 - ow","6.11 - oe"],
  "Long U (oo/ew/ue)": ["6.12 - oo (long u)","6.13 - ew","6.14 - ue"],

  "Mixed Vowel Teams": [
    "6.1 - ay","6.2 - ai","6.4 - ee","6.5 - ea",
    "6.6 - igh","6.7 - Final y","6.8 - ie",
    "6.9 - oa","6.10 - ow","6.11 - oe",
    "6.12 - oo (long u)","6.13 - ew","6.14 - ue"
  ],

  "Diphthongs (oy/oi)": ["7.4 - oy","7.3 - oi"],
  "Diphthongs (ow/ou)": ["7.2 - ow","7.1 - ou"],

  "Variant Vowels (au/aw)": ["7.5 - aw","7.6 - au"],
  "Variant Vowel (oo)": ["7.7 - oo variant"]
};

// Combine all possible skill keys into one array for random selection
const ALL_SKILLS = [...Object.keys(PREFIX), ...Object.keys(MIXED_RULES)];

function wordsDict(){ return (typeof fluencyWords !== 'undefined') ? fluencyWords : {}; }
function sentsDict(){ return (typeof fluencySentences !== 'undefined') ? fluencySentences : {}; }
function readDict(dict, key){ return Array.isArray(dict[key]) ? dict[key] : []; }

/* Case-flex blends + type/case fallbacks */
function readWithBlends(dict, prefix, type, blends){
  const typeLower = type.toLowerCase();
  const baseKeys = [`${prefix} ${type}`, `${prefix} ${typeLower}`, `${prefix}`];
  let base = [];
  for (const k of baseKeys){ base = base.concat(readDict(dict, k)); }

  if (blends){
    const candidates = [
      `${prefix} with Blends ${type}`,
      `${prefix} with blends ${type}`,
      `${prefix} with Blends ${typeLower}`,
      `${prefix} with blends ${typeLower}`,
      `${prefix} with BLENDS ${type}`
    ];
    const bPrefix = prefix.replace(' - ', 'b - ');
    candidates.push(
      `${bPrefix} with Blends ${type}`,
      `${bPrefix} with blends ${type}`,
      `${bPrefix} with Blends ${typeLower}`,
      `${bPrefix} with blends ${typeLower}`
    );

    for (const k of candidates){
      const got = readDict(dict, k);
      if (got.length){
        const MIN_BACKFILL = 9;
        return (got.length < MIN_BACKFILL) ? uniqueByLowercase(got.concat(base)) : got;
      }
    }
  }
  return base;
}

function getList(label, type, blends){
  const dict = (type === 'Words') ? wordsDict() : sentsDict();

  if (Object.prototype.hasOwnProperty.call(MIXED_RULES, label)){
    let all = [];
    for (const p of MIXED_RULES[label]){
      all = all.concat(readWithBlends(dict, p, type, blends));
    }
    return all;
  }

  const prefix = PREFIX[label];
  if (prefix) return readWithBlends(dict, prefix, type, blends);

  const tail1 = " " + type;
  const tail2 = " " + type.toLowerCase();
  const want = label.toLowerCase();
  const keys = Object.keys(dict);
  const guess = keys.find(k => k.toLowerCase().includes(want) && (k.endsWith(tail1) || k.endsWith(tail2)));
  return guess ? readDict(dict, guess) : [];
}

/* ===== UI wiring ===== */
const selected = new Set();
let includeBlends = false;
let mode = 'both';

document.querySelectorAll('#blendOptions .option-box').forEach(box=>{
  box.addEventListener('click', ()=>{
    document.querySelectorAll('#blendOptions .option-box').forEach(b=>b.classList.remove('selected'));
    box.classList.add('selected');
    includeBlends = (box.dataset.blends === 'yes');
  });
});

document.querySelectorAll('#contentOptions .option-box').forEach(box=>{
  box.addEventListener('click', ()=>{
    document.querySelectorAll('#contentOptions .option-box').forEach(b=>b.classList.remove('selected'));
    box.classList.add('selected');
    mode = box.dataset.mode;
  });
});

// ---- PREVIEW MODE LOCK FUNCTIONS ----

document.getElementById('btnGenerate').addEventListener('click', ()=>{
    // 1. Pick a random skill
    const randomSkill = ALL_SKILLS[Math.floor(Math.random() * ALL_SKILLS.length)];
    
    // 2. Clear old selection and add new random one
    selected.clear();
    selected.add(randomSkill);

    // 3. Generate without scroll
    generateBoards();
});

function lockedPrint(){
    alert("This feature is locked in Preview Mode.\nPlease upgrade to print worksheets.");
}
document.getElementById('btnPrint')?.addEventListener('click', lockedPrint);

/* Build a single 3x3 board */
function buildBoard(cells){
  const tbl = document.createElement('table');
  tbl.className = 'tic-tac-toe';

  for (let r=0; r<3; r++){
    const row = tbl.insertRow();
    for (let c=0; c<3; c++){
      const td = row.insertCell();
      const idx = r*3+c;
      const val = (cells[idx] != null) ? String(cells[idx]) : '';
      const isSentence = val.includes(' ');

      if (r < 2) td.classList.add('has-bottom');
      if (c < 2) td.classList.add('has-right');

      const inner = document.createElement('div');
      inner.className = 'cell ' + (isSentence ? 'sentence' : 'word');

      if (isSentence) {
        const charCount = val.length;
        if (charCount > 40) inner.classList.add('very-long');
        else if (charCount > 24) inner.classList.add('long');
      }

      inner.textContent = val;
      td.appendChild(inner);
    }
  }

  const wrap = document.createElement('div');
  wrap.className = 'board-shell';
  const label = document.createElement('div');
  label.className = 'board-label';
  label.textContent = '';
  wrap.appendChild(label);
  wrap.appendChild(tbl);
  return wrap;
}

/* Generate all four boards */
function generateBoards(){
  if (!wordsDict() && !sentsDict()) return alert('Data not loaded. Check the <script src="..."> file name.');

  const labels = Array.from(selected);
  const TOTAL = 36;
  let content = [];

  if (mode === 'words'){
    const unionW = labels.flatMap(lbl => getList(lbl, 'Words', includeBlends));
    const pool = uniqueByLowercase(unionW);
    content = fillToN(shuffle(pool), TOTAL);
  } else if (mode === 'sentences'){
    const unionS = labels.flatMap(lbl => getList(lbl, 'Sentences', includeBlends));
    const pool = uniqueByLowercase(unionS);
    content = fillToN(shuffle(pool), TOTAL);
  } else {
    const words = uniqueByLowercase(labels.flatMap(lbl => getList(lbl, 'Words', includeBlends)));
    const sents = uniqueByLowercase(labels.flatMap(lbl => getList(lbl, 'Sentences', includeBlends)));
    const w = fillToN(shuffle(words), Math.floor(TOTAL/2));
    const s = fillToN(shuffle(sents), TOTAL - w.length);
    content = shuffle(w.concat(s));
  }

  // Preview Mode Loop Fill
  while(content.length < TOTAL && content.length > 0) {
      content = content.concat(content);
  }
  content = content.slice(0, TOTAL);

  const output = document.getElementById('output');
  output.innerHTML = '';

  const page = document.createElement('div');
  page.className = 'page';

  /* HEADER: Title -> Skills -> Directions */
  const title = document.createElement('div');
  title.className = 'worksheet-title';
  title.textContent = 'Phonics Tic Tac Toe';

  const skills = document.createElement('div');
  skills.className = 'skills-line';
  skills.innerHTML = '<strong>Skills:</strong> ' + (labels.length ? labels.join(' ‚Ä¢ ') : '‚Äî');

  const directions = document.createElement('div');
  directions.className = 'worksheet-directions';
  directions.innerHTML = '<strong>Directions:</strong> Read the word or sentence, then place your X or O. First to 3 in a row wins!';

  const grid = document.createElement('div');
  grid.className = 'board-wrap';

  const boards = chunk36ToFour(content);
  boards.forEach((cells, i)=>{
    const group = buildBoard(cells);
    group.querySelector('.board-label').textContent = 'Game ' + (i+1);
    grid.appendChild(group);
  });

  const copy = document.createElement('div');
  copy.id = 'copyright';
  copy.textContent = 'Copyright - InterventionStation.com - @TeachwithMrC';

  page.appendChild(title);
  page.appendChild(skills);
  page.appendChild(directions);
  page.appendChild(grid);
  page.appendChild(copy);
  output.appendChild(page);
  
  // Scroll to wrapper to see lock card
  document.querySelector('.preview-wrapper').scrollIntoView({ behavior:'smooth', block:'start' });
}

// Generate on load
window.onload = function() {
    document.getElementById('btnGenerate').click();
};
</script>
</body>
</html>
