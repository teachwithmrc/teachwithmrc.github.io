<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>R-Controlled Tic Tac Toe - Mobile Preview</title>
<script src="../../fluencyDataFull_v8-2_clean.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --preview-ratio: 1.4375;
    --preview-scale: 0.66;
    --ink:#111;
    --line:#111;
  }

  *{ box-sizing:border-box; }
  html,body{ margin:0; padding:0; font-family:"Poppins",Arial,sans-serif; color:var(--ink); background:#fff; }
  .wrap{ max-width:460px; margin:0 auto; padding:10px; }

  .usage-steps{ border:2px solid var(--line); border-radius:12px; background:#f8fbff; padding:10px 12px; margin-bottom:10px; }
  .usage-steps h2{ margin:0 0 8px; font-size:30px; line-height:1.05; font-weight:900; text-align:center; }
  .usage-steps p{ margin:0; text-align:center; font-size:13px; font-weight:700; line-height:1.35; }

  .controls{ border:2px solid var(--line); border-radius:12px; padding:12px; margin-bottom:12px; }
  .controls-top{ display:grid; grid-template-columns:1fr 1fr; align-items:flex-end; gap:12px; }
  .field{ display:flex; flex-direction:column; gap:8px; min-width:0; }
  .field label{ font-size:15px; font-weight:900; }
  select{
    height:56px; width:100%; border:2px solid var(--line); border-radius:10px; padding:8px 10px;
    font-family:"Poppins",Arial,sans-serif; font-size:16px; font-weight:800; background:#fff;
  }

  .controls-actions{ margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .btn{
    border:2px solid var(--line); border-radius:14px; height:52px; padding:0 8px;
    font-family:"Poppins",Arial,sans-serif; font-size:17px; font-weight:900; cursor:pointer;
  }
  .btn-primary{ background:#6ec1ff; color:#fff; }
  .btn-secondary{ background:#fff; color:#111; }
  .hint{ margin-top:8px; text-align:center; font-size:13px; font-weight:700; line-height:1.35; }

  .preview-shell{
    position:relative; width:100%; aspect-ratio:var(--preview-ratio); overflow:hidden;
    border:2px solid var(--line); background:#fff;
  }
  .preview-content{
    position:absolute; left:50%; top:0; width:calc(100% / var(--preview-scale));
    transform:translateX(-50%) scale(var(--preview-scale)); transform-origin:top center; padding:10px;
  }

  .sheet{
    border:2px solid var(--line);
    padding:10px;
    background:#fff;
  }
  .sheet-title{ margin:0 0 4px; text-align:center; font-size:26px; line-height:1.1; font-weight:900; }
  .skills-line{ font-size:13px; margin:0 0 8px; text-align:center; font-weight:700; }
  .directions{ font-size:13px; margin:0 0 8px; text-align:center; font-weight:700; line-height:1.3; }

  .board-wrap{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
    justify-content:center;
  }
  .board-shell{
    display:flex;
    flex-direction:column;
    align-items:center;
    width:100%;
    border:2px solid #000;
    border-radius:12px;
    padding:6px 0;
    background:#fff;
  }
  .board-label{ font-weight:900; font-size:12px; margin-bottom:4px; }

  .tic-tac-toe{
    table-layout:fixed;
    border-collapse:separate;
    border-spacing:0;
    width:194px;
    height:194px;
    margin:0;
  }
  .tic-tac-toe td{
    border:none;
    width:64px;
    height:64px;
    padding:0;
    vertical-align:middle;
    overflow:hidden;
    position:relative;
  }
  .tic-tac-toe td.has-bottom{ border-bottom:4px solid #000; }
  .tic-tac-toe td.has-right{ border-right:4px solid #000; }

  .cell{
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    padding:5px;
    width:100%;
    height:100%;
    line-height:1.12;
    overflow:hidden;
    word-break:break-word;
    overflow-wrap:anywhere;
    font-weight:700;
  }
  .cell.word{ font-size:17px; white-space:nowrap; }
  .cell.sentence{ font-size:14px; }
  .cell.sentence.long{ font-size:12px; line-height:1.06; }
  .cell.sentence.very-long{ font-size:10px; line-height:1.03; }

  .sheet-footer{ margin-top:8px; text-align:right; font-size:10px; font-weight:700; color:#666; }
  .copyright{ margin-top:8px; text-align:center; font-size:12px; font-weight:700; letter-spacing:.2px; }

  .preview-watermark{
    position:absolute; inset:0; z-index:118; pointer-events:none; opacity:.52;
    background-image:
      repeating-linear-gradient(-26deg, rgba(0,0,0,.08) 0 18px, rgba(255,255,255,.06) 18px 36px),
      url("data:image/svg+xml,%3Csvg width='340' height='220' viewBox='0 0 340 220' xmlns='http://www.w3.org/2000/svg'%3E%3Cg transform='rotate(-22 170 110)'%3E%3Ctext x='18' y='90' fill='%23000' fill-opacity='.26' font-family='Poppins' font-size='34' font-weight='900'%3EPREVIEW ONLY%3C/text%3E%3Ctext x='44' y='146' fill='%23000' fill-opacity='.2' font-family='Poppins' font-size='22' font-weight='800'%3ENOT FOR CLASSROOM USE%3C/text%3E%3C/g%3E%3C/svg%3E");
    background-size:auto, 340px 220px; background-repeat:repeat;
  }
  .preview-paywall{
    position:absolute; left:0; right:0; bottom:0; z-index:120; pointer-events:none; display:flex;
    align-items:flex-end; justify-content:center; padding:6px; background:linear-gradient(to top, rgba(0,0,0,.62), rgba(0,0,0,0));
  }
  .preview-paywall-card{
    width:min(96%, 420px); border:1px solid #fff; border-radius:10px; background:rgba(17,17,17,.90);
    color:#fff; text-align:center; padding:7px 8px 6px; box-shadow:0 8px 20px rgba(0,0,0,.3); pointer-events:auto;
  }
  .preview-paywall-card h3{ margin:0 0 2px; font-size:.72rem; line-height:1.2; font-weight:900; letter-spacing:.02em; text-transform:uppercase; }
  .preview-paywall-card p{ margin:0 0 4px; font-size:.62rem; line-height:1.2; opacity:.95; font-weight:600; }
  .preview-paywall-card a{ display:inline-block; text-decoration:none; background:#fff; color:#111; border-radius:7px; padding:4px 8px; font-size:.62rem; font-weight:900; }

  @media screen and (max-width:430px){
    :root{ --preview-scale:0.62; }
    .controls-top{ grid-template-columns:1fr; }
  }
  @media print{ body{ display:none !important; } }
</style>
</head>
<body oncontextmenu="return false;">
<div class="wrap">
  <section class="usage-steps" aria-label="How this preview works">
    <h2>R-Controlled Preview</h2>
    <p>Select an r-controlled skill and choose <strong>Words</strong>, <strong>Sentences</strong>, or <strong>Both</strong>, then tap <strong>Generate Preview</strong>.</p>
  </section>

  <div class="controls">
    <div class="controls-top">
      <div class="field">
        <label for="skillSelect">R-Controlled Skill</label>
        <select id="skillSelect">
          <option value="Mixed R-Controlled" selected>Mixed R-Controlled</option>
          <option value="ar">ar</option>
          <option value="or">or</option>
          <option value="er/ir/ur">er/ir/ur</option>
        </select>
      </div>

      <div class="field">
        <label for="modeSelect">Grid Content</label>
        <select id="modeSelect">
          <option value="words" selected>Words Only</option>
          <option value="sentences">Sentences Only</option>
          <option value="both">Both</option>
        </select>
      </div>
    </div>

    <div class="controls-actions">
      <button type="button" id="btnGen" class="btn btn-primary">Generate Preview</button>
      <button type="button" id="btnPrint" class="btn btn-secondary">Print</button>
    </div>

    <div class="hint" id="hint"></div>
  </div>

  <div class="preview-shell" aria-label="R-Controlled tic tac toe preview worksheet">
    <div class="preview-content">
      <section class="sheet" id="worksheetHost"></section>
      <div class="copyright">Copyright - InterventionStation.com - @TeachwithMrC</div>
    </div>

    <div class="preview-watermark" aria-hidden="true"></div>
    <div class="preview-paywall" aria-hidden="false">
      <div class="preview-paywall-card">
        <h3>Premium Resource</h3>
        <p>Generate is enabled in preview mode. Join membership to unlock full worksheet visibility and printing.</p>
        <a href="https://member.interventionstation.com/join" target="_blank" rel="noopener">Join Membership</a>
      </div>
    </div>
  </div>
</div>

<script>
  if (typeof CSS === "undefined" || typeof CSS.escape !== "function") {
    window.CSS = window.CSS || {};
    CSS.escape = CSS.escape || function(sel){
      return (sel + "").replace(/[^a-zA-Z0-9_-]/g, "\\$&");
    };
  }

  const $ = (id) => document.getElementById(id);
  const TOTAL_CELLS = 36;

  const PREFIX = {
    "ar": "4.1 - ar",
    "or": "4.2 - or",
    "er/ir/ur": "4.3 - er, ir, ur"
  };

  const MIXED_RULES = {
    "Mixed R-Controlled": ["4.1 - ar", "4.2 - or", "4.3 - er, ir, ur"]
  };

  function toArray(x){
    if (Array.isArray(x)) return x.slice();
    if (x == null) return [];
    try { return Array.from(x); } catch { return []; }
  }

  function shuffle(list){
    const a = toArray(list);
    for (let i = a.length - 1; i > 0; i -= 1) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function uniqueByLowercase(list){
    const seen = new Set();
    const out = [];
    for (const item of toArray(list)) {
      const key = String(item).toLowerCase();
      if (!seen.has(key)) {
        seen.add(key);
        out.push(item);
      }
    }
    return out;
  }

  function fillToN(list, n){
    const base = toArray(list);
    if (!base.length || n <= 0) return [];
    const out = [];
    let bag = shuffle(base);
    while (out.length < n) {
      if (!bag.length) bag = shuffle(base);
      out.push(bag.shift());
    }
    return out.slice(0, n);
  }

  function chunk36ToFour(cells){
    return [0, 9, 18, 27].map((i) => cells.slice(i, i + 9));
  }

  function wordsDict(){ return (typeof fluencyWords !== "undefined") ? fluencyWords : {}; }
  function sentsDict(){ return (typeof fluencySentences !== "undefined") ? fluencySentences : {}; }
  function readDict(dict, key){ return Array.isArray(dict[key]) ? dict[key] : []; }

  function readWithType(dict, prefix, type){
    const typeLower = type.toLowerCase();
    const keys = [
      `${prefix} ${type}`,
      `${prefix} ${typeLower}`,
      `${prefix}`
    ];
    let out = [];
    for (const k of keys) out = out.concat(readDict(dict, k));
    return out;
  }

  function getList(label, type){
    const dict = (type === "Words") ? wordsDict() : sentsDict();
    if (Object.prototype.hasOwnProperty.call(MIXED_RULES, label)) {
      let all = [];
      for (const p of MIXED_RULES[label]) all = all.concat(readWithType(dict, p, type));
      return all;
    }
    const prefix = PREFIX[label];
    if (prefix) return readWithType(dict, prefix, type);
    return [];
  }

  function buildBoard(cells, gameIndex){
    const table = document.createElement("table");
    table.className = "tic-tac-toe";

    for (let r = 0; r < 3; r += 1) {
      const row = table.insertRow();
      for (let c = 0; c < 3; c += 1) {
        const td = row.insertCell();
        const idx = r * 3 + c;
        const val = (cells[idx] != null) ? String(cells[idx]) : "";
        const isSentence = val.includes(" ");

        if (r < 2) td.classList.add("has-bottom");
        if (c < 2) td.classList.add("has-right");

        const inner = document.createElement("div");
        inner.className = `cell ${isSentence ? "sentence" : "word"}`;
        if (isSentence) {
          const len = val.length;
          if (len > 40) inner.classList.add("very-long");
          else if (len > 24) inner.classList.add("long");
        }
        inner.textContent = val;
        td.appendChild(inner);
      }
    }

    const shell = document.createElement("div");
    shell.className = "board-shell";
    shell.innerHTML = `<div class="board-label">Game ${gameIndex}</div>`;
    shell.appendChild(table);
    return shell;
  }

  function build(){
    const label = $("skillSelect").value;
    const mode = $("modeSelect").value;

    if (!wordsDict() && !sentsDict()) {
      $("worksheetHost").innerHTML = "<div style='font-size:14px;font-weight:700;text-align:center;'>Data is unavailable. Please check <code>fluencyDataFull_v8-2_clean.js</code>.</div>";
      $("hint").textContent = "Could not load fluency data.";
      return;
    }

    let content = [];
    if (mode === "words") {
      const pool = uniqueByLowercase(getList(label, "Words"));
      content = fillToN(shuffle(pool), TOTAL_CELLS);
    } else if (mode === "sentences") {
      const pool = uniqueByLowercase(getList(label, "Sentences"));
      content = fillToN(shuffle(pool), TOTAL_CELLS);
    } else {
      const words = uniqueByLowercase(getList(label, "Words"));
      const sents = uniqueByLowercase(getList(label, "Sentences"));
      const w = fillToN(shuffle(words), Math.floor(TOTAL_CELLS / 2));
      const s = fillToN(shuffle(sents), TOTAL_CELLS - w.length);
      content = shuffle(w.concat(s));
    }

    if (content.length < TOTAL_CELLS) {
      $("worksheetHost").innerHTML = "<div style='font-size:14px;font-weight:700;text-align:center;'>Not enough content found for this selection.</div>";
      $("hint").textContent = "Try a different skill or mode.";
      return;
    }

    const boards = chunk36ToFour(content);
    const boardWrap = document.createElement("div");
    boardWrap.className = "board-wrap";
    boards.forEach((cells, i) => boardWrap.appendChild(buildBoard(cells, i + 1)));

    $("worksheetHost").innerHTML = `
      <h2 class="sheet-title">Phonics Tic Tac Toe</h2>
      <div class="skills-line"><strong>Skill:</strong> ${label}</div>
      <div class="directions"><strong>Directions:</strong> Read the word or sentence, then place your X or O. First to 3 in a row wins.</div>
    `;
    $("worksheetHost").appendChild(boardWrap);
    $("worksheetHost").insertAdjacentHTML("beforeend", "<div class='sheet-footer'>Preview mode: sample r-controlled worksheet view.</div>");

    const modeLabel = mode === "both" ? "Both words and sentences" : (mode === "words" ? "Words only" : "Sentences only");
    $("hint").textContent = `${label} â€¢ ${modeLabel}`;
  }

  function lockedPreviewAction(){
    alert("This feature is locked in Preview Mode.\nPlease join membership for full worksheet access.");
  }

  function blockShortcuts(event){
    const blocked = (event.ctrlKey || event.metaKey) && ["p", "s", "u"].includes(event.key.toLowerCase());
    if (blocked) event.preventDefault();
  }

  document.addEventListener("keydown", blockShortcuts);
  $("btnGen").addEventListener("click", build);
  $("btnPrint").addEventListener("click", lockedPreviewAction);
  ["skillSelect", "modeSelect"].forEach((id) => $(id).addEventListener("change", build));

  build();
</script>
</body>
</html>
