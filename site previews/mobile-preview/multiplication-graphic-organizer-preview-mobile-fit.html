<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Multiplication Organizer - Mobile Preview</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --preview-ratio: 1.4375;
    --preview-scale: 0.70;
    --p1:#f5f5f5;
    --p2:#f7ead8;
    --p3:#e7f2fb;
    --p4:#e5f6e9;
    --p5:#fcecc8;
    --p6:#f9e3f1;
    --p7:#e1f4f6;
  }
  *{ box-sizing:border-box; }
  html,body{ margin:0; padding:0; font-family:"Poppins",Arial,sans-serif; color:#111; background:#fff; }
  .wrap{ max-width:460px; margin:0 auto; padding:10px; }

  .usage-steps{ border:2px solid #111; border-radius:12px; background:#f8fbff; padding:10px 12px; margin-bottom:10px; }
  .usage-steps h2{ margin:0 0 8px; font-size:30px; line-height:1.05; font-weight:900; text-align:center; }
  .usage-steps p{ margin:0; text-align:center; font-size:13px; font-weight:700; line-height:1.35; }

  .controls{ border:2px solid #111; border-radius:12px; padding:12px; margin-bottom:12px; }
  .controls-top{ display:grid; grid-template-columns:1fr; gap:10px; align-items:flex-end; }
  .field{ display:flex; flex-direction:column; gap:8px; min-width:0; }
  .field label{ font-size:16px; font-weight:900; }
  select{ height:56px; width:100%; border:2px solid #111; border-radius:10px; padding:8px 10px; font-family:"Poppins",Arial,sans-serif; font-size:20px; font-weight:800; background:#fff; }

  .controls-mid{ margin-top:10px; }
  .toggle{ display:flex; align-items:center; gap:8px; padding:8px 10px; border:2px solid #111; border-radius:12px; font-weight:900; font-size:13px; line-height:1.2; user-select:none; background:#fff; }
  .toggle input[type="checkbox"]{ appearance:none; width:38px; height:22px; min-width:38px; margin:0; border:2px solid #111; border-radius:999px; background:#fff; cursor:pointer; position:relative; }
  .toggle input[type="checkbox"]::after{ content:""; position:absolute; top:50%; left:3px; width:14px; height:14px; border:2px solid #111; border-radius:999px; background:#fff; transform:translateY(-50%); transition:all .15s ease; }
  .toggle input[type="checkbox"]:checked{ background:#111; }
  .toggle input[type="checkbox"]:checked::after{ left:17px; }

  .controls-actions{ margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .btn{ border:2px solid #111; border-radius:14px; height:52px; padding:0 8px; font-family:"Poppins",Arial,sans-serif; font-size:17px; font-weight:900; cursor:pointer; }
  .btn-primary{ background:#6ec1ff; color:#fff; }
  .btn-secondary{ background:#fff; color:#111; }
  .hint{ margin-top:8px; text-align:center; font-size:13px; font-weight:700; line-height:1.35; }

  .preview-shell{ position:relative; margin-top:4px; width:100%; aspect-ratio:var(--preview-ratio); overflow:hidden; border:2px solid #111; background:#fff; }
  .preview-content{ position:absolute; left:50%; top:0; width:calc(100% / var(--preview-scale)); transform:translateX(-50%) scale(var(--preview-scale)); transform-origin:top center; padding:10px; }

  .sheet{ border:2px solid #111; padding:10px 10px 8px; background:#fff; }
  .sheet-header{ display:flex; align-items:flex-end; justify-content:space-between; gap:8px; margin-bottom:8px; }
  .sheet-title{ margin:0; font-size:23px; line-height:1.1; font-weight:900; }
  .name-line{ white-space:nowrap; font-family:Arial,sans-serif; font-size:16px; font-weight:800; }
  .name-line .line{ display:inline-block; width:120px; border-bottom:2px solid #111; transform:translateY(-2px); margin-left:4px; }

  .problems{ display:grid; grid-template-columns:1fr 1fr; border:2px solid #111; }
  .problem-wrap{ --cell-size:35px; --cell-gap:4px; --op-width:24px; display:flex; flex-direction:column; align-items:center; gap:7px; padding:8px 8px 9px; border-right:2px solid #111; min-height:260px; }
  .problem-wrap:last-child{ border-right:none; }
  .problem-top{ width:100%; display:flex; justify-content:center; }
  .problem-head{ border:2px solid #111; border-radius:4px; background:#fff; padding:5px 8px; font-weight:800; font-size:0.9rem; line-height:1.1; min-height:36px; display:inline-flex; align-items:center; gap:5px; max-width:100%; }
  .problem-badge{ width:20px; height:20px; border:2px solid #111; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:0.68rem; font-weight:800; background:#fff; line-height:1; flex:0 0 auto; }
  .problem-text{ display:inline-flex; align-items:center; line-height:1.05; font-size:1.05rem; font-weight:800; letter-spacing:0.2px; }

  .add-table{ display:flex; flex-direction:column; gap:0; align-items:center; }
  .table-row{ display:grid; gap:var(--cell-gap); align-items:center; justify-items:stretch; width:max-content; }
  .op-cell{ width:var(--op-width); height:var(--cell-size); display:flex; align-items:center; justify-content:center; font-size:1.7rem; font-weight:700; line-height:1; color:#111; }
  .digit-cell{ width:var(--cell-size); height:var(--cell-size); border:2px solid #111; display:flex; align-items:center; justify-content:center; font-size:1.32rem; font-weight:800; line-height:1; background:#fff; }
  .carry-row{ margin-bottom:5px; }
  .carry-row .op-cell{ height:calc(var(--cell-size) * 0.64); font-size:1.05rem; }
  .carry-row .digit-cell{ height:calc(var(--cell-size) * 0.64); font-size:1rem; border-color:#9ba6bb; }
  .line-row{ display:grid; gap:var(--cell-gap); align-items:center; margin:0; width:max-content; }
  .line-spacer{ width:var(--op-width); height:0; }
  .sum-line{ height:0; border-top:4px solid #000; align-self:center; margin:1px 0; }

  .sheet-footer{ margin-top:8px; font-size:11px; line-height:1.35; font-weight:700; text-align:left; }
  .copyright{ margin-top:8px; text-align:center; font-size:12px; font-weight:700; letter-spacing:.2px; }

  .preview-watermark{ position:absolute; inset:0; z-index:118; pointer-events:none; opacity:.52; background-image:repeating-linear-gradient(-26deg, rgba(0,0,0,.08) 0 18px, rgba(255,255,255,.06) 18px 36px), url("data:image/svg+xml,%3Csvg width='340' height='220' viewBox='0 0 340 220' xmlns='http://www.w3.org/2000/svg'%3E%3Cg transform='rotate(-22 170 110)'%3E%3Ctext x='18' y='90' fill='%23000' fill-opacity='.26' font-family='Poppins' font-size='34' font-weight='900'%3EPREVIEW ONLY%3C/text%3E%3Ctext x='44' y='146' fill='%23000' fill-opacity='.2' font-family='Poppins' font-size='22' font-weight='800'%3ENOT FOR CLASSROOM USE%3C/text%3E%3C/g%3E%3C/svg%3E"); background-size:auto, 340px 220px; background-repeat:repeat; }
  .preview-paywall{ position:absolute; left:0; right:0; bottom:0; z-index:120; pointer-events:none; display:flex; align-items:flex-end; justify-content:center; padding:6px; background:linear-gradient(to top, rgba(0,0,0,.62), rgba(0,0,0,0)); }
  .preview-paywall-card{ width:min(96%, 420px); border:1px solid #fff; border-radius:10px; background:rgba(17,17,17,.90); color:#fff; text-align:center; padding:7px 8px 6px; box-shadow:0 8px 20px rgba(0,0,0,.3); pointer-events:auto; }
  .preview-paywall-card h3{ margin:0 0 2px; font-size:.72rem; line-height:1.2; font-weight:900; letter-spacing:.02em; text-transform:uppercase; }
  .preview-paywall-card p{ margin:0 0 4px; font-size:.62rem; line-height:1.2; opacity:.95; font-weight:600; }
  .preview-paywall-card a{ display:inline-block; text-decoration:none; background:#fff; color:#111; border-radius:7px; padding:4px 8px; font-size:.62rem; font-weight:900; }

  @media screen and (max-width:430px){ :root{ --preview-scale:0.64; } }
  @media print{ body{ display:none !important; } }
</style>
</head>
<body oncontextmenu="return false;">
<div class="wrap">
  <section class="usage-steps" aria-label="How this preview works">
    <h2>Multiplication Organizer Preview</h2>
    <p>Select a problem type, then tap <strong>Generate Preview</strong> to refresh the worksheet sample.</p>
  </section>

  <div class="controls">
    <div class="controls-top">
      <div class="field">
        <label for="problemType">Type of Problem</label>
        <select id="problemType">
          <option value="2x1" selected>2 x 1</option>
          <option value="2x2">2 x 2</option>
          <option value="3x1">3 x 1</option>
          <option value="4x1">4 x 1</option>
          <option value="3x2">3 x 2</option>
        </select>
      </div>
    </div>

    <div class="controls-mid">
      <label class="toggle" for="colorToggle">
        <input id="colorToggle" type="checkbox" checked>
        Color Coded Boxes
      </label>
    </div>

    <div class="controls-actions">
      <button type="button" id="btnGen" class="btn btn-primary">Generate Preview</button>
      <button type="button" id="btnPrint" class="btn btn-secondary">Print</button>
    </div>

    <div class="hint" id="hint"></div>
  </div>

  <div class="preview-shell" aria-label="Multiplication Organizer Preview">
    <div class="preview-content">
      <section class="sheet" id="worksheetHost"></section>
      <div class="copyright">Copyright - InterventionStation.com - @TeachwithMrC</div>
    </div>

    <div class="preview-watermark" aria-hidden="true"></div>
    <div class="preview-paywall" aria-hidden="false">
      <div class="preview-paywall-card">
        <h3>Premium Resource</h3>
        <p>Generate is enabled in preview mode. Join membership to unlock full worksheet visibility and printing.</p>
        <a href="https://member.interventionstation.com/join" target="_blank" rel="noopener">Join Membership</a>
      </div>
    </div>
  </div>
</div>

<script>
  (function syncPreviewRatioToGif(){
    const refGif = "https://assets.cdn.filesafe.space/F9vnmU5R8sOuTGoxp5by/media/699fd28c753f15732d25dd10.gif";
    const img = new Image();
    img.onload = function(){
      if (img.naturalWidth > 0 && img.naturalHeight > 0) {
        const ratio = img.naturalWidth / img.naturalHeight;
        document.documentElement.style.setProperty("--preview-ratio", String(ratio));
      }
    };
    img.src = refGif;
  })();

  const $ = (id) => document.getElementById(id);
  const PROBLEM_COUNT = 2;

  const TYPE_CONFIG = {
    "2x1": { aDigits: 2, bDigits: 1, label: "2-digit x 1-digit" },
    "2x2": { aDigits: 2, bDigits: 2, label: "2-digit x 2-digit" },
    "3x1": { aDigits: 3, bDigits: 1, label: "3-digit x 1-digit" },
    "4x1": { aDigits: 4, bDigits: 1, label: "4-digit x 1-digit" },
    "3x2": { aDigits: 3, bDigits: 2, label: "3-digit x 2-digit" }
  };

  const PLACE_COLORS = ["var(--p1)","var(--p2)","var(--p3)","var(--p4)","var(--p5)","var(--p6)","var(--p7)"];

  function randInt(min, max){ return Math.floor(Math.random() * (max - min + 1)) + min; }
  function randomWithDigits(digits){ const min = Math.pow(10, digits - 1); const max = Math.pow(10, digits) - 1; return randInt(min, max); }

  function hasMultiplicationRegrouping(a, b){
    const aLow = String(a).split("").reverse().map(Number);
    const bLow = String(b).split("").reverse().map(Number);

    for(let r = 0; r < bLow.length; r += 1){
      const bd = bLow[r];
      let carry = 0;
      for(let c = 0; c < aLow.length; c += 1){
        const ad = aLow[c];
        const product = ad * bd + carry;
        if(product >= 10) return true;
        carry = Math.floor(product / 10);
      }
      if(carry > 0) return true;
    }

    if(bLow.length <= 1) return false;

    const partialRows = bLow.map((bd, shift) => ({ shift, digits: String(a * bd).split("").reverse().map(Number) }));
    let addCarry = 0;
    const maxPlaces = aLow.length + bLow.length + 1;

    for(let place = 0; place < maxPlaces; place += 1){
      let sum = addCarry;
      for(let r = 0; r < partialRows.length; r += 1){
        const row = partialRows[r];
        const idx = place - row.shift;
        if(idx >= 0 && idx < row.digits.length) sum += row.digits[idx];
      }
      if(sum >= 10) return true;
      addCarry = Math.floor(sum / 10);
    }

    return addCarry > 0;
  }

  function randomRegroupProblem(aDigits, bDigits){
    for(let tries = 0; tries < 4000; tries += 1){
      const a = randomWithDigits(aDigits);
      const b = randomWithDigits(bDigits);
      if(hasMultiplicationRegrouping(a, b)) return { a, b };
    }
    return { a: Number(`9${"1".repeat(Math.max(0, aDigits - 1))}`), b: Number(`9${"1".repeat(Math.max(0, bDigits - 1))}`) };
  }

  function buildProblems(aDigits, bDigits){
    const out = [];
    const seen = new Set();
    while(out.length < PROBLEM_COUNT){
      const p = randomRegroupProblem(aDigits, bDigits);
      const key = `${p.a}x${p.b}`;
      if(seen.has(key)) continue;
      seen.add(key);
      out.push(p);
    }
    return out;
  }

  function cellStyleByColumn(colIndex, totalCols, colorOn){
    if(!colorOn) return "";
    const placeFromRight = totalCols - 1 - colIndex;
    const color = PLACE_COLORS[placeFromRight % PLACE_COLORS.length];
    return `background:${color};`;
  }

  function rowCellsWithValues(totalCols, colorOn){
    const cells = [];
    for(let i = 0; i < totalCols; i += 1){
      cells.push(`<div class="digit-cell" style="${cellStyleByColumn(i, totalCols, colorOn)}">&nbsp;</div>`);
    }
    return cells.join("");
  }

  function problemLetter(index){ const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"; return letters[index] || "A"; }

  function problemHtml(problem, index, totalCols, colorOn, bDigits){
    const letter = problemLetter(index);
    const rowTemplate = `grid-template-columns: var(--op-width) repeat(${totalCols}, var(--cell-size));`;
    const lineTemplate = `grid-template-columns: var(--op-width) calc(${totalCols} * var(--cell-size) + ${(totalCols - 1)} * var(--cell-gap));`;

    const partialRows = bDigits > 1
      ? Array.from({ length: bDigits }, () => `
          <div class="table-row" style="${rowTemplate}">
            <div class="op-cell">&nbsp;</div>
            ${rowCellsWithValues(totalCols, colorOn)}
          </div>
        `).join("")
      : "";

    return `
      <section class="problem-wrap">
        <div class="problem-top">
          <div class="problem-head">
            <span class="problem-badge">${letter}</span>
            <span class="problem-text">${problem.a} x ${problem.b}</span>
          </div>
        </div>

        <div class="add-table">
          <div class="table-row carry-row" style="${rowTemplate}">
            <div class="op-cell">&nbsp;</div>
            ${rowCellsWithValues(totalCols, false)}
          </div>

          <div class="table-row" style="${rowTemplate}">
            <div class="op-cell">&nbsp;</div>
            ${rowCellsWithValues(totalCols, colorOn)}
          </div>

          <div class="table-row" style="${rowTemplate}">
            <div class="op-cell">x</div>
            ${rowCellsWithValues(totalCols, colorOn)}
          </div>

          <div class="line-row" style="${lineTemplate}">
            <div class="line-spacer"></div>
            <div class="sum-line"></div>
          </div>

          ${partialRows}

          ${bDigits > 1 ? `
          <div class="line-row" style="${lineTemplate}">
            <div class="line-spacer"></div>
            <div class="sum-line"></div>
          </div>` : ""}

          <div class="table-row" style="${rowTemplate}">
            <div class="op-cell">&nbsp;</div>
            ${rowCellsWithValues(totalCols, colorOn)}
          </div>
        </div>
      </section>
    `;
  }

  function updateHint(cfg){
    const colorText = $("colorToggle").checked ? "Color coded boxes on." : "Color coded boxes off.";
    $("hint").textContent = `Generating regrouping-only ${cfg.label} problems. ${colorText}`;
  }

  function build(){
    const type = $("problemType").value;
    const cfg = TYPE_CONFIG[type] || TYPE_CONFIG["2x1"];
    const colorOn = $("colorToggle").checked;

    const problems = buildProblems(cfg.aDigits, cfg.bDigits);
    const totalCols = cfg.aDigits + cfg.bDigits;

    $("worksheetHost").innerHTML = `
      <header class="sheet-header">
        <h2 class="sheet-title">Multiplication Graphic Organizer</h2>
        <div class="name-line">Name:<span class="line"></span></div>
      </header>

      <div class="problems">
        ${problems.map((p, i) => problemHtml(p, i, totalCols, colorOn, cfg.bDigits)).join("")}
      </div>

      <div class="sheet-footer">Advanced organizer: students place digits, carry/regroup when needed, and solve in the table boxes.</div>
    `;

    updateHint(cfg);
  }

  function lockedPreviewAction(){ alert("This feature is locked in Preview Mode.\nPlease join membership for full worksheet access."); }
  function blockShortcuts(event){ const blocked = (event.ctrlKey || event.metaKey) && ["p","s","u"].includes(event.key.toLowerCase()); if(blocked) event.preventDefault(); }

  document.addEventListener("keydown", blockShortcuts);
  $("btnGen").addEventListener("click", build);
  $("btnPrint").addEventListener("click", lockedPreviewAction);
  ["problemType", "colorToggle"].forEach(id => $(id).addEventListener("change", build));
  build();
</script>
</body>
</html>
