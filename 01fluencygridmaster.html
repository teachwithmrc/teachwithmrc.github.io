<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fluency Grid Generator</title>

  <!-- Data file (unchanged) -->
  <script src="fluencyDataFull_v8-2_clean.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --ink:#1f365f; --bg:#fafafa; --card:#ffffff; --border:#101010;
      --chip:#f3f6fb; --chip-x:#546e7a;
      --cvc:#e9f2ff; --dig:#f3e9ff; --glued:#e8fff4; --vce:#fff5e6;
      --rctrl:#f0f5ff; --vteams:#fff0f6; --dip:#eefcfb; --variant:#fff8e1; --soft:#eef4ff;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { font-family: 'Poppins', sans-serif; margin: 28px; background: var(--bg); color: var(--ink); }

    h1 { text-align:center; margin: 0 0 6px; font-size: 30px; }
    .subtitle { text-align:center; color:#555; margin-bottom: 14px; }

    .layout {
      width: 100%; max-width: 1100px; margin: 0 auto;
      display: grid; grid-template-columns: minmax(260px, 1fr) 420px; gap: 10px;
      align-items: start;
    }
    .table-section {
      background: var(--card); border: 2px solid var(--border); border-radius: 12px; padding: 12px;
    }
    .section-label { font-weight: 700; text-align: center; margin-bottom: 8px; }

    .skill-block { border: 1px solid #cfd7ef; border-radius: 12px; overflow: hidden; margin-bottom: 12px; background:#fff; }
    .skill-header { display:flex; align-items:center; justify-content:center; gap:10px; padding:10px; font-weight:700; cursor:pointer; user-select:none; }
    .skills-inner { display:flex; flex-wrap:wrap; justify-content:center; gap:8px; padding:12px; }
    .skills-inner.collapsed { display:none; }
    .bg-cvc .skill-header{background:var(--cvc)}
    .bg-dig .skill-header{background:var(--dig)}
    .bg-glued .skill-header{background:var(--glued)}
    .bg-vce .skill-header{background:var(--vce)}
    .bg-rctrl .skill-header{background:var(--rctrl)}
    .bg-vteams .skill-header{background:var(--vteams)}
    .bg-dip .skill-header{background:var(--dip)}
    .bg-variant .skill-header{background:var(--variant)}
    .bg-soft .skill-header{background:var(--soft)}

    .skill-button {
      border:2px solid #000; border-radius:14px; background:#fff; padding:8px 12px;
      font-weight:700; cursor:pointer; transition:transform .08s; min-height:36px;
    }
    .skill-button:active{ transform: translateY(1px); }
    .skill-button.selected { background:#1f365f; color:#fff; }

    .option-grid { display:flex; flex-direction:column; align-items:center; gap:8px; }
    .option-row { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    .option-box { border:2px solid #000; border-radius:12px; padding:8px 12px; font-weight:600; cursor:pointer; background:#fff; }
    .option-box.selected { background:#d0f0ff; }

    .chips-title { text-align:center; font-weight:700; margin-top: 6px; }
    .chips-wrap { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:6px; }
    .chip { background:var(--chip); border-radius:999px; padding:6px 10px; display:flex; align-items:center; gap:8px; }
    .chip .x { width:18px; height:18px; display:flex; align-items:center; justify-content:center; background:#e8edf2; border-radius:50%; cursor:pointer; color:var(--chip-x); font-weight:700; }

    #output { margin-top: 14px; }

    /* ===== Worksheet (ONE PAGE, PORTRAIT) ===== */
    .page {
      width: 8.5in; max-width: 100%;
      border: 2px solid #000; background:#fff; margin: 0 auto;
      padding: 0.5in; border-radius: 8px; page-break-inside: avoid; position: relative;
      box-shadow: 0 6px 20px rgba(0,0,0,.12);
    }
    .worksheet-title { font-size: 26px; font-weight: 700; text-align:center; margin-bottom: 6px; }
    .skills-line { font-size: 13px; text-align:center; margin-bottom: 8px; }
    .worksheet-directions { font-size: 14px; text-align:center; margin-bottom: 10px; }

    /* Grid frame sits inside safe printable area */
    .grid-wrap {
      width: 100%;
      /* Safe content box height so title + skills + directions + footer fit on ONE page */
      /* ~10.2in (printable height) - ~0.5in padding top/bottom - header text - footer */
      max-height: 8.6in;
      display: grid;
      align-items: stretch;
    }

    table.grid {
      width: 100%; border-collapse: collapse; table-layout: fixed;
      border: 2px solid #000;
    }
    .grid td {
      border: 1px solid #000;
      padding: 4px;
      text-align: center;
      vertical-align: middle;
      word-wrap: break-word;
      overflow-wrap: anywhere;
      line-height: 1.2;
    }
    /* Base (screen) font sizes; print will downscale a bit to guarantee fit */
    .cell-word { font-size: clamp(16px, 2.4vw, 24px); }
    .cell-sentence { font-size: clamp(12px, 1.8vw, 16px); text-align: left; }

    .meta-row {
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 8px;
      font-size: 12px;
    }
    .name-line { text-align:left; }
    .date-line { text-align:right; }

    #copyright { font-size: 11px; text-align: right; margin-top: 6px; display:block; }

    /* PRINT: lock to ONE portrait page with safe margins and sizes */
    @media print {
      @page { size: Letter portrait; margin: 0.4in; }

      body > h1, .subtitle, .layout, #floatingActions { display: none !important; }
      #output { margin: 0 !important; }

      .page {
        width: 7.7in !important;  /* 8.5in - (0.4in*2) = 7.7in content width */
        height: 10.2in !important; /* 11in - (0.4in*2) = 10.2in content height */
        padding: 0.35in !important;
        border: none !important; box-shadow: none !important;
      }

      .worksheet-title { font-size: 18px !important; margin-bottom: 0.08in !important; }
      .skills-line { font-size: 10px !important; margin-bottom: 0.06in !important; }
      .worksheet-directions { font-size: 11px !important; margin-bottom: 0.08in !important; }
      .meta-row { font-size: 10px !important; margin-bottom: 0.06in !important; }

      /* Tighten grid for print to guarantee one page */
      .grid td { padding: 3px !important; }
      .cell-word { font-size: 16px !important; }
      .cell-sentence { font-size: 12px !important; line-height: 1.15 !important; }

      #copyright { position: absolute; bottom: 0.25in; right: 0.35in; font-size: 9px !important; }
    }
  </style>
</head>
<body>
  <h1>Fluency Grid Generator</h1>
  <div class="subtitle">Step 1: skills → Step 2: blends → Step 3: words/sentences/both → Step 4: grid size → Generate a single-page fluency grid (portrait).</div>

  <div class="layout">
    <div class="left table-section">
      <div class="section-label">Step 1: Select Skills</div>

      <!-- CVC -->
      <div class="skill-block bg-cvc">
        <div class="skill-header" data-target="cvc"><span>▲</span><span>CVC Short Vowels</span><span>▲</span></div>
        <div class="skills-inner" id="section-cvc">
          <button class="skill-button" data-skill="Short A">Short A</button>
          <button class="skill-button" data-skill="Short E">Short E</button>
          <button class="skill-button" data-skill="Short I">Short I</button>
          <button class="skill-button" data-skill="Short O">Short O</button>
          <button class="skill-button" data-skill="Short U">Short U</button>
          <button class="skill-button" data-skill="Mixed CVC">Mixed CVC</button>
          <button class="skill-button" data-skill="FLSZ">FLSZ</button>
        </div>
      </div>

      <!-- Digraphs -->
      <div class="skill-block bg-dig">
        <div class="skill-header" data-target="dig"><span>▼</span><span>Digraphs</span><span>▼</span></div>
        <div class="skills-inner collapsed" id="section-dig">
          <button class="skill-button" data-skill="ck">ck</button>
          <button class="skill-button" data-skill="sh">sh</button>
          <button class="skill-button" data-skill="th">th</button>
          <button class="skill-button" data-skill="ch">ch</button>
          <button class="skill-button" data-skill="wh">wh</button>
          <button class="skill-button" data-skill="Digraphs Mixed">Digraphs Mixed</button>
        </div>
      </div>

      <!-- Glued -->
      <div class="skill-block bg-glued">
        <div class="skill-header" data-target="glued"><span>▼</span><span>Glued Sounds</span><span>▼</span></div>
        <div class="skills-inner collapsed" id="section-glued">
          <button class="skill-button" data-skill="-all">-all</button>
          <button class="skill-button" data-skill="-ng">-ng</button>
          <button class="skill-button" data-skill="-nk">-nk</button>
          <button class="skill-button" data-skill="Glued Mixed">Glued Mixed</button>
        </div>
      </div>

      <!-- VCe -->
      <div class="skill-block bg-vce">
        <div class="skill-header" data-target="vce"><span>▼</span><span>Silent E (VCe)</span><span>▼</span></div>
        <div class="skills-inner collapsed" id="section-vce">
          <button class="skill-button" data-skill="a_e">a_e</button>
          <button class="skill-button" data-skill="i_e">i_e</button>
          <button class="skill-button" data-skill="o_e">o_e</button>
          <button class="skill-button" data-skill="u_e">u_e</button>
          <button class="skill-button" data-skill="Mixed VCe">Mixed VCe</button>
        </div>
      </div>

      <!-- R-Controlled -->
      <div class="skill-block bg-rctrl">
        <div class="skill-header" data-target="rctrl"><span>▼</span><span>R-Controlled</span><span>▼</span></div>
        <div class="skills-inner collapsed" id="section-rctrl">
          <button class="skill-button" data-skill="ar">ar</button>
          <button class="skill-button" data-skill="or">or</button>
          <button class="skill-button" data-skill="er/ir/ur">er/ir/ur</button>
          <button class="skill-button" data-skill="Mixed R-Controlled">Mixed R-Controlled</button>
        </div>
      </div>

      <!-- Vowel Teams -->
      <div class="skill-block bg-vteams">
        <div class="skill-header" data-target="vteams"><span>▼</span><span>Vowel Teams</span><span>▼</span></div>
        <div class="skills-inner collapsed" id="section-vteams">
          <button class="skill-button" data-skill="Long A (ai/ay)">Long A (ai/ay)</button>
          <button class="skill-button" data-skill="Long E (ee/ea)">Long E (ee/ea)</button>
          <button class="skill-button" data-skill="Long I (igh/y/ie)">Long I (igh/y/ie)</button>
          <button class="skill-button" data-skill="Long O (oa/ow/oe)">Long O (oa/ow/oe)</button>
          <button class="skill-button" data-skill="Long U (oo/ew/ue)">Long U (oo/ew/ue)</button>
          <button class="skill-button" data-skill="Mixed Vowel Teams">Mixed Vowel Teams</button>
        </div>
      </div>

      <!-- Diphthongs / Variant / Soft -->
      <div class="skill-block bg-dip">
        <div class="skill-header" data-target="dip"><span>▼</span><span>Diphthongs</span><span>▼</span></div>
        <div class="skills-inner collapsed" id="section-dip">
          <button class="skill-button" data-skill="Diphthongs (oy/oi)">oy/oi</button>
          <button class="skill-button" data-skill="Diphthongs (ow/ou)">ow/ou</button>
        </div>
      </div>

      <div class="skill-block bg-variant">
        <div class="skill-header" data-target="variant"><span>▼</span><span>Variant Vowels</span><span>▼</span></div>
        <div class="skills-inner collapsed" id="section-variant">
          <button class="skill-button" data-skill="Variant Vowels (au/aw)">au/aw</button>
          <button class="skill-button" data-skill="Variant Vowel (oo)">oo</button>
        </div>
      </div>

      <div class="skill-block bg-soft">
        <div class="skill-header" data-target="soft"><span>▼</span><span>Soft C/G Endings</span><span>▼</span></div>
        <div class="skills-inner collapsed" id="section-soft">
          <button class="skill-button" data-skill="Soft C (-ce)">Soft C (-ce)</button>
          <button class="skill-button" data-skill="Soft G (-ge)">Soft G (-ge)</button>
          <button class="skill-button" data-skill="Soft G (-dge)">Soft G (-dge)</button>
        </div>
      </div>
    </div>

    <div class="right">
      <div class="table-section">
        <div class="section-label">Step 2: Include Blends?</div>
        <div class="option-grid" id="blendOptions">
          <div class="option-row">
            <div class="option-box" data-blends="no">No – 3 Sounds</div>
            <div class="option-box" data-blends="yes">Yes – 4+ Sounds</div>
          </div>
        </div>
      </div>

      <div class="table-section">
        <div class="section-label">Step 3: Grid Content</div>
        <div class="option-grid" id="contentOptions">
          <div class="option-row">
            <div class="option-box" data-mode="words">Words Only</div>
            <div class="option-box" data-mode="sentences">Sentences Only</div>
            <div class="option-box" data-mode="both">Both</div>
          </div>
        </div>
      </div>

      <div class="table-section">
        <div class="section-label">Step 4: Grid Size (columns × rows)</div>
        <div class="option-grid" id="gridSize">
          <div class="option-row">
            <div class="option-box" data-size="18" data-cols="6" data-rows="3">6 × 3 = 18</div>
            <div class="option-box" data-size="24" data-cols="6" data-rows="4">6 × 4 = 24</div>
            <div class="option-box selected" data-size="30" data-cols="6" data-rows="5">6 × 5 = 30</div>
          </div>
        </div>
      </div>

      <div class="table-section">
        <div class="section-label">Step 5: Generate & Print</div>
        <div class="chips-title">Skills Selected:</div>
        <div id="chips" class="chips-wrap"></div>
        <div style="text-align:center; margin-top:10px;">
          <button id="btnGenerate" style="font-size: 18px; padding: 10px 24px;">Generate</button>
          <button onclick="window.print()" style="font-size: 18px; padding: 10px 24px;">Print</button>
        </div>
      </div>
    </div>
  </div>

  <!-- OUTPUT -->
  <div id="output"></div>

  <!-- Optional floating actions (desktop) -->
  <div id="floatingActions" style="position: fixed; right: 16px; bottom: 16px; z-index: 1000; background:#ffffff; border:2px solid #000; border-radius:12px; box-shadow: 0 6px 20px rgba(0,0,0,.15); padding:10px 12px; display:none; gap:8px; align-items:center;">
    <button id="fabGenerate" style="font-size:14px; padding:8px 12px;">Generate</button>
    <button id="fabPrint" style="font-size:14px; padding:8px 12px;">Print</button>
  </div>

<script>
/* ===== Utilities ===== */
if (typeof CSS === 'undefined' || typeof CSS.escape !== 'function') {
  window.CSS = window.CSS || {};
  CSS.escape = CSS.escape || function(sel){ return (sel + '').replace(/[^a-zA-Z0-9_-]/g, '\\$&'); };
}
const A = x => (Array.isArray(x) ? x.slice() : (x == null ? [] : Array.from(x)));
function shuffle(arr){ const a=A(arr), n=a.length>>>0; for(let i=n-1;i>0;i--){const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]];} return a; }
function uniqueLower(arr){ const seen=new Set(); const out=[]; for(const v of A(arr)){ const k=String(v).toLowerCase(); if(!seen.has(k)){seen.add(k); out.push(v);} } return out; }
function fillToN(list, n){ const base=A(list); if(!base.length||!Number.isFinite(n)||n<=0) return []; const out=[]; let bag=shuffle(base); while(out.length<n){ if(!bag.length){ bag=shuffle(base); if(!bag.length) break; } out.push(bag.shift()); } return out.slice(0,n); }

/* ===== Data keys/mapping (same as your Roll & Read) ===== */
const PREFIX = {
  "Short A": "0.1 - Short A", "Short O": "0.2 - Short O", "Short I": "0.3 - Short I",
  "Short U": "0.4 - Short U", "Short E": "0.5 - Short E", "FLSZ": "0.6 - FLSZ",
  "ck":"1.1 - ck","sh":"1.2 - sh","th":"1.3 - th","ch":"1.4 - ch","wh":"1.5 - wh",
  "-all":"3.1 - all","-ng":"3.2 - ng","-nk":"3.3 - nk",
  "a_e":"2.1 - a_e","i_e":"2.2 - i_e","o_e":"2.3 - o_e","u_e":"2.4 - u_e",
  "ar":"4.1 - ar","or":"4.2 - or","er/ir/ur":"4.3 - er, ir, ur",
  "Soft C (-ce)":"10.1 - ce","Soft G (-ge)":"10.2 - ge","Soft G (-dge)":"10.3 - dge"
};
const MIXED_RULES = {
  "Mixed CVC":["0.1 - Short A","0.5 - Short E","0.3 - Short I","0.2 - Short O","0.4 - Short U","0.6 - FLSZ"],
  "Digraphs Mixed":["1.1 - ck","1.2 - sh","1.3 - th","1.4 - ch","1.5 - wh"],
  "Glued Mixed":["3.1 - all","3.2 - ng","3.3 - nk"],
  "Mixed VCe":["2.1 - a_e","2.2 - i_e","2.3 - o_e","2.4 - u_e"],
  "Mixed R-Controlled":["4.1 - ar","4.2 - or","4.3 - er, ir, ur"],
  "Long A (ai/ay)":["6.1 - ay","6.2 - ai"],
  "Long E (ee/ea)":["6.4 - ee","6.5 - ea"],
  "Long I (igh/y/ie)":["6.6 - igh","6.7 - Final y","6.8 - ie"],
  "Long O (oa/ow/oe)":["6.9 - oa","6.10 - ow","6.11 - oe"],
  "Long U (oo/ew/ue)":["6.12 - oo (long u)","6.13 - ew","6.14 - ue"],
  "Mixed Vowel Teams":["6.1 - ay","6.2 - ai","6.4 - ee","6.5 - ea","6.6 - igh","6.7 - Final y","6.8 - ie","6.9 - oa","6.10 - ow","6.11 - oe","6.12 - oo (long u)","6.13 - ew","6.14 - ue"],
  "Diphthongs (oy/oi)":["7.4 - oy","7.3 - oi"],
  "Diphthongs (ow/ou)":["7.2 - ow","7.1 - ou"],
  "Variant Vowels (au/aw)":["7.5 - aw","7.6 - au"],
  "Variant Vowel (oo)":["7.7 - oo variant"]
};
function wordsDict(){ return (typeof fluencyWords!=='undefined')?fluencyWords: (typeof fluencyData!=='undefined'?fluencyData.words:{}); }
function sentsDict(){ return (typeof fluencySentences!=='undefined')?fluencySentences: (typeof fluencyData!=='undefined'?fluencyData.sentences:{}); }
function readDict(dict,key){ return Array.isArray(dict[key])?dict[key]:[]; }

function readWithBlends(dict, prefix, type, blends){
  const t = type.toLowerCase();
  const baseKeys = [`${prefix} ${type}`, `${prefix} ${t}`, `${prefix}`];
  let base = [];
  for (const k of baseKeys) base = base.concat(readDict(dict,k));

  if (blends){
    const candidates = [
      `${prefix} with Blends ${type}`, `${prefix} with blends ${type}`,
      `${prefix} with Blends ${t}`, `${prefix} with blends ${t}`, `${prefix} with BLENDS ${type}`
    ];
    const bPrefix = prefix.replace(' - ', 'b - ');
    candidates.push(`${bPrefix} with Blends ${type}`, `${bPrefix} with blends ${type}`, `${bPrefix} with Blends ${t}`, `${bPrefix} with blends ${t}`);
    for (const k of candidates){
      const got = readDict(dict,k);
      if (got.length){
        return (got.length < 30) ? uniqueLower(got.concat(base)) : got;
      }
    }
  }
  return base;
}
function getList(label, type, blends){
  const dict = (type === 'Words') ? wordsDict() : sentsDict();
  if (Object.prototype.hasOwnProperty.call(MIXED_RULES,label)){
    let all=[]; for(const p of MIXED_RULES[label]) all=all.concat(readWithBlends(dict,p,type,blends)); return all;
  }
  const prefix = PREFIX[label];
  if (prefix) return readWithBlends(dict,prefix,type,blends);

  // Fallback fuzzy
  const want = label.toLowerCase(), tail1=" "+type, tail2=" "+type.toLowerCase();
  const keys = Object.keys(dict||{});
  const guess = keys.find(k=>k.toLowerCase().includes(want)&&(k.endsWith(tail1)||k.endsWith(tail2)));
  return guess?readDict(dict,guess):[];
}

/* ===== Selections ===== */
const selected = new Set();
let includeBlends = false;
let mode = null;
let gridSize = 30, gridCols = 6, gridRows = 5;

document.querySelectorAll('.skill-header').forEach(h=>{
  h.addEventListener('click', ()=>{
    const id = 'section-' + h.getAttribute('data-target');
    const inner = document.getElementById(id);
    const collapsed = inner.classList.contains('collapsed');
    inner.classList.toggle('collapsed', !collapsed);
    h.querySelectorAll('span')[0].textContent = collapsed? '▲' : '▼';
    h.querySelectorAll('span')[2].textContent = collapsed? '▲' : '▼';
  });
});
document.querySelectorAll('.skill-button').forEach(btn=>{
  btn.addEventListener('click', (e)=>{
    e.stopPropagation();
    const label = btn.dataset.skill;
    if (selected.has(label)){ selected.delete(label); btn.classList.remove('selected'); }
    else { selected.add(label); btn.classList.add('selected'); }
    renderChips();
  });
});
function renderChips(){
  const wrap = document.getElementById('chips'); wrap.innerHTML='';
  Array.from(selected).forEach(label=>{
    const c=document.createElement('div'); c.className='chip';
    c.innerHTML = `<span>${label}</span><span class="x" title="Remove">&times;</span>`;
    c.querySelector('.x').addEventListener('click', ()=>{
      selected.delete(label);
      const b=document.querySelector(`.skill-button[data-skill="${CSS.escape(label)}"]`);
      if (b) b.classList.remove('selected');
      renderChips();
    });
    wrap.appendChild(c);
  });
}
document.querySelectorAll('#blendOptions .option-box').forEach(box=>{
  box.addEventListener('click', ()=>{
    document.querySelectorAll('#blendOptions .option-box').forEach(b=>b.classList.remove('selected'));
    box.classList.add('selected');
    includeBlends = (box.dataset.blends === 'yes');
  });
});
document.querySelectorAll('#contentOptions .option-box').forEach(box=>{
  box.addEventListener('click', ()=>{
    document.querySelectorAll('#contentOptions .option-box').forEach(b=>b.classList.remove('selected'));
    box.classList.add('selected');
    mode = box.dataset.mode;
  });
});
document.querySelectorAll('#gridSize .option-box').forEach(box=>{
  box.addEventListener('click', ()=>{
    document.querySelectorAll('#gridSize .option-box').forEach(b=>b.classList.remove('selected'));
    box.classList.add('selected');
    gridSize = parseInt(box.dataset.size,10);
    gridCols = parseInt(box.dataset.cols,10);
    gridRows = parseInt(box.dataset.rows,10);
  });
});

/* Floating actions on desktop */
function toggleFab(){
  const el=document.getElementById('floatingActions');
  el.style.display = window.matchMedia('(min-width: 992px)').matches ? 'flex' : 'none';
}
toggleFab(); window.addEventListener('resize', toggleFab);
document.getElementById('fabGenerate')?.addEventListener('click', ()=>document.getElementById('btnGenerate')?.click());
document.getElementById('fabPrint')?.addEventListener('click', ()=>window.print());

/* ===== GRID BUILDER ===== */
function buildGridTable(items, cols, rows){
  const tbl = document.createElement('table'); tbl.className='grid';
  let idx=0;
  for (let r=0;r<rows;r++){
    const tr = document.createElement('tr');
    for (let c=0;c<cols;c++){
      const td = document.createElement('td');
      const val = items[idx++] || '';
      const isSentence = (val.indexOf(' ') !== -1);
      td.className = isSentence ? 'cell-sentence' : 'cell-word';
      td.textContent = val;
      tr.appendChild(td);
    }
    tbl.appendChild(tr);
  }
  return tbl;
}

function generateFluencyPage(){
  if (selected.size===0) return alert('Select at least one skill (Step 1).');
  if (!mode) return alert('Choose Words Only / Sentences Only / Both (Step 3).');
  if (!wordsDict() && !sentsDict()) return alert('Data not loaded. Check the data <script> tag.');

  const labels = Array.from(selected);
  const TOTAL = gridCols * gridRows;
  let pool = [];

  if (mode==='words'){
    const W = labels.flatMap(lbl=>getList(lbl,'Words',includeBlends));
    pool = uniqueLower(W);
  } else if (mode==='sentences'){
    const S = labels.flatMap(lbl=>getList(lbl,'Sentences',includeBlends));
    pool = uniqueLower(S);
  } else {
    const W = uniqueLower(labels.flatMap(lbl=>getList(lbl,'Words',includeBlends)));
    const S = uniqueLower(labels.flatMap(lbl=>getList(lbl,'Sentences',includeBlends)));
    const half = Math.floor(TOTAL/2);
    const takeW = fillToN(shuffle(W), half);
    const takeS = fillToN(shuffle(S), TOTAL - takeW.length);
    pool = shuffle(takeW.concat(takeS));
  }

  let content = (mode==='both') ? pool : fillToN(shuffle(pool), TOTAL);
  if (content.length < TOTAL) return alert('Not enough content for these settings. Add more skills or change options.');
  content = content.slice(0, TOTAL);

  /* Build single-page worksheet */
  const out = document.getElementById('output'); out.innerHTML='';
  const page = document.createElement('div'); page.className='page';

  const meta = document.createElement('div'); meta.className='meta-row';
  meta.innerHTML = `<div class="name-line"><strong>Name:</strong> ______________________</div>
                    <div class="date-line"><strong>Date:</strong> _____________</div>`;
  const title = document.createElement('div'); title.className='worksheet-title'; title.textContent='Fluency Grid';
  const skills = document.createElement('div'); skills.className='skills-line';
  skills.innerHTML = '<strong>Skills:</strong> ' + (labels.length ? labels.join(' • ') : '—');
  const dir = document.createElement('div'); dir.className='worksheet-directions';
  dir.innerHTML = (mode==='words')
    ? '<strong>Directions:</strong> Read each word. Try to read the whole grid!'
    : (mode==='sentences')
      ? '<strong>Directions:</strong> Read each sentence smoothly and with expression.'
      : '<strong>Directions:</strong> Read each item. Words and sentences are mixed.';

  const wrap = document.createElement('div'); wrap.className='grid-wrap';
  const tbl = buildGridTable(content, gridCols, gridRows);

  const copy = document.createElement('div'); copy.id='copyright';
  copy.textContent = 'Copyright - InterventionStation.com - @TeachwithMrC';

  wrap.appendChild(tbl);
  page.appendChild(meta);
  page.appendChild(title);
  page.appendChild(skills);
  page.appendChild(dir);
  page.appendChild(wrap);
  page.appendChild(copy);
  out.appendChild(page);
  out.scrollIntoView({behavior:'smooth', block:'start'});
}

document.getElementById('btnGenerate').addEventListener('click', generateFluencyPage);
</script>
</body>
</html>
