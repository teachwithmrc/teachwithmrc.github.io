<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ultimate Math Printables Hub</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink: #1f2c3a;
      --bg1: #eef8ff;
      --bg2: #f4fff3;
      --card: #ffffff;
      --accent: #1565c0;
      --accent-soft: #e8f2ff;
      --line: #cfdae6;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 18px;
      font-family: "Poppins", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 14% 10%, #ffffff 0 8%, transparent 9%),
        radial-gradient(circle at 88% 10%, #ffffff 0 7%, transparent 8%),
        linear-gradient(145deg, var(--bg1), var(--bg2));
    }

    .app { max-width: 1150px; margin: 0 auto; }

    h1 {
      margin: 0 0 8px;
      text-align: center;
      font-size: 2rem;
    }

    .subtitle {
      text-align: center;
      margin: 0 0 14px;
      color: #415668;
      font-size: 0.96rem;
    }

    .panel {
      border: 2px solid #000;
      border-radius: 14px;
      background: #fff;
      padding: 12px;
      box-shadow: 0 8px 18px rgba(24, 50, 76, 0.08);
      margin-bottom: 12px;
    }

    .welcome {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .welcome-card {
      border: 2px solid #000;
      border-radius: 12px;
      padding: 14px;
      text-align: center;
      background: #f9fcff;
    }

    .welcome-card h2 {
      margin: 0 0 6px;
      font-size: 1.15rem;
    }

    .welcome-card p {
      margin: 0 0 10px;
      font-size: 0.92rem;
      color: #405368;
    }

    .controls { display: grid; gap: 10px; }

    .row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 8px 10px;
    }

    .label {
      font-weight: 700;
      font-size: 0.93rem;
    }

    .pill {
      border: 2px solid #000;
      border-radius: 999px;
      background: #fff;
      padding: 8px 11px;
      font-weight: 700;
      cursor: pointer;
      font-size: 0.9rem;
      line-height: 1;
      user-select: none;
    }

    .pill.selected {
      background: var(--accent-soft);
      color: #083d7a;
      border-color: #083d7a;
    }

    .select-wrap {
      border: 2px solid #000;
      border-radius: 999px;
      padding: 4px 10px;
      background: #fff;
      display: inline-flex;
      align-items: center;
    }

    select, input[type="number"] {
      border: none;
      background: transparent;
      font: inherit;
      outline: none;
      min-width: 140px;
      padding: 4px 0;
    }

    input[type="number"] { width: 90px; min-width: 90px; }

    button {
      border: 2px solid #000;
      border-radius: 10px;
      background: #fff;
      font: inherit;
      font-weight: 700;
      padding: 9px 14px;
      cursor: pointer;
    }

    .primary { background: #e8f3ff; color: #113a62; }

    #builderPanel { display: none; }

    #output { display: grid; gap: 12px; }

    .sheet {
      background: #fff;
      border: 2px solid #000;
      border-radius: 10px;
      padding: 12px;
      page-break-inside: avoid;
      break-inside: avoid;
    }

    .sheet.ttt-four {
      padding: 10px;
    }

    .sheet-title {
      text-align: center;
      font-size: 1.3rem;
      font-weight: 800;
      margin-bottom: 4px;
    }

    .sheet-meta {
      text-align: center;
      margin-bottom: 8px;
      font-size: 0.86rem;
      color: #3f4f5e;
    }

    .ttt-four-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .mini-game {
      border: 1px solid #111;
      border-radius: 10px;
      padding: 8px;
      background: #fff;
    }

    .mini-title {
      text-align: center;
      font-size: 0.8rem;
      font-weight: 800;
      margin-bottom: 5px;
      color: #111;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .ttt-board {
      table-layout: fixed;
      border-collapse: separate;
      border-spacing: 0;
      width: min(340px, 100%);
      height: 340px;
      margin: 0 auto;
      background: #fff;
    }

    .ttt-board.small {
      width: min(250px, 100%);
      height: 250px;
    }

    .ttt-board td {
      border: none;
      width: 33.33%;
      height: 33.33%;
      padding: 0;
      vertical-align: middle;
      overflow: hidden;
      position: relative;
    }

    .ttt-board td.has-bottom { border-bottom: 5px solid #000; }
    .ttt-board td.has-right { border-right: 5px solid #000; }

    .ttt-cell-inner {
      width: 100%;
      height: 100%;
      display: grid;
      place-items: center;
      padding: 5px;
      overflow: hidden;
      text-align: center;
      box-sizing: border-box;
    }

    .ttt-board.small .ttt-cell-inner {
      padding: 3px;
    }

    .prompt-wrap {
      text-align: center;
      display: grid;
      place-items: center;
      gap: 4px;
    }

    .prompt-math {
      font-size: 1.35rem;
      font-weight: 700;
      line-height: 1.08;
    }

    .ttt-board.small .prompt-math { font-size: 1.03rem; }

    .stack-problem {
      display: inline-grid;
      justify-items: end;
      gap: 1px;
      min-width: 7ch;
      font-family: "Courier New", monospace;
      line-height: 1;
    }

    .stack-line {
      width: 100%;
      text-align: right;
      font-size: 1.42rem;
      font-weight: 700;
      display: flex;
      justify-content: flex-end;
      gap: 0.22em;
      white-space: nowrap;
    }

    .ttt-board.small .stack-line { font-size: 1.1rem; }

    .stack-line .op {
      width: 1ch;
      text-align: center;
      font-weight: 700;
    }

    .stack-bar {
      width: 100%;
      border-top: 2px solid #27394d;
      margin-top: 1px;
    }

    .counting-dir {
      font-size: 0.8rem;
      font-weight: 700;
      color: #3a526a;
      text-transform: uppercase;
    }

    .counting-line {
      font-size: 1.16rem;
      font-weight: 700;
      line-height: 1.12;
    }

    .missing-token {
      font-family: "Courier New", monospace;
      letter-spacing: 0;
      white-space: nowrap;
    }

    .ttt-board.small .counting-line { font-size: 0.96rem; }

    .rounding-line {
      font-size: 1.02rem;
      font-weight: 700;
      line-height: 1.15;
      text-align: center;
    }

    .under {
      text-decoration: underline;
      text-decoration-thickness: 3px;
      text-underline-offset: 2px;
      text-decoration-skip-ink: none;
    }

    .numline-wrap {
      width: min(250px, 100%);
      margin: 3px auto 0;
      display: grid;
      gap: 2px;
    }

    .numline-track {
      position: relative;
      height: 10px;
      border-top: 2px solid #24384f;
      margin-top: 8px;
    }

    .numline-end {
      position: absolute;
      top: -7px;
      width: 2px;
      height: 12px;
      background: #24384f;
    }

    .numline-end.left { left: 0; }
    .numline-end.right { right: 0; }

    .numline-marker {
      position: absolute;
      top: -11px;
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: #e53935;
      transform: translateX(-50%);
    }

    .numline-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.78rem;
      font-weight: 800;
      color: #32495f;
      margin-top: 2px;
    }

    .numline-target {
      text-align: center;
      font-size: 0.76rem;
      font-weight: 700;
      color: #41586e;
      margin-top: 1px;
    }

    .tenframe-group {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
    }

    .tenframe {
      border: 2px solid #111;
      border-radius: 2px;
      background: #fff;
      overflow: hidden;
    }

    .tfgrid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
    }

    .tfcell {
      border: 2px solid #111;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding-top: 1px;
      position: relative;
      background: #fff;
    }

    .tfdot {
      width: 76%;
      height: 76%;
      border-radius: 50%;
      background: #111;
      display: block;
      margin-top: 1px;
    }

    .coin-prompt {
      display: grid;
      justify-items: center;
      gap: 4px;
    }

    .coin-strip {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
      align-items: flex-start;
    }

    .coin-strip.coin-grid {
      display: grid;
      grid-template-columns: repeat(var(--coin-cols, 2), max-content);
      justify-content: center;
      align-content: center;
      align-items: start;
      gap: 6px 8px;
    }

    .coin-face {
      position: relative;
      width: var(--coin-size, 54px);
      height: var(--coin-size, 54px);
      border-radius: 50%;
      flex: 0 0 auto;
    }

    .coin-face img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 50%;
      display: block;
    }

    .coin-dot {
      position: absolute;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      border: 1px solid #5c4e24;
      background: #ffe27a;
      color: #2d2818;
      font-size: 0.5rem;
      font-weight: 800;
      display: grid;
      place-items: center;
      z-index: 2;
    }

    .coin-dot.star {
      border-color: #7f4e80;
      background: #ffe8f7;
      color: #7a1d67;
      font-size: 0.63rem;
      font-weight: 900;
    }

    .roll-table {
      width: min(940px, 100%);
      margin: 0 auto;
      border-collapse: collapse;
      table-layout: fixed;
    }

    .roll-table td {
      border: 1px solid #000;
      width: calc(100% / 6);
      height: 82px;
      text-align: center;
      vertical-align: middle;
      padding: 4px;
      overflow: hidden;
    }

    .roll-table .dice-cell { height: 88px; background: #fbfdff; }

    .roll-table .dice-cell img {
      width: 50px;
      height: 50px;
      object-fit: contain;
    }

    .roll-table .prompt-math { font-size: 1.2rem; }
    .roll-table .stack-line { font-size: 1.12rem; }

    .copy {
      margin-top: 8px;
      font-size: 0.72rem;
      text-align: right;
      color: #435b71;
      font-weight: 700;
    }

    @media (max-width: 980px) {
      .welcome { grid-template-columns: 1fr; }
      .prompt-math { font-size: 1.25rem; }
      .stack-line { font-size: 1.3rem; }
      .roll-table td { height: 72px; }
      .ttt-four-grid { grid-template-columns: 1fr; }
    }

    @media print {
      @page { size: letter landscape; margin: 0.35in; }

      body { background: #fff !important; padding: 0 !important; }
      #welcomePanel,
      #builderPanel,
      .subtitle { display: none !important; }
      #output {
        display: block !important;
      }

      .sheet {
        display: block !important;
        width: 100% !important;
        max-width: none !important;
        margin: 0 !important;
        border: none !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        padding: 0.12in 0.18in !important;
        page-break-before: always;
        break-before: page;
        page-break-after: always;
        break-after: page;
        page-break-inside: avoid !important;
        break-inside: avoid-page !important;
        overflow: visible !important;
      }

      .sheet:first-child {
        page-break-before: auto;
        break-before: auto;
      }

      .sheet:last-child {
        page-break-after: auto;
        break-after: auto;
      }

      .sheet-title { font-size: 16px !important; margin-bottom: 2px !important; }
      .sheet-meta { font-size: 10px !important; margin-bottom: 6px !important; }
      .prompt-math { font-size: 19px !important; }
      .stack-line { font-size: 18px !important; }
      .roll-table td { height: 64px !important; }
      .roll-table .dice-cell img { width: 40px !important; height: 40px !important; }
      .ttt-four-grid { gap: 8px !important; }
      .ttt-board { width: 3.08in !important; height: 3.08in !important; }
      .ttt-board.small { width: 2.24in !important; height: 2.24in !important; }
      .ttt-board.small .prompt-math { font-size: 15px !important; }
      .ttt-board.small .stack-line { font-size: 15px !important; }
      .ttt-board.small .coin-face { width: 40px !important; height: 40px !important; }
      .ttt-board.small .coin-dot { width: 10px !important; height: 10px !important; font-size: 6px !important; }
      .ttt-board.small .tfcell { width: 15px !important; height: 15px !important; border-width: 1.5px !important; }
      .ttt-board .tfcell { width: 18px !important; height: 18px !important; }
      .numline-wrap { width: 190px !important; }
      .coin-face { width: 46px !important; height: 46px !important; }
      .coin-dot { width: 11px !important; height: 11px !important; font-size: 6px !important; }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Ultimate Math Generator</h1>
    <p class="subtitle">Welcome. Choose online play or printable worksheet creation.</p>

    <section id="welcomePanel" class="panel">
      <div class="welcome">
        <article class="welcome-card">
          <h2>Online Play</h2>
          <p>Interactive Tic Tac Toe and Roll/Read with optional answer checks.</p>
          <button id="btnGoOnline" class="primary" type="button">Open Online Play</button>
        </article>
        <article class="welcome-card">
          <h2>Make Printables</h2>
          <p>Generate multiple worksheet pages at once for Tic Tac Toe or Roll/Read.</p>
          <button id="btnGoPrintables" class="primary" type="button">Open Printable Builder</button>
        </article>
      </div>
    </section>

    <section id="builderPanel" class="panel">
      <div class="controls">
        <div class="row">
          <button id="btnBackWelcome" type="button">Back To Welcome</button>
        </div>

        <div class="row" id="gameTypeRow">
          <span class="label">Game Type:</span>
          <button type="button" class="pill selected" data-game-type="tictactoe">Tic Tac Toe</button>
          <button type="button" class="pill" data-game-type="rollread">Roll and Read</button>
        </div>

        <div class="row" id="operationRow">
          <span class="label">Skill:</span>
          <button type="button" class="pill selected" data-operation="coins">Coins</button>
          <button type="button" class="pill" data-operation="addition">Addition</button>
          <button type="button" class="pill" data-operation="subtraction">Subtraction</button>
          <button type="button" class="pill" data-operation="multiplication">Multiplication</button>
          <button type="button" class="pill" data-operation="division">Division</button>
          <button type="button" class="pill" data-operation="rounding">Rounding</button>
          <button type="button" class="pill" data-operation="counting">Counting</button>
          <button type="button" class="pill" data-operation="tenframes">Ten Frames</button>
        </div>

        <div class="row">
          <span class="label" id="difficultyText">Difficulty:</span>
          <div class="select-wrap" id="difficultySelectWrap"><select id="difficultySelect"></select></div>

          <span class="label">Copies:</span>
          <div class="select-wrap"><input id="copiesInput" type="number" min="1" max="12" value="4" /></div>

          <span class="label">Roll Grid:</span>
          <div class="select-wrap">
            <select id="gridSizeSelect">
              <option value="18">18 cells</option>
              <option value="24" selected>24 cells</option>
              <option value="30">30 cells</option>
            </select>
          </div>
        </div>

        <div class="row" id="regroupRow">
          <span class="label">Regrouping (Add/Sub):</span>
          <div class="select-wrap">
            <select id="regroupSelect">
              <option value="mixed">Mixed</option>
              <option value="with">With Regrouping</option>
              <option value="none">No Regrouping</option>
            </select>
          </div>
        </div>

        <div class="row" id="roundingRow">
          <span class="label">Rounding View:</span>
          <div class="select-wrap">
            <select id="roundingStyleSelect">
              <option value="standard">Standard</option>
              <option value="numberline">With Number Line</option>
            </select>
          </div>
          <span class="label">Nearest:</span>
          <div class="select-wrap">
            <select id="roundingNearestSelect">
              <option value="10">10</option>
              <option value="100">100</option>
              <option value="1000">1,000</option>
              <option value="10000">10,000</option>
            </select>
          </div>
          <span class="label">Numbers Up To:</span>
          <div class="select-wrap">
            <select id="roundingWithinSelect">
              <option value="100">100</option>
              <option value="1000">1,000</option>
              <option value="10000">10,000</option>
              <option value="100000">100,000</option>
            </select>
          </div>
        </div>

        <div class="row" id="countingRow">
          <span class="label">Counting Type:</span>
          <div class="select-wrap">
            <select id="countingStyleSelect">
              <option value="mixed">Mixed</option>
              <option value="forward">Count Forward</option>
              <option value="backward">Count Backward</option>
              <option value="missing">Missing Number</option>
            </select>
          </div>
        </div>

        <div class="row">
          <button id="btnGenerate" class="primary" type="button">Generate Printables</button>
          <button id="btnPrint" type="button">Print</button>
        </div>
      </div>
    </section>

    <div id="output"></div>
  </div>

  <script>
    const COIN_DEFS = {
      quarter: {
        key: "quarter",
        label: "Quarter",
        value: 25,
        ratio: 1.35,
        chunkValues: [5, 5, 5, 5, 5],
        img: "https://storage.googleapis.com/msgsndr/F9vnmU5R8sOuTGoxp5by/media/698d1f7f715cda9ca3b4afc8.png"
      },
      dime: {
        key: "dime",
        label: "Dime",
        value: 10,
        ratio: 1,
        chunkValues: [5, 5],
        img: "https://storage.googleapis.com/msgsndr/F9vnmU5R8sOuTGoxp5by/media/698d1f7f7213971802a4d866.png"
      },
      nickel: {
        key: "nickel",
        label: "Nickel",
        value: 5,
        ratio: 1.18,
        chunkValues: [5],
        img: "https://storage.googleapis.com/msgsndr/F9vnmU5R8sOuTGoxp5by/media/698d1f7f30ec4a3836469e61.png"
      },
      penny: {
        key: "penny",
        label: "Penny",
        value: 1,
        ratio: 1.06,
        chunkValues: [1],
        img: "https://storage.googleapis.com/msgsndr/F9vnmU5R8sOuTGoxp5by/media/698d1f7f3fdd0e810fca84ef.png"
      }
    };

    const COIN_ORDER = ["quarter", "dime", "nickel", "penny"];

    const DOT_POSITIONS = {
      1: [{ x: 50, y: 50 }],
      2: [{ x: 34, y: 50 }, { x: 66, y: 50 }],
      5: [
        { x: 50, y: 23 },
        { x: 72, y: 40 },
        { x: 64, y: 68 },
        { x: 36, y: 68 },
        { x: 28, y: 40 }
      ]
    };

    const DIFFICULTY_BY_OPERATION = {
      coins: [
        { value: "single", label: "Single digit totals (up to 35c)" },
        { value: "double", label: "Double digit totals (up to 99c)" },
        { value: "multi", label: "Multi digit totals (up to 250c)" }
      ],
      addition: [
        { value: "single", label: "Single digit" },
        { value: "double", label: "2-digit" },
        { value: "multi", label: "3-digit" }
      ],
      subtraction: [
        { value: "single", label: "Single digit" },
        { value: "double", label: "2-digit" },
        { value: "multi", label: "3-digit" }
      ],
      multiplication: [
        { value: "single", label: "1-digit by 1-digit" },
        { value: "double", label: "2-digit by 1-digit" },
        { value: "multi", label: "3-digit by 1-digit" }
      ],
      division: [
        { value: "single", label: "1-digit by 1-digit facts" },
        { value: "double", label: "2-digit by 1-digit" },
        { value: "multi", label: "3-digit by 1-digit" }
      ],
      rounding: [
        { value: "single", label: "Round 2-digit to nearest 10" },
        { value: "double", label: "Round 3-digit to nearest 100" },
        { value: "multi", label: "Round 4-digit to nearest 1000" }
      ],
      counting: [
        { value: "single", label: "Within 20" },
        { value: "double", label: "Within 50" },
        { value: "multi", label: "Within 100" }
      ],
      tenframes: [
        { value: "single", label: "Up to 10" },
        { value: "double", label: "Up to 20" },
        { value: "multi", label: "Up to 40" }
      ]
    };

    let promptIdCounter = 1;
    const ROUNDING_WITHIN_OPTIONS = [100, 1000, 10000, 100000];

    const state = {
      gameType: "tictactoe",
      operation: "coins",
      difficulty: "single",
      regroupMode: "mixed",
      roundingStyle: "standard",
      roundingNearest: 10,
      roundingWithin: 100,
      countingStyle: "mixed",
      copies: 4,
      gridSize: 24
    };

    const difficultyTextEl = document.getElementById("difficultyText");
    const difficultySelectWrapEl = document.getElementById("difficultySelectWrap");
    const difficultySelect = document.getElementById("difficultySelect");
    const regroupSelect = document.getElementById("regroupSelect");
    const regroupRow = document.getElementById("regroupRow");
    const roundingStyleSelect = document.getElementById("roundingStyleSelect");
    const roundingNearestSelect = document.getElementById("roundingNearestSelect");
    const roundingWithinSelect = document.getElementById("roundingWithinSelect");
    const roundingRow = document.getElementById("roundingRow");
    const countingStyleSelect = document.getElementById("countingStyleSelect");
    const countingRow = document.getElementById("countingRow");
    const gridSizeSelect = document.getElementById("gridSizeSelect");
    const copiesInput = document.getElementById("copiesInput");
    const outputEl = document.getElementById("output");

    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function choose(arr) {
      return arr[randInt(0, arr.length - 1)];
    }

    function formatNumber(value) {
      return Number(value).toLocaleString("en-US");
    }

    function htmlEscape(value) {
      return String(value)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function nextPromptId() {
      const id = "p" + String(promptIdCounter);
      promptIdCounter += 1;
      return id;
    }

    function setSelectedInRow(rowId, attr, value) {
      const row = document.getElementById(rowId);
      row.querySelectorAll(".pill").forEach((pill) => {
        pill.classList.toggle("selected", pill.getAttribute(attr) === value);
      });
    }

    function updateDifficultyOptions() {
      const options = DIFFICULTY_BY_OPERATION[state.operation] || [];
      const previous = state.difficulty;
      difficultySelect.innerHTML = "";
      options.forEach((opt) => {
        const option = document.createElement("option");
        option.value = opt.value;
        option.textContent = opt.label;
        difficultySelect.appendChild(option);
      });
      const exists = options.some((x) => x.value === previous);
      state.difficulty = exists ? previous : (options[0] ? options[0].value : "single");
      difficultySelect.value = state.difficulty;
    }

    function updateRegroupVisibility() {
      regroupRow.style.display = (state.operation === "addition" || state.operation === "subtraction") ? "flex" : "none";
      roundingRow.style.display = state.operation === "rounding" ? "flex" : "none";
      countingRow.style.display = state.operation === "counting" ? "flex" : "none";
      const hideDifficulty = state.operation === "rounding";
      difficultyTextEl.style.display = hideDifficulty ? "none" : "";
      difficultySelectWrapEl.style.display = hideDifficulty ? "none" : "inline-flex";
    }

    function operationLabel() {
      if (state.operation === "coins") return "Coins";
      if (state.operation === "addition") return "Addition";
      if (state.operation === "subtraction") return "Subtraction";
      if (state.operation === "multiplication") return "Multiplication";
      if (state.operation === "division") return "Division";
      if (state.operation === "rounding") return "Rounding";
      if (state.operation === "counting") return "Counting";
      return "Ten Frames";
    }

    function difficultyLabel() {
      if (state.operation === "rounding") {
        return `Nearest ${formatNumber(state.roundingNearest)} | Up To ${formatNumber(state.roundingWithin)}`;
      }
      const list = DIFFICULTY_BY_OPERATION[state.operation] || [];
      const item = list.find((x) => x.value === state.difficulty);
      return item ? item.label : state.difficulty;
    }

    function enforceRoundingWithin() {
      const minWithin = state.roundingNearest * 10;
      if (state.roundingWithin < minWithin) {
        state.roundingWithin = ROUNDING_WITHIN_OPTIONS.find((value) => value >= minWithin) || 100000;
      }
      roundingNearestSelect.value = String(state.roundingNearest);
      roundingWithinSelect.value = String(state.roundingWithin);
    }

    function rangeByDifficulty() {
      if (state.difficulty === "single") return { min: 0, max: 9 };
      if (state.difficulty === "double") return { min: 10, max: 99 };
      return { min: 100, max: 999 };
    }

    function digitsForDifficulty() {
      if (state.difficulty === "single") return 1;
      if (state.difficulty === "double") return 2;
      return 3;
    }

    function hasAdditionRegroup(a, b, digits) {
      let carry = 0;
      for (let i = 0; i < digits; i += 1) {
        const da = Math.floor(a / (10 ** i)) % 10;
        const db = Math.floor(b / (10 ** i)) % 10;
        const sum = da + db + carry;
        if (sum >= 10) return true;
        carry = sum >= 10 ? 1 : 0;
      }
      return false;
    }

    function hasSubtractionRegroup(a, b, digits) {
      let borrow = 0;
      for (let i = 0; i < digits; i += 1) {
        const da = (Math.floor(a / (10 ** i)) % 10) - borrow;
        const db = Math.floor(b / (10 ** i)) % 10;
        if (da < db) return true;
        borrow = 0;
      }
      return false;
    }

    function matchesRegroupMode(hasRegroup) {
      if (state.regroupMode === "mixed") return true;
      if (state.regroupMode === "with") return hasRegroup;
      return !hasRegroup;
    }

    function coinConfig() {
      if (state.difficulty === "single") {
        return { maxTotal: 35, minCoins: 2, maxCoins: 4, allowed: ["penny", "nickel", "dime"] };
      }
      if (state.difficulty === "double") {
        return { maxTotal: 99, minCoins: 3, maxCoins: 6, allowed: ["penny", "nickel", "dime", "quarter"] };
      }
      return { maxTotal: 250, minCoins: 4, maxCoins: 9, allowed: ["penny", "nickel", "dime", "quarter"] };
    }

    function makeCoinPrompt() {
      const cfg = coinConfig();
      let picks = [];
      let total = 0;
      const coinCount = randInt(cfg.minCoins, cfg.maxCoins);

      for (let tries = 0; tries < 420; tries += 1) {
        picks = [];
        for (let i = 0; i < coinCount; i += 1) picks.push(COIN_DEFS[choose(cfg.allowed)]);
        total = picks.reduce((sum, coin) => sum + coin.value, 0);
        if (total > 0 && total <= cfg.maxTotal) break;
      }

      picks = picks.slice().sort((a, b) => {
        if (b.value !== a.value) return b.value - a.value;
        return COIN_ORDER.indexOf(a.key) - COIN_ORDER.indexOf(b.key);
      });

      return {
        id: nextPromptId(),
        kind: "coins",
        answer: total,
        coins: picks.map((coin) => ({
          key: coin.key,
          label: coin.label,
          value: coin.value,
          ratio: coin.ratio,
          img: coin.img,
          chunkValues: coin.chunkValues.slice()
        }))
      };
    }

    function makeAdditionPrompt() {
      const r = rangeByDifficulty();
      const digits = digitsForDifficulty();
      let a = 0;
      let b = 0;
      let found = false;
      for (let tries = 0; tries < 1200; tries += 1) {
        const minValue = digits === 1 ? 0 : r.min;
        a = randInt(minValue, r.max);
        b = randInt(minValue, r.max);
        if (matchesRegroupMode(hasAdditionRegroup(a, b, digits))) {
          found = true;
          break;
        }
      }
      if (!found) {
        a = randInt(digits === 1 ? 0 : r.min, r.max);
        b = randInt(digits === 1 ? 0 : r.min, r.max);
      }
      return {
        id: nextPromptId(),
        kind: "math",
        answer: a + b,
        plain: `${a} + ${b}`,
        htmlMath: `${formatNumber(a)} + ${formatNumber(b)}`
      };
    }

    function makeSubtractionPrompt() {
      const r = rangeByDifficulty();
      const digits = digitsForDifficulty();
      let a = 0;
      let b = 0;
      let found = false;
      for (let tries = 0; tries < 1600; tries += 1) {
        const minValue = digits === 1 ? 0 : r.min;
        a = randInt(minValue, r.max);
        b = randInt(minValue, r.max);
        if (b > a) {
          const t = a;
          a = b;
          b = t;
        }
        if (matchesRegroupMode(hasSubtractionRegroup(a, b, digits))) {
          found = true;
          break;
        }
      }
      if (!found) {
        a = randInt(digits === 1 ? 0 : r.min, r.max);
        b = randInt(digits === 1 ? 0 : r.min, r.max);
        if (b > a) {
          const t = a;
          a = b;
          b = t;
        }
      }
      return {
        id: nextPromptId(),
        kind: "math",
        answer: a - b,
        plain: `${a} - ${b}`,
        htmlMath: `${formatNumber(a)} - ${formatNumber(b)}`
      };
    }

    function makeMultiplicationPrompt() {
      let a;
      let b;
      if (state.difficulty === "single") {
        a = randInt(2, 12);
        b = randInt(2, 12);
      } else if (state.difficulty === "double") {
        a = randInt(10, 99);
        b = randInt(2, 9);
      } else {
        a = randInt(100, 999);
        b = randInt(2, 9);
      }
      return {
        id: nextPromptId(),
        kind: "math",
        answer: a * b,
        plain: `${a} x ${b}`,
        htmlMath: `${formatNumber(a)} x ${formatNumber(b)}`
      };
    }

    function makeDivisionPrompt() {
      let divisor;
      let quotient;
      let dividend;

      if (state.difficulty === "single") {
        divisor = randInt(2, 12);
        quotient = randInt(2, 12);
      } else if (state.difficulty === "double") {
        divisor = randInt(2, 9);
        quotient = randInt(5, 45);
      } else {
        divisor = randInt(2, 9);
        quotient = randInt(20, 111);
      }

      dividend = divisor * quotient;
      if (state.difficulty === "double") {
        while (dividend < 10 || dividend > 99) {
          divisor = randInt(2, 9);
          quotient = randInt(5, 45);
          dividend = divisor * quotient;
        }
      } else if (state.difficulty === "multi") {
        while (dividend < 100 || dividend > 999) {
          divisor = randInt(2, 9);
          quotient = randInt(20, 111);
          dividend = divisor * quotient;
        }
      }

      return {
        id: nextPromptId(),
        kind: "math",
        answer: quotient,
        plain: `${dividend} รท ${divisor}`,
        htmlMath: `${formatNumber(dividend)} รท ${divisor}`
      };
    }

    function roundNearest(value, place) {
      return Math.round(value / place) * place;
    }

    function roundBounds(value, place) {
      const lower = Math.floor(value / place) * place;
      return { lower, upper: lower + place };
    }

    function makeRoundingPrompt() {
      enforceRoundingWithin();
      const place = state.roundingNearest;
      const placeText = formatNumber(place);
      const minValue = Math.min(place, state.roundingWithin - 1);
      const maxValue = state.roundingWithin - 1;
      const number = randInt(minValue, maxValue);
      return {
        id: nextPromptId(),
        kind: "rounding",
        number,
        place,
        placeText,
        view: state.roundingStyle,
        bounds: roundBounds(number, place),
        answer: roundNearest(number, place),
        plain: `Round ${formatNumber(number)} to nearest ${placeText}`
      };
    }

    function makeCountingPrompt() {
      const limit = state.difficulty === "single" ? 20 : state.difficulty === "double" ? 50 : 100;
      const style = state.countingStyle === "mixed"
        ? choose(["forward", "backward", "missing"])
        : state.countingStyle;

      let sequence;
      let answer;

      if (style === "forward") {
        const start = randInt(0, Math.max(0, limit - 3));
        sequence = [start, start + 1, start + 2, null];
        answer = start + 3;
      } else if (style === "backward") {
        const start = randInt(3, limit);
        sequence = [start, start - 1, start - 2, null];
        answer = start - 3;
      } else {
        const direction = choose(["forward", "backward"]);
        const start = direction === "forward"
          ? randInt(0, Math.max(0, limit - 2))
          : randInt(2, limit);
        const base = direction === "forward"
          ? [start, start + 1, start + 2]
          : [start, start - 1, start - 2];
        const blankIndex = randInt(0, 2);
        answer = base[blankIndex];
        sequence = base.map((n, idx) => (idx === blankIndex ? null : n));
      }

      return {
        id: nextPromptId(),
        kind: "counting",
        style,
        sequence,
        answer,
        plain: `Counting within ${limit}`
      };
    }

    function makeTenFramePrompt() {
      let total;
      if (state.difficulty === "single") total = randInt(1, 10);
      else if (state.difficulty === "double") total = randInt(11, 20);
      else total = randInt(21, 40);
      return {
        id: nextPromptId(),
        kind: "tenframes",
        total,
        answer: total,
        plain: "Count the ten-frame dots"
      };
    }

    function makePrompt() {
      if (state.operation === "coins") return makeCoinPrompt();
      if (state.operation === "addition") return makeAdditionPrompt();
      if (state.operation === "subtraction") return makeSubtractionPrompt();
      if (state.operation === "multiplication") return makeMultiplicationPrompt();
      if (state.operation === "division") return makeDivisionPrompt();
      if (state.operation === "rounding") return makeRoundingPrompt();
      if (state.operation === "counting") return makeCountingPrompt();
      return makeTenFramePrompt();
    }

    function makePrompts(total) {
      const out = [];
      for (let i = 0; i < total; i += 1) out.push(makePrompt());
      return out;
    }

    function renderTenFrames(total) {
      let remaining = total;
      const frameHtml = [];
      const frameCount = Math.ceil(total / 10);
      for (let f = 0; f < frameCount; f += 1) {
        const fill = Math.min(10, remaining);
        remaining -= fill;
        const cells = [];
        for (let i = 0; i < 10; i += 1) {
          const dot = i < fill ? '<span class="tfdot"></span>' : "";
          cells.push(`<span class="tfcell">${dot}</span>`);
        }
        frameHtml.push(`<div class="tenframe"><div class="tfgrid">${cells.join("")}</div></div>`);
      }
      return `<div class="prompt-wrap"><div class="tenframe-group">${frameHtml.join("")}</div></div>`;
    }

    function renderCoinPrompt(prompt, context) {
      const isTtt = context === "ttt";
      const base = isTtt ? 44 : 58;
      const cols = isTtt ? (prompt.coins.length <= 4 ? 2 : 3) : 0;
      const stripClass = cols ? "coin-strip coin-grid" : "coin-strip";
      const stripStyle = cols ? ` style="--coin-cols:${cols}"` : "";
      const html = prompt.coins.map((coin) => {
        const size = Math.round(base * coin.ratio);
        const dots = coin.chunkValues.map((chunkValue, idx) => {
          const pos = (DOT_POSITIONS[coin.chunkValues.length] || DOT_POSITIONS[1])[idx] || { x: 50, y: 50 };
          const star = chunkValue === 1 ? " star" : "";
          const text = chunkValue === 1 ? "&#9733;" : String(chunkValue);
          return `<span class="coin-dot${star}" style="left:${pos.x}%;top:${pos.y}%">${text}</span>`;
        }).join("");

        return `<div class="coin-face" style="--coin-size:${size}px"><img src="${coin.img}" alt="${htmlEscape(coin.label)}">${dots}</div>`;
      }).join("");

      return `
        <div class="coin-prompt">
          <div class="${stripClass}"${stripStyle}>${html}</div>
        </div>`;
    }

    function renderStackPrompt(prompt) {
      return `
        <div class="prompt-wrap">
          <div class="stack-problem" aria-label="${htmlEscape(prompt.plain)}">
            <div class="stack-line"><span>${formatNumber(prompt.top)}</span></div>
            <div class="stack-line"><span class="op">${prompt.op}</span><span>${formatNumber(prompt.bottom)}</span></div>
            <div class="stack-bar"></div>
          </div>
        </div>`;
    }

    function renderUnderlinedRoundingNumber(number, place) {
      const raw = String(number);
      const placeDigits = String(place).length - 1;
      const underlineIndex = raw.length - placeDigits - 1;
      if (underlineIndex < 0 || underlineIndex >= raw.length) return raw;
      return raw
        .split("")
        .map((ch, i) => (i === underlineIndex ? `<span class="under">${ch}</span>` : ch))
        .join("");
    }

    function renderRoundingNumberLine(prompt) {
      const lower = prompt.bounds.lower;
      const upper = prompt.bounds.upper;
      const pct = Math.max(0, Math.min(100, ((prompt.number - lower) / (upper - lower)) * 100));
      return `
        <div class="numline-wrap">
          <div class="numline-track">
            <span class="numline-end left"></span>
            <span class="numline-end right"></span>
            <span class="numline-marker" style="left:${pct}%"></span>
          </div>
          <div class="numline-labels"><span>${formatNumber(lower)}</span><span>${formatNumber(upper)}</span></div>
          <div class="numline-target">Locate ${formatNumber(prompt.number)}</div>
        </div>`;
    }

    function renderPromptHtml(prompt, context) {
      if (prompt.kind === "coins") return renderCoinPrompt(prompt, context);
      if (prompt.kind === "stack") return renderStackPrompt(prompt);
      if (prompt.kind === "math") {
        return `<div class="prompt-wrap"><div class="prompt-math">${htmlEscape(prompt.htmlMath)}</div></div>`;
      }
      if (prompt.kind === "rounding") {
        const roundedSource = renderUnderlinedRoundingNumber(prompt.number, prompt.place);
        const nl = prompt.view === "numberline" ? renderRoundingNumberLine(prompt) : "";
        return `
          <div class="prompt-wrap">
            <div class="rounding-line">Round ${roundedSource}</div>
            <div class="prompt-math" style="font-size:1.08rem">to nearest ${prompt.placeText}</div>
            ${nl}
          </div>`;
      }
      if (prompt.kind === "counting") {
        const seq = prompt.sequence.map((x) => (x === null ? '<span class="missing-token">____</span>' : formatNumber(x))).join(", ");
        return `
          <div class="prompt-wrap">
            <div class="counting-line">${seq}</div>
          </div>`;
      }
      return renderTenFrames(prompt.total);
    }

    function buildTttBoard(prompts, small) {
      const table = document.createElement("table");
      table.className = small ? "ttt-board small" : "ttt-board";
      const tbody = document.createElement("tbody");

      let idx = 0;
      for (let r = 0; r < 3; r += 1) {
        const tr = document.createElement("tr");
        for (let c = 0; c < 3; c += 1) {
          const td = document.createElement("td");
          if (r < 2) td.classList.add("has-bottom");
          if (c < 2) td.classList.add("has-right");
          const prompt = prompts[idx++];
          td.innerHTML = `<div class="ttt-cell-inner">${renderPromptHtml(prompt, "ttt")}</div>`;
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }

      table.appendChild(tbody);
      return table;
    }

    function buildTttSheet(prompts, pageIndex) {
      const article = document.createElement("article");
      article.className = "sheet";
      article.innerHTML = `
        <div class="sheet-title">Math Tic Tac Toe</div>
        <div class="sheet-meta">${operationLabel()} | ${difficultyLabel()} | Page ${pageIndex}</div>
        <div id="board-${pageIndex}"></div>
        <div class="copy">Copyright - InterventionStation.com - @TeachwithMrC</div>
      `;

      const board = article.querySelector(`#board-${pageIndex}`);
      board.appendChild(buildTttBoard(prompts, false));

      return article;
    }

    function buildTttFourSheet(pageIndex) {
      const article = document.createElement("article");
      article.className = "sheet ttt-four";
      article.innerHTML = `
        <div class="sheet-title">Math Tic Tac Toe (4 Games)</div>
        <div class="sheet-meta">${operationLabel()} | ${difficultyLabel()} | Page ${pageIndex}</div>
        <div class="ttt-four-grid" id="tttFour-${pageIndex}"></div>
        <div class="copy">Copyright - InterventionStation.com - @TeachwithMrC</div>
      `;

      const mount = article.querySelector(`#tttFour-${pageIndex}`);
      for (let gameNum = 1; gameNum <= 4; gameNum += 1) {
        const prompts = makePrompts(9);
        const wrap = document.createElement("section");
        wrap.className = "mini-game";
        wrap.innerHTML = `<div class="mini-title">Game ${gameNum}</div>`;
        wrap.appendChild(buildTttBoard(prompts, true));

        mount.appendChild(wrap);
      }
      return article;
    }

    function buildRollTable(prompts) {
      const table = document.createElement("table");
      table.className = "roll-table";
      const cols = 6;
      const rows = Math.ceil(prompts.length / cols);

      const header = table.insertRow();
      for (let c = 0; c < cols; c += 1) {
        const td = header.insertCell();
        td.className = "dice-cell";
        const img = document.createElement("img");
        img.src = `images/dice${c + 1}.png`;
        img.alt = `Dice ${c + 1}`;
        td.appendChild(img);
      }

      let i = 0;
      for (let r = 0; r < rows; r += 1) {
        const row = table.insertRow();
        for (let c = 0; c < cols; c += 1) {
          const td = row.insertCell();
          const prompt = prompts[i] || null;
          td.innerHTML = prompt ? renderPromptHtml(prompt, "roll") : "";
          i += 1;
        }
      }

      return table;
    }

    function buildRollSheet(prompts, pageIndex) {
      const article = document.createElement("article");
      article.className = "sheet";
      article.innerHTML = `
        <div class="sheet-title">Math Roll and Read</div>
        <div class="sheet-meta">${operationLabel()} | ${difficultyLabel()} | Page ${pageIndex}</div>
        <div id="tableMount-${pageIndex}"></div>
        <div class="copy">Copyright - InterventionStation.com - @TeachwithMrC</div>
      `;
      article.querySelector(`#tableMount-${pageIndex}`).appendChild(buildRollTable(prompts));
      return article;
    }

    function generatePrintables() {
      const copies = Math.max(1, Math.min(12, Number(copiesInput.value) || 1));
      state.copies = copies;
      copiesInput.value = String(copies);

      const fourPerPage =
        state.gameType === "tictactoe" &&
        state.operation !== "coins" &&
        !(state.operation === "rounding" && state.roundingStyle === "numberline");

      outputEl.innerHTML = "";
      for (let i = 1; i <= copies; i += 1) {
        if (state.gameType === "tictactoe") {
          if (fourPerPage) {
            outputEl.appendChild(buildTttFourSheet(i));
          } else {
            outputEl.appendChild(buildTttSheet(makePrompts(9), i));
          }
        } else {
          outputEl.appendChild(buildRollSheet(makePrompts(state.gridSize), i));
        }
      }
      outputEl.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    document.getElementById("btnGoOnline").addEventListener("click", () => {
      window.location.href = "ultimate_math_tictactoe_roll_read.html";
    });

    document.getElementById("btnGoPrintables").addEventListener("click", () => {
      document.getElementById("welcomePanel").style.display = "none";
      document.getElementById("builderPanel").style.display = "block";
      generatePrintables();
    });

    document.getElementById("btnBackWelcome").addEventListener("click", () => {
      document.getElementById("builderPanel").style.display = "none";
      document.getElementById("welcomePanel").style.display = "block";
    });

    document.querySelectorAll("#gameTypeRow .pill").forEach((button) => {
      button.addEventListener("click", () => {
        state.gameType = button.dataset.gameType;
        setSelectedInRow("gameTypeRow", "data-game-type", state.gameType);
      });
    });

    document.querySelectorAll("#operationRow .pill").forEach((button) => {
      button.addEventListener("click", () => {
        state.operation = button.dataset.operation;
        setSelectedInRow("operationRow", "data-operation", state.operation);
        updateDifficultyOptions();
        updateRegroupVisibility();
      });
    });

    difficultySelect.addEventListener("change", () => {
      state.difficulty = difficultySelect.value;
    });

    regroupSelect.addEventListener("change", () => {
      state.regroupMode = regroupSelect.value;
    });

    roundingStyleSelect.addEventListener("change", () => {
      state.roundingStyle = roundingStyleSelect.value;
    });

    roundingNearestSelect.addEventListener("change", () => {
      state.roundingNearest = Number(roundingNearestSelect.value) || 10;
      enforceRoundingWithin();
    });

    roundingWithinSelect.addEventListener("change", () => {
      state.roundingWithin = Number(roundingWithinSelect.value) || 100;
      enforceRoundingWithin();
    });

    countingStyleSelect.addEventListener("change", () => {
      state.countingStyle = countingStyleSelect.value;
    });

    gridSizeSelect.addEventListener("change", () => {
      state.gridSize = Number(gridSizeSelect.value) || 24;
    });

    document.getElementById("btnGenerate").addEventListener("click", generatePrintables);
    document.getElementById("btnPrint").addEventListener("click", () => window.print());

    updateDifficultyOptions();
    updateRegroupVisibility();
    roundingStyleSelect.value = state.roundingStyle;
    roundingNearestSelect.value = String(state.roundingNearest);
    roundingWithinSelect.value = String(state.roundingWithin);
    enforceRoundingWithin();
    countingStyleSelect.value = state.countingStyle;
  </script>
</body>
</html>
