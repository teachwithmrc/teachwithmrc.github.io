<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tic Tac Toe Phonics Generator</title>

  <!-- ðŸ”— DATA SOURCE (must sit next to this HTML file) -->
  <!-- All words/sentences are loaded from this file into the global objects:
       - fluencyWords
       - fluencySentences
       - trickyWords (not used here, but available)
       See the â€œDATA ACCESSâ€ section in the script for how keys are resolved. -->
  <script src="fluencyDataFull_v8-2_clean-2.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --cvc:#e9f2ff;          --cvc-selected:#1976d2;
      --dig:#f3e9ff;          --dig-selected:#8e24aa;
      --glued:#e8fff4;        --glued-selected:#2e7d32;
      --vce:#fff5e6;          --vce-selected:#ef6c00;
      --rctrl:#f0f5ff;        --rctrl-selected:#3f51b5;
      --vteams:#fff0f6;       --vteams-selected:#d81b60;
      --dip:#eefcfb;          --dip-selected:#00897b;
      --variant:#fff8e1;      --variant-selected:#f9a825;
      --soft:#eef4ff;         --soft-selected:#455a64;

      --chip-bg:#f3f6fb; --chip-text:#263238; --chip-x:#546e7a;
    }

    body { font-family:'Poppins',sans-serif; margin:28px; text-align:center; background:#fafafa; }
    h1 { font-size: 36px; margin-bottom: 6px; }
    .subtitle { color:#555; margin:0 0 14px; }

    /* Layout */
    .layout { width:100%; max-width:1100px; margin:0 auto 14px auto; display:grid; grid-template-columns: minmax(260px,1fr) max-content; grid-template-rows: 1fr 1fr; gap:12px; align-items:stretch; }
    .layout .left { grid-column:1; grid-row:1 / span 2; }
    .layout .right-top { grid-column:2; grid-row:1; }
    .layout .right-bottom { grid-column:2; grid-row:2; }

    /* Cards */
    .table-section { border:2px solid #000; padding:16px; width:100%; box-sizing:border-box; text-align:left; border-radius:12px; background:#fff; height:100%; }
    .section-label { font-weight:700; font-size:20px; margin-bottom:12px; text-align:center; }

    /* Step 1 blocks */
    .skill-block { border:1px solid #bbb; border-radius:12px; overflow:hidden; margin-bottom:12px; background:#fff; }
    .skill-header {
      display:flex; align-items:center; justify-content:center;
      padding:12px 16px; font-weight:700; font-size:22px; cursor:pointer; user-select:none;
    }
    .skill-header .arrow { font-size:30px; line-height:1; margin:0 14px; width:30px; text-align:center; }
    .skill-header .title { white-space:nowrap; }
    .skills-inner { display:flex; justify-content:center; flex-wrap:wrap; gap:12px; padding:14px; }
    .skills-inner.collapsed { display:none; }

    /* Category header colors */
    .bg-cvc   .skill-header { background:var(--cvc); }
    .bg-dig   .skill-header { background:var(--dig); }
    .bg-glued .skill-header { background:var(--glued); }
    .bg-vce   .skill-header { background:var(--vce); }
    .bg-rctrl .skill-header { background:var(--rctrl); }
    .bg-vteams .skill-header{ background:var(--vteams); }
    .bg-dip   .skill-header { background:var(--dip); }
    .bg-variant .skill-header{ background:var(--variant); }
    .bg-soft  .skill-header { background:var(--soft); }

    /* Skill buttons */
    .skill-button{
      border:2px solid #000; padding:10px 16px; border-radius:16px;
      font-weight:700; font-size:16px; cursor:pointer; background:#fff;
      transition:transform .08s ease, background-color .2s ease, color .2s ease, box-shadow .2s ease;
      user-select:none; line-height:1.2; min-height:44px;
      position: relative;
    }
    .skill-button:active{ transform:translateY(1px); }
    .skill-button.cvc.selected{ background:var(--cvc-selected); color:#fff; }
    .skill-button.dig.selected{ background:var(--dig-selected); color:#fff; }
    .skill-button.glued.selected{ background:var(--glued-selected); color:#fff; }
    .skill-button.vce.selected{ background:var(--vce-selected); color:#fff; }
    .skill-button.rctrl.selected{ background:var(--rctrl-selected); color:#fff; }
    .skill-button.vteams.selected{ background:var(--vteams-selected); color:#fff; }
    .skill-button.dip.selected{ background:var(--dip-selected); color:#fff; }
    .skill-button.variant.selected{ background:var(--variant-selected); color:#fff; }
    .skill-button.soft.selected{ background:var(--soft-selected); color:#fff; }

    /* Chips */
    .chips-title { margin-top:12px; text-align:center; font-weight:700; font-size:16px; }
    .chips-wrap { margin-top:8px; display:flex; justify-content:center; flex-wrap:wrap; gap:8px; }
    .chip {
      background:var(--chip-bg); color:var(--chip-text);
      border:none; border-radius:999px; padding:8px 12px; font-size:20px;
      display:flex; align-items:center; gap:10px; box-shadow:inset 0 0 0 1px rgba(0,0,0,0.06);
    }
    .chip .x { width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center;
      font-weight:700; font-size:12px; cursor:pointer; background:#e8edf2; color:var(--chip-x); transition:background .15s; }
    .chip .x:hover { background:#dfe7ee; }

    /* Option boxes */
    .option-grid { display:flex; flex-direction:column; align-items:center; gap:12px; }
    .option-box { display:inline-block; padding:8px 14px; border:2px solid #000; border-radius:12px; font-weight:600; font-size:14px; background:#fff; cursor:pointer; }
    .option-box:active { transform:translateY(1px); }
    .option-box.selected { background-color:#d0f0ff; }

    .actions-sticky { position:sticky; top:8px; z-index:50; background:#fff; }

    /* OUTPUT */
    #output { display:flex; justify-content:center; padding:16px 0; flex-direction:column; gap:20px; }
    .page { width:8.5in; max-width:calc(100% - 32px); background:#fff; box-shadow:0 6px 20px rgba(0,0,0,.12); padding:0.5in; border:2px solid #000; border-radius:8px; margin:0 auto; }
    .worksheet-title { font-size:34px; margin-bottom:6px; font-weight:700; text-align:center; }
    .worksheet-directions { font-size:18px; margin-bottom:14px; text-align:center; }
    .board-wrap { display:grid; grid-template-columns: 1fr 1fr; gap:30px; justify-content:center; max-width:900px; margin:0 auto; }
    .tic-tac-toe { border-collapse:collapse; width:100%; }
    .tic-tac-toe td { border:none; height:80px; vertical-align:middle; text-align:center; padding:6px; font-size:24px; line-height:28px; word-break:break-word; }
    .board-shell { display:flex; flex-direction:column; align-items:center; width:100%; border:3px solid #000; border-radius:16px; padding:12px; background:#fff; box-sizing:border-box; }
    .board-label { font-weight:700; font-size:22px; margin-bottom:10px; }

    #copyright { font-size:12px; text-align:right; margin-top:12px; display:none; }

    /* PRINT */
    @media print {
      body { margin:0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .table-section, button, .chips-title, .chips-wrap, .subtitle, .layout, #floatingActions { display:none !important; }
      #output { margin:0; }
      .worksheet-title { font-size:20px; margin-bottom:2px; }
      .worksheet-directions { font-size:14px; margin-bottom:8px; }
      #copyright { display:block; }
      .page { width:auto; padding:0; box-shadow:none; border:none; }
    }

    /* Mobile / Compact */
    @media (max-width: 900px) {
      .layout { display:block; }
      .option-box { font-size:16px; padding:12px 16px; }
    }
    @media (min-width: 992px) {
      h1 { font-size: 22px; margin-bottom: 2px; }
      .table-section { padding:12px; }
      .section-label { font-size:16px; margin-bottom:8px; }
      .skill-block { margin-bottom:8px; border-radius:10px; }
      .skill-header { padding:8px 10px; font-size:16px; }
      .skill-header .arrow { font-size:18px; margin:0 8px; width:18px; }
      .skills-inner { padding:8px; gap:8px; }
      .skill-button { padding:6px 10px; font-size:14px; min-height:34px; border-radius:10px; }
      .chips-title { font-size:14px; margin-top:8px; }
      .chip { padding:6px 10px; font-size:12px; gap:8px; }
      .chip .x { width:16px; height:16px; font-size:11px; }
      .worksheet-title { font-size:28px; }
    }
  </style>
</head>
<body>
  <h1>Fluency Grid Generator</h1>
  <div class="subtitle">Step 1 pick skills âžœ Step 2 toggle blends (3 sounds vs 4+ sounds) âžœ Step 3 choose content âžœ Step 4 generate four printable Tic-Tac-Toe boards.</div>

  <div class="layout">
    <div class="left">
      <!-- STEP 1 -->
      <div id="step1" class="table-section">
        <div class="section-label">Step 1: Select Skills</div>

        <!-- CVC Short Vowels -->
        <div class="skill-block bg-cvc">
          <div class="skill-header" data-target="cvc"><span class="arrow">â–²</span><span class="title">CVC Short Vowels</span><span class="arrow">â–²</span></div>
          <div class="skills-inner" id="section-cvc">
            <button class="skill-button cvc" data-skill="Short A">Short A</button>
            <button class="skill-button cvc" data-skill="Short E">Short E</button>
            <button class="skill-button cvc" data-skill="Short I">Short I</button>
            <button class="skill-button cvc" data-skill="Short O">Short O</button>
            <button class="skill-button cvc" data-skill="Short U">Short U</button>
            <button class="skill-button cvc" data-skill="Mixed CVC">Mixed CVC</button>
            <button class="skill-button cvc" data-skill="FLSZ">FLSZ</button>
          </div>
        </div>

        <!-- Digraphs -->
        <div class="skill-block bg-dig">
          <div class="skill-header" data-target="dig"><span class="arrow">â–¼</span><span class="title">Digraphs</span><span class="arrow">â–¼</span></div>
          <div class="skills-inner collapsed" id="section-dig">
            <button class="skill-button dig" data-skill="ck">ck</button>
            <button class="skill-button dig" data-skill="sh">sh</button>
            <button class="skill-button dig" data-skill="th">th</button>
            <button class="skill-button dig" data-skill="ch">ch</button>
            <button class="skill-button dig" data-skill="wh">wh</button>
            <button class="skill-button dig" data-skill="Digraphs Mixed">Digraphs Mixed</button>
          </div>
        </div>

        <!-- Glued Sounds (common clusters: -all/-ng/-nk/ing etc.) -->
        <div class="skill-block bg-glued">
          <div class="skill-header" data-target="glued"><span class="arrow">â–¼</span><span class="title">Glued Sounds</span><span class="arrow">â–¼</span></div>
          <div class="skills-inner collapsed" id="section-glued">
            <button class="skill-button glued" data-skill="-all">-all</button>
            <button class="skill-button glued" data-skill="-ng">-ng</button>
            <button class="skill-button glued" data-skill="-nk">-nk</button>
            <button class="skill-button glued" data-skill="ing">ing</button>
            <button class="skill-button glued" data-skill="Glued Mixed">Glued Mixed</button>
          </div>
        </div>

        <!-- VCe -->
        <div class="skill-block bg-vce">
          <div class="skill-header" data-target="vce"><span class="arrow">â–¼</span><span class="title">Silent E (VCe)</span><span class="arrow">â–¼</span></div>
          <div class="skills-inner collapsed" id="section-vce">
            <button class="skill-button vce" data-skill="a_e">a_e</button>
            <button class="skill-button vce" data-skill="i_e">i_e</button>
            <button class="skill-button vce" data-skill="o_e">o_e</button>
            <button class="skill-button vce" data-skill="u_e">u_e</button>
            <button class="skill-button vce" data-skill="Mixed VCe">Mixed VCe</button>
          </div>
        </div>

        <!-- R-Controlled -->
        <div class="skill-block bg-rctrl">
          <div class="skill-header" data-target="rctrl"><span class="arrow">â–¼</span><span class="title">R-Controlled</span><span class="arrow">â–¼</span></div>
          <div class="skills-inner collapsed" id="section-rctrl">
            <button class="skill-button rctrl" data-skill="ar">ar</button>
            <button class="skill-button rctrl" data-skill="or">or</button>
            <button class="skill-button rctrl" data-skill="er/ir/ur">er/ir/ur</button>
            <button class="skill-button rctrl" data-skill="Mixed R-Controlled">Mixed R-Controlled</button>
          </div>
        </div>

        <!-- Vowel Teams (ready for data expansion) -->
        <div class="skill-block bg-vteams">
          <div class="skill-header" data-target="vteams"><span class="arrow">â–¼</span><span class="title">Vowel Teams</span><span class="arrow">â–¼</span></div>
          <div class="skills-inner collapsed" id="section-vteams">
            <button class="skill-button vteams" data-skill="Long A (ai/ay)">Long A (ai/ay)</button>
            <button class="skill-button vteams" data-skill="Long E (ee/ea)">Long E (ee/ea)</button>
            <button class="skill-button vteams" data-skill="Long I (igh/y/ie)">Long I (igh/y/ie)</button>
            <span class="break"></span>
            <button class="skill-button vteams" data-skill="Long O (oa/ow/oe)">Long O (oa/ow/oe)</button>
            <button class="skill-button vteams" data-skill="Long U (oo/ew/ue)">Long U (oo/ew/ue)</button>
            <button class="skill-button vteams" data-skill="Mixed Vowel Teams">Mixed Vowel Teams</button>
          </div>
        </div>
      </div>
    </div>

    <div class="right-top">
      <!-- STEP 2 -->
      <div class="table-section tight">
        <div class="section-label">Step 2: Include Blends?</div>
        <div class="option-grid" id="blendOptions">
          <div class="option-box" data-blends="no">No â€“ 3 Sounds</div>
          <div class="option-box" data-blends="yes">Yes â€“ 4+ Sounds</div>
        </div>
      </div>
    </div>

    <div class="right-bottom">
      <!-- STEP 3 -->
      <div class="table-section tight">
        <div class="section-label">Step 3: What would you like in the grid?</div>
        <div class="option-grid" id="contentOptions">
          <div class="option-box" data-mode="words">Words Only</div>
          <div class="option-box" data-mode="sentences">Sentences Only</div>
          <div class="option-box" data-mode="both">Both</div>
        </div>
      </div>

      <!-- STEP 4 -->
      <div class="table-section actions-sticky tight">
        <div class="section-label">Step 4: Generate & Print</div>

        <div class="chips-title">Skills Selected:</div>
        <div id="chips" class="chips-wrap"></div>

        <div style="text-align:center; margin-top:10px;">
          <button id="btnGenerate" style="font-size: 18px; padding: 10px 24px;">Generate</button>
          <button onclick="window.print()" style="font-size: 18px; padding: 10px 24px;">Print</button>
        </div>
      </div>
    </div>
  </div>

  <!-- OUTPUT -->
  <div id="output"></div>

  <!-- Desktop-only floating actions -->
  <div id="floatingActions" style="
    position: fixed; right: 16px; bottom: 16px; z-index: 1000;
    background:#ffffff; border:2px solid #000; border-radius:12px;
    box-shadow: 0 6px 20px rgba(0,0,0,.15); padding:10px 12px;
    display:none; gap:8px; align-items:center;">
    <button id="fabGenerate" style="font-size:14px; padding:8px 12px;">Generate</button>
    <button id="fabPrint" style="font-size:14px; padding:8px 12px;">Print</button>
  </div>

<script>
/* ============================================================
   CORE WIRING
   ============================================================ */

if (typeof CSS === 'undefined' || typeof CSS.escape !== 'function') {
  window.CSS = window.CSS || {};
  CSS.escape = CSS.escape || function(sel){ return (sel+'').replace(/[^a-zA-Z0-9_-]/g,'\\\\$&'); };
}

/* 
  ðŸ§­ LABEL âžœ CODE MAP
  Left-panel button labels map to abstract "codes" we use below
  to resolve one or MORE data lists from your JS file.
*/
const CODE = {
  // CVC
  "Short A": "0.1", "Short O": "0.2", "Short I": "0.3", "Short U": "0.4", "Short E": "0.5",
  "FLSZ": "0.6", "Mixed CVC": "mixed",

  // Digraphs (Level 1)
  "ck": "1.1-ck", "sh": "1.2-sh", "th": "1.3-th", "ch": "1.4-ch", "wh": "1.5-wh",
  "Digraphs Mixed": "1.x-mixed",

  // Glued sounds (Level 3 style buckets present in your file for blends)
  "-all": "3.1-all", "-nk": "3.2-nk", "-ng": "3.3-ng", "ing": "3.4-ing",
  "Glued Mixed": "3.x-mixed",

  // VCe (Level 2)
  "a_e": "2.1-ae", "i_e": "2.2-ie", "o_e": "2.3-oe", "u_e": "2.4-ue", "Mixed VCe": "2.x-mixed",

  // R-controlled (Level 4)
  "ar": "4.1-ar", "or": "4.2-or", "er/ir/ur": "4.3-erirur", "Mixed R-Controlled": "4.x-mixed",

  // Vowel teams placeholders (name patterns youâ€™ll add in your data file later)
  "Long A (ai/ay)": "5.1-longA", "Long E (ee/ea)": "5.2-longE",
  "Long I (igh/y/ie)": "5.3-longI", "Long O (oa/ow/oe)": "5.4-longO",
  "Long U (oo/ew/ue)": "5.5-longU", "Mixed Vowel Teams": "5.x-mixed"
};

/* Pretty names for chips/title from codes */
const NAME = new Proxy({}, {
  get(_, code){ 
    for (const [k,v] of Object.entries(CODE)) if (v===code) return k;
    return code;
  }
});

const selectedCodes = new Set();
let mode = null;           // 'words' | 'sentences' | 'both'
let includeBlends = false; // Step 2 toggle

/* Expand/collapse category */
document.querySelectorAll('.skill-header').forEach(header => {
  header.addEventListener('click', () => {
    const target = header.getAttribute('data-target');
    const inner = document.getElementById('section-' + target);
    const arrows = header.querySelectorAll('.arrow');
    const isCollapsed = inner.classList.contains('collapsed');
    if (isCollapsed) { inner.classList.remove('collapsed'); arrows.forEach(a => a.textContent='â–²'); }
    else { inner.classList.add('collapsed'); arrows.forEach(a => a.textContent='â–¼'); }
  });
});

/* Step 1: select (nothing disabled â€” all clickable) */
document.querySelectorAll('.skill-button').forEach(btn => {
  btn.addEventListener('click', (e) => {
    e.stopPropagation();
    const label = btn.dataset.skill;
    const code = CODE[label] || label; // allow unknowns gracefully
    if (selectedCodes.has(code)) { selectedCodes.delete(code); btn.classList.remove('selected'); }
    else { selectedCodes.add(code); btn.classList.add('selected'); }
    renderChips();
  });
});

/* Chips UI */
function renderChips(){
  const wrap = document.getElementById('chips');
  wrap.innerHTML = '';
  Array.from(selectedCodes).forEach(code => {
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.innerHTML = `<span>${NAME[code]}</span><span class="x" title="Remove">Ã—</span>`;
    chip.querySelector('.x').addEventListener('click', () => {
      selectedCodes.delete(code);
      const btn = [...document.querySelectorAll('.skill-button')].find(b => (CODE[b.dataset.skill]||b.dataset.skill)===code);
      if (btn) btn.classList.remove('selected');
      renderChips();
    });
    wrap.appendChild(chip);
  });
}

/* Step 2: blends on/off */
document.querySelectorAll('#blendOptions .option-box').forEach(box => {
  box.addEventListener('click', () => {
    document.querySelectorAll('#blendOptions .option-box').forEach(b => b.classList.remove('selected'));
    box.classList.add('selected');
    includeBlends = (box.dataset.blends === 'yes');
  });
});

/* Step 3: content mode */
document.querySelectorAll('#contentOptions .option-box').forEach(box => {
  box.addEventListener('click', () => {
    document.querySelectorAll('#contentOptions .option-box').forEach(b => b.classList.remove('selected'));
    box.classList.add('selected');
    mode = box.dataset.mode;
  });
});

/* Floating actions (desktop) */
function toggleFloatingBar(){
  const el = document.getElementById('floatingActions');
  const isDesktop = window.matchMedia('(min-width: 992px)').matches;
  el.style.display = isDesktop ? 'flex' : 'none';
}
toggleFloatingBar();
window.addEventListener('resize', toggleFloatingBar);
document.getElementById('fabGenerate')?.addEventListener('click', () => document.getElementById('btnGenerate')?.click());
document.getElementById('fabPrint')?.addEventListener('click', () => window.print());

/* ============================================================
   DATA ACCESS â€” EXACTLY WHERE WE CALL INTO YOUR JS FILE
   ------------------------------------------------------------
   Your data file defines (globals):
     - fluencyWords:    { "<key>": [ ...words... ] }
     - fluencySentences:{ "<key>": [ ...sentences... ] }

   We generate the correct <key> (or multiple keys for combos) by:
     1) building base labels (e.g., "0.1 - Short A Words"),
     2) switching to â€œwith Blendsâ€ variants when includeBlends is true,
     3) unioning across ranges (e.g., Mixed CVC with blends = 0.1..0.5 with Blends),
     4) falling back gently if a requested list is missing.
   ============================================================ */

/* Convenience guards */
function dictWords(){ return (typeof fluencyWords === 'object' && fluencyWords) ? fluencyWords : {}; }
function dictSents(){ return (typeof fluencySentences === 'object' && fluencySentences) ? fluencySentences : {}; }

/* Build a single label by parts */
function labelWords(prefix, name, opts={}) {
  // prefix: "0.1", "1.4", "Mixed CVC", "nk", etc.
  // name:   "Short A", "ch", "R-Controlled", etc. (purely cosmetic in many files)
  // opts.blends: boolean -> inject " with Blends"
  const base = prefix ? `${prefix} - ${name} Words` : `${name} Words`;
  return opts.blends ? base.replace(' Words',' with Blends Words') : base;
}
function labelSents(prefix, name, opts={}) {
  const base = prefix ? `${prefix} - ${name} Sentences` : `${name} Sentences`;
  // Some sets donâ€™t have â€œwith Blends Sentencesâ€; we try it then fall back.
  return opts.blends ? base.replace(' Sentences',' with Blends Sentences') : base;
}

/* Low-level fetch for a single key; returns [] if not found */
function fetchListOne(type, key){
  const d = (type==='words') ? dictWords() : dictSents();
  const arr = d[key];
  return Array.isArray(arr) ? arr.slice() : [];
}

/* Try blends key first (if requested), fall back to non-blends automatically */
function fetchKeySmart(type, baseKey, blendsKey){
  if (blendsKey) {
    const b = fetchListOne(type, blendsKey);
    if (b.length) return b;
  }
  return fetchListOne(type, baseKey);
}

/* Find keys loosely (used for things like â€œwhâ€ if exact index differs).
   Looks for keys containing a marker (e.g., "1.5 - wh"). */
function findKeysContaining(type, substrings){
  const d = (type==='words') ? dictWords() : dictSents();
  const keys = Object.keys(d);
  const want = Array.isArray(substrings) ? substrings : [substrings];
  return keys.filter(k => want.some(s => k.toLowerCase().includes(String(s).toLowerCase())));
}

/* ========== CODE âžœ ONE OR MORE LABEL KEYS (the â€œrouterâ€) ========== */
function keysForCode(code, type, blends){
  const keys = [];

  // Helpers to push (base, blends) label variations:
  const add = (prefix, name, opts={}) => {
    const base  = (type==='words') ? labelWords(prefix, name) : labelSents(prefix, name);
    const blend = (type==='words') ? labelWords(prefix, name, {blends:true}) : labelSents(prefix, name, {blends:true});
    // if blends requested, try blends key first, else base
    if (blends) keys.push({base, blend});
    else keys.push({base});
  };

  switch(code){

    /* ---------- Level 0 (CVC) ---------- */
    case "0.1-0.5-withblends": // internal meta for Mixed CVC + blends
      ["0.1","0.2","0.3","0.4","0.5"].forEach(p => add(p, {
        "0.1":"Short A","0.2":"Short O","0.3":"Short I","0.4":"Short U","0.5":"Short E"
      }[p]));
      break;

    case "0.1": add("0.1","Short A"); break;
    case "0.2": add("0.2","Short O"); break;
    case "0.3": add("0.3","Short I"); break;
    case "0.4": add("0.4","Short U"); break;
    case "0.5": add("0.5","Short E"); break;

    case "0.6": // FLSZ lists in your file are titled just "0.6 - FLSZ"
      // Words key doesnâ€™t end with â€œWordsâ€ in some sheets; catch both forms:
      if (type==='words') {
        keys.push({ base: "0.6 - FLSZ", blend: "0.6 - FLSZ with Blends Words" });
      } else { add("0.6","FLSZ"); }
      break;

    case "mixed":
      if (includeBlends) {
        // Mix = all 0.1..0.5 with Blends
        return keysForCode("0.1-0.5-withblends", type, true);
      } else {
        // Use provided â€œMixed CVC Words/Sentencesâ€
        const base = (type==='words') ? "Mixed CVC Words" : "Mixed CVC Sentences";
        keys.push({base});
      }
      break;

    /* ---------- Level 1 (Digraphs) ---------- */
    case "1.1-ck": add("1.1","ck with Blends"); if(!includeBlends){ add("1.1","ck"); } break;
    case "1.2-sh": add("1.2","sh with Blends"); if(!includeBlends){ add("1.2","sh"); } break;
    case "1.3-th": add("1.3","th with Blends"); if(!includeBlends){ add("1.3","th"); } break;
    case "1.4-ch": add("1.4","ch with Blends"); if(!includeBlends){ add("1.4","ch"); } break;
    case "1.5-wh":
      // Your words list is likely "1.5 - wh with Blends Words" and sentences "1.5 - wh Sentences"
      if (type==='words'){
        keys.push({ base:"1.5 - wh Words", blend:"1.5 - wh with Blends Words" });
        // Loose find if file uses a slightly different key text:
        findKeysContaining('words', ['1.5',' wh ']).forEach(k => keys.push({base:k}));
      } else {
        keys.push({ base:"1.5 - wh Sentences" });
        findKeysContaining('sentences', ['1.5',' wh ']).forEach(k => keys.push({base:k}));
      }
      break;

    case "1.x-mixed":
      // Mix Digraphs = 1.1..1.5 (ck,sh,th,ch,wh) (+blends if requested)
      ["1.1-ck","1.2-sh","1.3-th","1.4-ch","1.5-wh"].forEach(sub => {
        keys.push(...keysForCode(sub, type, includeBlends));
      });
      break;

    /* ---------- Level 3 (Glued) ---------- */
    case "3.1-all":
      // file shows "3.1 - all with Blends Words" (words), sentences may be absent
      if (type==='words'){
        keys.push({base:"3.1 - all Words", blend:"3.1 - all with Blends Words"});
      } else {
        keys.push({base:"3.1 - all Sentences", blend:"3.1 - all with Blends Sentences"});
      }
      break;
    case "3.2-nk":
      if (type==='words'){
        // seen as: "nk with Blends Words"
        keys.push({base:"nk Words", blend:"nk with Blends Words"});
      } else {
        keys.push({base:"nk Sentences", blend:"nk with Blends Sentences"});
      }
      break;
    case "3.3-ng":
      if (type==='words'){
        keys.push({base:"-ng Words", blend:"-ng with Blends Words"});
      } else {
        keys.push({base:"-ng Sentences", blend:"-ng with Blends Sentences"});
      }
      break;
    case "3.4-ing":
      if (type==='words'){
        keys.push({base:"ing Words", blend:"ing with Blends Words"});
      } else {
        keys.push({base:"ing Sentences", blend:"ing with Blends Sentences"});
      }
      break;
    case "3.x-mixed":
      ["3.1-all","3.2-nk","3.4-ing","3.3-ng"].forEach(sub => {
        keys.push(...keysForCode(sub, type, includeBlends));
      });
      break;

    /* ---------- Level 2 (VCe) ---------- */
    case "2.1-ae": add("2.1","a_e"); add("2.1","a_e with blends"); break;
    case "2.2-ie": add("2.2","i_e"); add("2.2","i_e with blends"); break;
    case "2.3-oe": add("2.3","o_e"); add("2.3","o_e with blends"); break;
    case "2.4-ue": add("2.4","u_e"); add("2.4","u_e with blends"); break;
    case "2.x-mixed":
      ["2.1-ae","2.2-ie","2.3-oe","2.4-ue"].forEach(sub => {
        keys.push(...keysForCode(sub, type, includeBlends));
      });
      break;

    /* ---------- Level 4 (R-controlled) ---------- */
    case "4.1-ar": add("4.1","ar"); add("4.1","ar with Blends"); break;
    case "4.2-or": add("4.2","or"); add("4.2","or with Blends"); break;
    case "4.3-erirur": add("4.3","er, ir, ur"); add("4.3","er, ir, ur with Blends"); break;
    case "4.x-mixed":
      ["4.1-ar","4.2-or","4.3-erirur"].forEach(sub => {
        keys.push(...keysForCode(sub, type, includeBlends));
      });
      // also include any combined list like "4.4 - R-Controlled Words/Sentences" if present:
      if (type==='words') keys.push({base:"4.4 - R-Controlled Words", blend:"4.4 - R-Controlled with Blends Words"});
      else keys.push({base:"4.4 - R-Controlled Sentences", blend:"4.4 - R-Controlled with Blends Sentences"});
      break;

    /* ---------- Vowel Teams (name placeholders; patterns to match later) ---------- */
    case "5.1-longA":
    case "5.2-longE":
    case "5.3-longI":
    case "5.4-longO":
    case "5.5-longU":
    case "5.x-mixed":
      // Weâ€™ll pick up by loose pattern search until you commit exact keys in your JS.
      // Example target names you can use in your data file:
      //   "5.1 - Long A (ai/ay) Words", "5.1 - Long A (ai/ay) Sentences", etc.
      const patterns = {
        "5.1-longA": ["5.1","Long A"],
        "5.2-longE": ["5.2","Long E"],
        "5.3-longI": ["5.3","Long I"],
        "5.4-longO": ["5.4","Long O"],
        "5.5-longU": ["5.5","Long U"],
        "5.x-mixed": ["5.","Long "]
      }[code];
      findKeysContaining(type, patterns).forEach(k => keys.push({base:k}));
      break;

    default:
      // Unknown code -> loose match on label text
      findKeysContaining(type, code).forEach(k => keys.push({base:k}));
  }
  return keys;
}

/* Fetch array(s) for a code, union them, allow repeats to fill */
function getListForCode(code, type){
  const pairs = keysForCode(code, type, includeBlends);
  let pool = [];
  pairs.forEach(({base, blend}) => {
    const arr = fetchKeySmart(type, base, blend);
    if (arr.length) pool = pool.concat(arr);
  });

  // If requested non-blend set is empty but a blend-only list exists in file (common for glued),
  // auto-fallback to any seen blend-like keys by loose match:
  if (!pool.length) {
    const loose = findKeysContaining(type, NAME[code]);
    loose.forEach(k => { pool = pool.concat(fetchListOne(type,k)); });
  }
  return pool;
}

/* Shuffle-sample with automatic repetition to meet N cells */
function fillN(arr, n){
  if (!arr.length) return [];
  const out = [];
  const bag = arr.slice();
  while (out.length < n){
    // reshuffle bag when exhausted
    if (!bag.length) bag.push(...arr.slice().sort(()=>Math.random()-0.5));
    out.push(bag.shift());
  }
  return out;
}

/* Balanced gather across multiple selected codes */
function gatherBalanced(codes, mode, total){
  if (mode !== 'both'){
    const per = Math.max(1, Math.floor(total / Math.max(1,codes.length)));
    let pool = [];
    for (const c of codes){
      const list = getListForCode(c, mode);
      pool = pool.concat(fillN(list, per));
    }
    if (pool.length < total){
      // top-up by revisiting lists
      for (const c of codes){
        if (pool.length >= total) break;
        const list = getListForCode(c, mode);
        const need = total - pool.length;
        pool = pool.concat(fillN(list, need));
      }
    }
    return pool.slice(0,total).sort(()=>Math.random()-0.5);
  }

  // both = ~half words, half sentences (5/4 split handled by math)
  const targetW = Math.floor(total/2);
  const targetS = total - targetW;

  let wordsPool = [], sentsPool = [];
  const perW = Math.max(1, Math.floor(targetW / Math.max(1,codes.length)));
  const perS = Math.max(1, Math.floor(targetS / Math.max(1,codes.length)));

  for (const c of codes){
    wordsPool = wordsPool.concat(fillN(getListForCode(c,'words'), perW));
    sentsPool = sentsPool.concat(fillN(getListForCode(c,'sentences'), perS));
  }
  // top-ups
  for (const c of codes){
    if (wordsPool.length >= targetW) break;
    wordsPool = wordsPool.concat(fillN(getListForCode(c,'words'), targetW - wordsPool.length));
  }
  for (const c of codes){
    if (sentsPool.length >= targetS) break;
    sentsPool = sentsPool.concat(fillN(getListForCode(c,'sentences'), targetS - sentsPool.length));
  }

  const merged = wordsPool.slice(0,targetW).concat(sentsPool.slice(0,targetS));
  return merged.slice(0,total).sort(()=>Math.random()-0.5);
}

/* Build a single 3x3 board */
function buildBoard(cells){
  const tbl = document.createElement('table');
  tbl.className = 'tic-tac-toe';
  for (let r=0;r<3;r++){
    const row = tbl.insertRow();
    for (let c=0;c<3;c++){
      const td = row.insertCell();
      const val = cells[r*3+c] ?? '';
      const isSentence = (typeof val === 'string') && val.trim().includes(' ');
      td.textContent = val;
      if (r<2) td.style.borderBottom = '6px solid black';
      if (c<2) td.style.borderRight  = '6px solid black';
      td.style.fontSize = isSentence ? '20px' : '24px';
      td.style.lineHeight = isSentence ? '22px' : '28px';
    }
  }
  const wrap = document.createElement('div');
  wrap.className = 'board-shell';
  const label = document.createElement('div');
  label.className = 'board-label';
  label.textContent = ''; // set by caller
  wrap.appendChild(label);
  wrap.appendChild(tbl);
  return wrap;
}

/* Generate 4 boards x 9 cells = 36 items */
function generateBoards(){
  if (selectedCodes.size === 0) return alert('Select at least one skill in Step 1.');
  if (!mode) return alert('Choose Words Only / Sentences Only / Both in Step 3.');

  const codes = Array.from(selectedCodes);
  const TOTAL = 36;
  const content = gatherBalanced(codes, mode, TOTAL);
  if (content.length < TOTAL) {
    return alert('Not enough content for the chosen settings. Try toggling blends, adding skills, or switching content type.');
  }

  const output = document.getElementById('output');
  output.innerHTML = '';

  const page = document.createElement('div');
  page.className = 'page';

  const title = document.createElement('div');
  title.className = 'worksheet-title';
  const picked = codes.map(c=>NAME[c]).join(' â€¢ ');
  title.textContent = `${picked} Tic Tac Toe Game`;

  const directions = document.createElement('div');
  directions.className = 'worksheet-directions';
  directions.innerHTML = '<strong>Directions:</strong> Read the word or sentence in the space youâ€™d like to go, then put an X or O. Your opponent does the same. Win with 3 in a row!';

  const grid = document.createElement('div');
  grid.className = 'board-wrap';
  const chunks = [0,9,18,27].map(i => content.slice(i, i+9));
  chunks.forEach((nine, idx) => {
    const group = buildBoard(nine);
    group.querySelector('.board-label').textContent = `Game ${idx+1}`;
    grid.appendChild(group);
  });

  const copy = document.createElement('div');
  copy.id = 'copyright';
  copy.innerHTML = 'Copyright - InterventionStation.com - @TeachwithMrC';

  page.appendChild(title);
  page.appendChild(directions);
  page.appendChild(grid);
  page.appendChild(copy);
  output.appendChild(page);
  output.scrollIntoView({ behavior:'smooth', block:'start' });
}

document.getElementById('btnGenerate').addEventListener('click', generateBoards);
</script>
</body>
</html>
