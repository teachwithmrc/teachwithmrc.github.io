<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tic Tac Toe Phonics Generator</title>
  <!-- New data source -->
  <script src="fluencyDataFull_v8-2_clean.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --cvc:#e9f2ff;          --cvc-selected:#1976d2;
      --dig:#f3e9ff;          --dig-selected:#8e24aa;
      --glued:#e8fff4;        --glued-selected:#2e7d32;
      --vce:#fff5e6;          --vce-selected:#ef6c00;
      --rctrl:#f0f5ff;        --rctrl-selected:#3f51b5;
      --vteams:#fff0f6;       --vteams-selected:#d81b60;
      --dip:#eefcfb;          --dip-selected:#00897b;
      --variant:#fff8e1;      --variant-selected:#f9a825;
      --soft:#eef4ff;         --soft-selected:#455a64;

      --chip-bg:#f3f6fb; --chip-text:#263238; --chip-x:#546e7a;
    }

    body { font-family:'Poppins',sans-serif; margin:28px; text-align:center; background:#fafafa; }
    h1 { font-size: 36px; margin-bottom: 6px; }
    .subtitle { color:#555; margin:0 0 14px; }

    /* Grid layout */
    .layout { width:100%; max-width:1100px; margin:0 auto 14px auto; display:grid; grid-template-columns: minmax(260px,1fr) max-content; grid-template-rows: 1fr 1fr; gap:12px; align-items:stretch; }
    .layout .left { grid-column:1; grid-row:1 / span 2; }
    .layout .right-top { grid-column:2; grid-row:1; }
    .layout .right-bottom { grid-column:2; grid-row:2; }

    /* Card containers */
    .table-section { border:2px solid #000; padding:16px; width:100%; box-sizing:border-box; text-align:left; border-radius:12px; background:#fff; height:100%; }
    .section-label { font-weight:700; font-size:20px; margin-bottom:12px; text-align:center; }

    /* Step 1 blocks with headers + arrows */
    .skill-block { border:1px solid #bbb; border-radius:12px; overflow:hidden; margin-bottom:12px; background:#fff; }
    .skill-header {
      display:flex; align-items:center; justify-content:center;
      padding:12px 16px; font-weight:700; font-size:22px; cursor:pointer; user-select:none;
    }
    .skill-header .arrow { font-size:30px; line-height:1; margin:0 14px; width:30px; text-align:center; }
    .skill-header .title { white-space:nowrap; }
    .skills-inner { display:flex; justify-content:center; flex-wrap:wrap; gap:12px; padding:14px; }
    .skills-inner.collapsed { display:none; }

    /* Category backgrounds */
    .bg-cvc   .skill-header { background:var(--cvc); }
    .bg-dig   .skill-header { background:var(--dig); }
    .bg-glued .skill-header { background:var(--glued); }
    .bg-vce   .skill-header { background:var(--vce); }
    .bg-rctrl .skill-header { background:var(--rctrl); }
    .bg-vteams .skill-header{ background:var(--vteams); }
    .bg-dip   .skill-header { background:var(--dip); }
    .bg-variant .skill-header{ background:var(--variant); }
    .bg-soft  .skill-header { background:var(--soft); }

    /* Skill buttons */
    .skill-button{
      border:2px solid #000; padding:10px 16px; border-radius:16px;
      font-weight:700; font-size:16px; cursor:pointer; background:#fff;
      transition:transform .08s ease, background-color .2s ease, color .2s ease, box-shadow .2s ease;
      user-select:none; line-height:1.2; min-height:44px;
      position: relative;
    }
    .skill-button:active{ transform:translateY(1px); }

    /* Selected colors by category */
    .skill-button.cvc.selected{ background:var(--cvc-selected); color:#fff; }
    .skill-button.dig.selected{ background:var(--dig-selected); color:#fff; }
    .skill-button.glued.selected{ background:var(--glued-selected); color:#fff; }
    .skill-button.vce.selected{ background:var(--vce-selected); color:#fff; }
    .skill-button.rctrl.selected{ background:var(--rctrl-selected); color:#fff; }
    .skill-button.vteams.selected{ background:var(--vteams-selected); color:#fff; }
    .skill-button.dip.selected{ background:var(--dip-selected); color:#fff; }
    .skill-button.variant.selected{ background:var(--variant-selected); color:#fff; }
    .skill-button.soft.selected{ background:var(--soft-selected); color:#fff; }

    /* Chips */
    .chips-title { margin-top:12px; text-align:center; font-weight:700; font-size:16px; }
    .chips-wrap { margin-top:8px; display:flex; justify-content:center; flex-wrap:wrap; gap:8px; }
    .chip {
      background:var(--chip-bg); color:var(--chip-text);
      border:none; border-radius:999px; padding:8px 12px; font-size:20px;
      display:flex; align-items:center; gap:10px; box-shadow:inset 0 0 0 1px rgba(0,0,0,0.06);
    }
    .chip .x {
      width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center;
      font-weight:700; font-size:12px; cursor:pointer; background:#e8edf2; color:var(--chip-x); transition:background .15s;
    }
    .chip .x:hover { background:#dfe7ee; }

    /* Option boxes */
    .option-grid { display:flex; flex-direction:column; align-items:center; gap:12px; }
    .option-box { display:inline-block; padding:8px 14px; border:2px solid #000; border-radius:12px; font-weight:600; font-size:14px; background:#fff; cursor:pointer; }
    .option-box:active { transform:translateY(1px); }
    .option-box.selected { background-color:#d0f0ff; }

    .actions-sticky { position:sticky; top:8px; z-index:50; background:#fff; }

    /* OUTPUT (tic tac toe boards) */
    #output { display:flex; justify-content:center; padding:16px 0; flex-direction:column; gap:20px; }
    .page { width:8.5in; max-width:calc(100% - 32px); background:#fff; box-shadow:0 6px 20px rgba(0,0,0,.12); padding:0.5in; border:2px solid #000; border-radius:8px; margin:0 auto; }
    .worksheet-title { font-size:34px; margin-bottom:6px; font-weight:700; text-align:center; }
    .worksheet-directions { font-size:18px; margin-bottom:14px; text-align:center; }
    .board-wrap { display:grid; grid-template-columns: 1fr 1fr; gap:30px; justify-content:center; max-width:900px; margin:0 auto; }
    .tic-tac-toe { border-collapse:collapse; width:100%; }
    .tic-tac-toe td { border:none; height:80px; vertical-align:middle; text-align:center; padding:6px; font-size:24px; line-height:28px; word-break:break-word; }
    .board-shell { display:flex; flex-direction:column; align-items:center; width:100%; border:3px solid #000; border-radius:16px; padding:12px; background:#fff; box-sizing:border-box; }
    .board-label { font-weight:700; font-size:22px; margin-bottom:10px; }

    #copyright { font-size:12px; text-align:right; margin-top:12px; display:none; }

    /* PRINT */
    @media print {
      body { margin:0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .table-section, button, .chips-title, .chips-wrap, .subtitle, .layout, #floatingActions { display:none !important; }
      #output { margin:0; }
      .worksheet-title { font-size:20px; margin-bottom:2px; }
      .worksheet-directions { font-size:14px; margin-bottom:8px; }
      #copyright { display:block; }
      .page { width:auto; padding:0; box-shadow:none; border:none; }
    }

    /* Mobile / Compact */
    @media (max-width: 900px) {
      .layout { display:block; }
      .option-box { font-size:16px; padding:12px 16px; }
    }
    @media (min-width: 992px) {
      h1 { font-size: 22px; margin-bottom: 2px; }
      .table-section { padding:12px; }
      .section-label { font-size:16px; margin-bottom:8px; }
      .skill-block { margin-bottom:8px; border-radius:10px; }
      .skill-header { padding:8px 10px; font-size:16px; }
      .skill-header .arrow { font-size:18px; margin:0 8px; width:18px; }
      .skills-inner { padding:8px; gap:8px; }
      .skill-button { padding:6px 10px; font-size:14px; min-height:34px; border-radius:10px; }
      .chips-title { font-size:14px; margin-top:8px; }
      .chip { padding:6px 10px; font-size:12px; gap:8px; }
      .chip .x { width:16px; height:16px; font-size:11px; }
      .worksheet-title { font-size:28px; }
    }
  </style>
</head>
<body>
  <h1>Fluency Grid Generator</h1>
  <div class="subtitle">Pick skills on top. Step 2 toggles blends (3 sounds vs 4+ sounds). Then choose content, then generate four printable Tic-Tac-Toe boards.</div>

  <div class="layout">
    <div class="left">
      <!-- STEP 1 -->
      <div id="step1" class="table-section">
        <div class="section-label">Step 1: Select Skills</div>

        <!-- CVC Short Vowels -->
        <div class="skill-block bg-cvc">
          <div class="skill-header" data-target="cvc"><span class="arrow">▲</span><span class="title">CVC Short Vowels</span><span class="arrow">▲</span></div>
          <div class="skills-inner" id="section-cvc">
            <button class="skill-button cvc" data-skill="Short A">Short A</button>
            <button class="skill-button cvc" data-skill="Short E">Short E</button>
            <button class="skill-button cvc" data-skill="Short I">Short I</button>
            <button class="skill-button cvc" data-skill="Short O">Short O</button>
            <button class="skill-button cvc" data-skill="Short U">Short U</button>
            <button class="skill-button cvc" data-skill="Mixed CVC">Mixed CVC</button>
            <button class="skill-button cvc" data-skill="FLSZ">FLSZ</button>
          </div>
        </div>

        <!-- Digraphs -->
        <div class="skill-block bg-dig">
          <div class="skill-header" data-target="dig"><span class="arrow">▼</span><span class="title">Digraphs</span><span class="arrow">▼</span></div>
          <div class="skills-inner collapsed" id="section-dig">
            <button class="skill-button dig" data-skill="ck">ck</button>
            <button class="skill-button dig" data-skill="sh">sh</button>
            <button class="skill-button dig" data-skill="th">th</button>
            <button class="skill-button dig" data-skill="ch">ch</button>
            <button class="skill-button dig" data-skill="wh">wh</button>
            <button class="skill-button dig" data-skill="Digraphs Mixed">Digraphs Mixed</button>
          </div>
        </div>

        <!-- Glued Sounds -->
        <div class="skill-block bg-glued">
          <div class="skill-header" data-target="glued"><span class="arrow">▼</span><span class="title">Glued Sounds</span><span class="arrow">▼</span></div>
          <div class="skills-inner collapsed" id="section-glued">
            <button class="skill-button glued" data-skill="-all">-all</button>
            <button class="skill-button glued" data-skill="-ng">-ng</button>
            <button class="skill-button glued" data-skill="-nk">-nk</button>
            <button class="skill-button glued" data-skill="Glued Mixed">Glued Mixed</button>
          </div>
        </div>

        <!-- VCe -->
        <div class="skill-block bg-vce">
          <div class="skill-header" data-target="vce"><span class="arrow">▼</span><span class="title">Silent E (VCe)</span><span class="arrow">▼</span></div>
          <div class="skills-inner collapsed" id="section-vce">
            <button class="skill-button vce" data-skill="a_e">a_e</button>
            <button class="skill-button vce" data-skill="i_e">i_e</button>
            <button class="skill-button vce" data-skill="o_e">o_e</button>
            <button class="skill-button vce" data-skill="u_e">u_e</button>
            <button class="skill-button vce" data-skill="Mixed VCe">Mixed VCe</button>
          </div>
        </div>

        <!-- R-Controlled -->
        <div class="skill-block bg-rctrl">
          <div class="skill-header" data-target="rctrl"><span class="arrow">▼</span><span class="title">R-Controlled</span><span class="arrow">▼</span></div>
          <div class="skills-inner collapsed" id="section-rctrl">
            <button class="skill-button rctrl" data-skill="ar">ar</button>
            <button class="skill-button rctrl" data-skill="or">or</button>
            <button class="skill-button rctrl" data-skill="er/ir/ur">er/ir/ur</button>
            <button class="skill-button rctrl" data-skill="Mixed R-Controlled">Mixed R-Controlled</button>
          </div>
        </div>

        <!-- Vowel Teams -->
        <div class="skill-block bg-vteams">
          <div class="skill-header" data-target="vteams"><span class="arrow">▼</span><span class="title">Vowel Teams</span><span class="arrow">▼</span></div>
          <div class="skills-inner collapsed" id="section-vteams">
            <button class="skill-button vteams" data-skill="Long A (ai/ay)">Long A (ai/ay)</button>
            <button class="skill-button vteams" data-skill="Long E (ee/ea)">Long E (ee/ea)</button>
            <button class="skill-button vteams" data-skill="Long I (igh/y/ie)">Long I (igh/y/ie)</button>
            <span class="break"></span>
            <button class="skill-button vteams" data-skill="Long O (oa/ow/oe)">Long O (oa/ow/oe)</button>
            <button class="skill-button vteams" data-skill="Long U (oo/ew/ue)">Long U (oo/ew/ue)</button>
            <button class="skill-button vteams" data-skill="Mixed Vowel Teams">Mixed Vowel Teams</button>
          </div>
        </div>

        <!-- Diphthongs -->
        <div class="skill-block bg-dip">
          <div class="skill-header" data-target="dip"><span class="arrow">▼</span><span class="title">Diphthongs</span><span class="arrow">▼</span></div>
          <div class="skills-inner collapsed" id="section-dip">
            <button class="skill-button dip" data-skill="oy/oi">oy/oi</button>
            <button class="skill-button dip" data-skill="ow/ou">ow/ou</button>
          </div>
        </div>

        <!-- Variant Vowels -->
        <div class="skill-block bg-variant">
          <div class="skill-header" data-target="variant"><span class="arrow">▼</span><span class="title">Variant Vowels</span><span class="arrow">▼</span></div>
          <div class="skills-inner collapsed" id="section-variant">
            <button class="skill-button variant" data-skill="au/aw">au/aw</button>
            <button class="skill-button variant" data-skill="oo">oo</button>
          </div>
        </div>

        <!-- Soft Endings -->
        <div class="skill-block bg-soft">
          <div class="skill-header" data-target="soft"><span class="arrow">▼</span><span class="title">Soft C/G Endings</span><span class="arrow">▼</span></div>
          <div class="skills-inner collapsed" id="section-soft">
            <button class="skill-button soft" data-skill="Soft C/G Endings">Soft C/G Endings (-ce/-ge/-dge)</button>
          </div>
        </div>
      </div>
    </div>

    <div class="right-top">
      <!-- STEP 2 -->
      <div class="table-section tight">
        <div class="section-label">Step 2: Include Blends?</div>
        <div class="option-grid" id="blendOptions">
          <div class="option-box" data-blends="no">No – 3 Sounds</div>
          <div class="option-box" data-blends="yes">Yes – 4+ Sounds</div>
        </div>
      </div>
    </div>

    <div class="right-bottom">
      <!-- STEP 3 -->
      <div class="table-section tight">
        <div class="section-label">Step 3: What would you like in the grid?</div>
        <div class="option-grid" id="contentOptions">
          <div class="option-box" data-mode="words">Words Only</div>
          <div class="option-box" data-mode="sentences">Sentences Only</div>
          <div class="option-box" data-mode="both">Both</div>
        </div>
      </div>

      <!-- STEP 4 -->
      <div class="table-section actions-sticky tight">
        <div class="section-label">Step 4: Generate & Print</div>

        <div class="chips-title">Skills Selected:</div>
        <div id="chips" class="chips-wrap"></div>

        <div style="text-align:center; margin-top:10px;">
          <button id="btnGenerate" style="font-size: 18px; padding: 10px 24px;">Generate</button>
          <button onclick="window.print()" style="font-size: 18px; padding: 10px 24px;">Print</button>
        </div>
      </div>
    </div>
  </div>

  <!-- OUTPUT -->
  <div id="output"></div>

  <!-- Desktop-only floating actions -->
  <div id="floatingActions" style="
    position: fixed; right: 16px; bottom: 16px; z-index: 1000;
    background:#ffffff; border:2px solid #000; border-radius:12px;
    box-shadow: 0 6px 20px rgba(0,0,0,.15); padding:10px 12px;
    display:none; gap:8px; align-items:center;">
    <button id="fabGenerate" style="font-size:14px; padding:8px 12px;">Generate</button>
    <button id="fabPrint" style="font-size:14px; padding:8px 12px;">Print</button>
  </div>

<script>
/* ========= CORE WIRING ========= */
// CSS.escape polyfill
if (typeof CSS === 'undefined' || typeof CSS.escape !== 'function') {
  window.CSS = window.CSS || {};
  CSS.escape = CSS.escape || function(sel){ return (sel+'').replace(/[^a-zA-Z0-9_-]/g,'\\\\$&'); };
}

/* 
  SUPPORTED skill codes → base keys in your data.
  We align to known keys present in fluencyWords/fluencySentences.
  You can expand this map over time; everything is clickable either way.
*/
const SUPPORTED = {
  // Level 0 (CVC) + FLSZ
  "Short A": "0.1",
  "Short O": "0.2",
  "Short I": "0.3",
  "Short U": "0.4",
  "Short E": "0.5",
  "FLSZ": "0.6",
  "Mixed CVC": "mixed",

  // R-controlled (Level 4 examples present in v8-2)
  "ar": "4.1",
  "or": "4.2",
  "er/ir/ur": "4.3",
  "Mixed R-Controlled": "4.4",

  // A few blend-heavy sets (examples from v8-2, words only)
  "ck": "1.1-ck",
  "sh": "1.2-sh",
  "th": "1.3-th",
  "ch": "1.4-ch"
};

const SKILL_LABEL = {
  "0.1": "Short A",
  "0.2": "Short O",
  "0.3": "Short I",
  "0.4": "Short U",
  "0.5": "Short E",
  "0.6": "FLSZ",
  "mixed": "Mixed CVC",
  "4.1": "ar",
  "4.2": "or",
  "4.3": "er/ir/ur",
  "4.4": "R-Controlled (Mixed)",
  "1.1-ck": "ck",
  "1.2-sh": "sh",
  "1.3-th": "th",
  "1.4-ch": "ch"
};

/* 
  DATA KEY RESOLVER
  For v8-2, the data lives in:
   - fluencyWords       (keys like "0.1 - Short A Words", "0.1 - Short A with Blends Words", ...)
   - fluencySentences   (keys like "0.1 - Short A Sentences", "Mixed CVC Sentences", ...)
*/
const DATA_KEYS = {
  words: {
    "0.1": '0.1 - Short A Words',
    "0.2": '0.2 - Short O Words',
    "0.3": '0.3 - Short I Words',
    "0.4": '0.4 - Short U Words',
    "0.5": '0.5 - Short E Words',
    "0.6": '0.6 - FLSZ',
    "mixed": 'Mixed CVC Words',
    "4.1": '4.1 - ar Words',
    "4.2": '4.2 - or Words',
    "4.3": '4.3 - er, ir, ur Words',
    "4.4": '4.4 - R-Controlled Words',
    "1.1-ck": '1.1 - ck with Blends Words',
    "1.2-sh": '1.2 - sh with Blends Words',
    "1.3-th": '1.3 - th with Blends Words',
    "1.4-ch": '1.4 - ch with Blends Words'
  },
  sentences: {
    "0.1": '0.1 - Short A Sentences',
    "0.2": '0.2 - Short O Sentences',
    "0.3": '0.3 - Short I Sentences',
    "0.4": '0.4 - Short U Sentences',
    "0.5": '0.5 - Short E Sentences',
    "0.6": '0.6 - FLSZ Sentences',
    "mixed": 'Mixed CVC Sentences',
    // Some higher levels may not have sentences in v8-2; the resolver falls back if missing
    "4.1": '4.1 - ar Sentences',
    "4.2": '4.2 - or Sentences',
    "4.3": '4.3 - er, ir, ur Sentences',
    "4.4": '4.4 - R-Controlled Sentences',
    "1.1-ck": '1.1 - ck Sentences',
    "1.2-sh": '1.2 - sh Sentences',
    "1.3-th": '1.3 - th Sentences',
    "1.4-ch": '1.4 - ch Sentences'
  }
};

const selectedCodes = new Set();
let mode = null;           // 'words' | 'sentences' | 'both'
let includeBlends = false; // Step 2 toggle

/* expand/collapse blocks */
document.querySelectorAll('.skill-header').forEach(header => {
  header.addEventListener('click', () => {
    const target = header.getAttribute('data-target');
    const inner = document.getElementById('section-' + target);
    const arrows = header.querySelectorAll('.arrow');
    const isCollapsed = inner.classList.contains('collapsed');
    if (isCollapsed) {
      inner.classList.remove('collapsed');
      arrows.forEach(a => a.textContent = '▲');
    } else {
      inner.classList.add('collapsed');
      arrows.forEach(a => a.textContent = '▼');
    }
  });
});

/* step 1 selection (all buttons are enabled) */
document.querySelectorAll('.skill-button').forEach(btn => {
  btn.addEventListener('click', (e) => {
    e.stopPropagation();
    const label = btn.dataset.skill;
    const code = SUPPORTED[label] || label; // allow ad-hoc labels; resolver will try best
    if (selectedCodes.has(code)) {
      selectedCodes.delete(code);
      btn.classList.remove('selected');
    } else {
      selectedCodes.add(code);
      btn.classList.add('selected');
    }
    renderChips();
  });
});

/* chips render/remove */
function renderChips(){
  const wrap = document.getElementById('chips');
  wrap.innerHTML = '';
  Array.from(selectedCodes).forEach(code => {
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.innerHTML = `<span>${SKILL_LABEL[code] || code}</span><span class="x" title="Remove">×</span>`;
    chip.querySelector('.x').addEventListener('click', () => {
      selectedCodes.delete(code);
      const label = SKILL_LABEL[code] || code;
      const btn = document.querySelector(`.skill-button[data-skill="${CSS.escape(label)}"]`);
      if (btn) btn.classList.remove('selected');
      renderChips();
    });
    wrap.appendChild(chip);
  });
}

/* Step 2: blends toggle */
document.querySelectorAll('#blendOptions .option-box').forEach(box => {
  box.addEventListener('click', () => {
    document.querySelectorAll('#blendOptions .option-box').forEach(b => b.classList.remove('selected'));
    box.classList.add('selected');
    includeBlends = (box.dataset.blends === 'yes');
  });
});

/* Step 3: mode selection */
document.querySelectorAll('#contentOptions .option-box').forEach(box => {
  box.addEventListener('click', () => {
    document.querySelectorAll('#contentOptions .option-box').forEach(b => b.classList.remove('selected'));
    box.classList.add('selected');
    mode = box.dataset.mode; // words | sentences | both
  });
});

/* floating actions (desktop) */
function toggleFloatingBar(){
  const el = document.getElementById('floatingActions');
  const isDesktop = window.matchMedia('(min-width: 992px)').matches;
  el.style.display = isDesktop ? 'flex' : 'none';
}
toggleFloatingBar();
window.addEventListener('resize', toggleFloatingBar);
document.getElementById('fabGenerate')?.addEventListener('click', () => {
  document.getElementById('btnGenerate')?.click();
});
document.getElementById('fabPrint')?.addEventListener('click', () => window.print());

/* ===== Data helpers (v8-2 aware) ===== */

/* Safely access global data even if not on window */
function hasGlobal(name){
  try { return (typeof self[name] !== 'undefined'); } catch(e){ return false; }
}
function getWordsDict(){ return hasGlobal('fluencyWords') ? self['fluencyWords'] : {}; }
function getSentencesDict(){ return hasGlobal('fluencySentences') ? self['fluencySentences'] : {}; }

/* Build the most likely key for a base code */
function baseKeyFor(code, type){
  const dict = (type === 'words') ? DATA_KEYS.words : DATA_KEYS.sentences;
  return dict[code];
}

/* When blends are ON, try to find a "... with Blends ..." key in fluencyWords/fluencySentences */
function resolveDataKey(code, type){
  const base = baseKeyFor(code, type);
  if (!base) return null;

  if (!includeBlends) return base;

  // Only attempt blends-special keys where it makes sense (usually words).
  const dict = (type === 'words') ? getWordsDict() : getSentencesDict();
  const candidates = [];

  // Common naming patterns in v8-2
  if (type === 'words'){
    // e.g., "0.1 - Short A with Blends Words"
    candidates.push(base.replace(' Words', ' with Blends Words'));
    // R-controlled variants: "4.1 - ar with Blends Words"
    if (!/with Blends/.test(base) && / Words$/.test(base)) {
      const before = base.replace(/ Words$/, '');
      candidates.push(before + ' with Blends Words');
    }
  } else {
    // sentences rarely have blends; still check a couple of variants and fall back
    candidates.push(base.replace(' Sentences', ' with Blends Sentences'));
  }

  for (const cand of candidates){
    if (dict && Object.prototype.hasOwnProperty.call(dict, cand)) return cand;
  }
  return base; // fallback to base if no blends list exists
}

/* 🔎 DATA CALL */
function listFor(code, type){
  const key = resolveDataKey(code, type);
  if (!key) return [];

  if (type === 'words') {
    const src = getWordsDict();
    const arr = src[key];
    return Array.isArray(arr) ? arr : [];
  } else {
    const src = getSentencesDict();
    const arr = src[key];
    return Array.isArray(arr) ? arr : [];
  }
}

function pick(arr, n){ return arr.slice().sort(()=>Math.random()-0.5).slice(0, n); }

function gatherBalanced(codes, mode, totalCells){
  // Filter codes that actually have data for the chosen mode
  const available = codes.filter(c => listFor(c, mode === 'sentences' ? 'sentences' : 'words').length > 0);
  if (available.length === 0) return [];

  if (mode !== 'both'){
    const per = Math.max(1, Math.floor(totalCells / available.length));
    let pool = [];
    for (const c of available) pool = pool.concat(pick(listFor(c, mode), per));
    for (const c of available){
      if (pool.length >= totalCells) break;
      pool = pool.concat(pick(listFor(c, mode), totalCells - pool.length));
    }
    return pick(pool, totalCells);
  }

  // both
  const targetW = Math.floor(totalCells/2);
  const targetS = totalCells - targetW;

  const availableW = available.filter(c => listFor(c, 'words').length);
  const availableS = available.filter(c => listFor(c, 'sentences').length);

  // if no sentences exist for selected codes, fall back to words
  if (availableS.length === 0) {
    return gatherBalanced(availableW, 'words', totalCells);
  }

  const perW = Math.max(1, Math.floor(targetW / Math.max(1, availableW.length)));
  const perS = Math.max(1, Math.floor(targetS / Math.max(1, availableS.length)));
  let words = [], sents = [];

  for (const c of availableW) words = words.concat(pick(listFor(c, 'words'), perW));
  for (const c of availableS) sents = sents.concat(pick(listFor(c, 'sentences'), perS));

  for (const c of availableW){
    if (words.length >= targetW) break;
    words = words.concat(pick(listFor(c, 'words'), targetW - words.length));
  }
  for (const c of availableS){
    if (sents.length >= targetS) break;
    sents = sents.concat(pick(listFor(c, 'sentences'), targetS - sents.length));
  }
  return pick(words.concat(sents), totalCells);
}

/* build a single 3x3 board */
function buildBoard(cells){
  const tbl = document.createElement('table');
  tbl.className = 'tic-tac-toe';
  for (let r=0;r<3;r++){
    const row = tbl.insertRow();
    for (let c=0;c<3;c++){
      const td = row.insertCell();
      const val = cells[r*3+c] ?? '';
      const isSentence = (typeof val === 'string') && val.trim().includes(' ');
      td.textContent = val;
      if (r<2) td.style.borderBottom = '6px solid black';
      if (c<2) td.style.borderRight  = '6px solid black';
      td.style.fontSize = isSentence ? '20px' : '24px';
      td.style.lineHeight = isSentence ? '22px' : '28px';
    }
  }
  const wrap = document.createElement('div');
  wrap.className = 'board-shell';
  const label = document.createElement('div');
  label.className = 'board-label';
  label.textContent = ''; // set by caller
  wrap.appendChild(label);
  wrap.appendChild(tbl);
  return wrap;
}

/* GENERATE */
function generateBoards(){
  if (selectedCodes.size === 0) return alert('Select at least one skill in Step 1.');
  if (!mode) return alert('Choose Words Only / Sentences Only / Both in Step 3.');

  // get data presence check
  const codes = Array.from(selectedCodes);
  const TOTAL = 36; // 4 x 9
  const content = gatherBalanced(codes, mode, TOTAL);

  if (content.length < TOTAL) {
    return alert('Not enough content from the selected skills for the chosen settings. Try adding more skills or changing blends/content options.');
  }

  const output = document.getElementById('output');
  output.innerHTML = '';

  const page = document.createElement('div');
  page.className = 'page';

  const title = document.createElement('div');
  title.className = 'worksheet-title';
  const picked = codes.map(c=>SKILL_LABEL[c] || c).join(' • ');
  title.textContent = `${picked} Tic Tac Toe Game`;

  const directions = document.createElement('div');
  directions.className = 'worksheet-directions';
  directions.innerHTML = '<strong>Directions:</strong> Read the word or sentence in the space you’d like to go, then put an X or O. Your opponent does the same. If you get 3 in a row…you win!';

  const grid = document.createElement('div');
  grid.className = 'board-wrap';
  const chunks = [0,9,18,27].map(i => content.slice(i, i+9));
  chunks.forEach((nine, idx) => {
    const group = buildBoard(nine);
    group.querySelector('.board-label').textContent = `Game ${idx+1}`;
    grid.appendChild(group);
  });

  const copy = document.createElement('div');
  copy.id = 'copyright';
  copy.innerHTML = 'Copyright - InterventionStation.com - @TeachwithMrC';

  page.appendChild(title);
  page.appendChild(directions);
  page.appendChild(grid);
  page.appendChild(copy);
  output.appendChild(page);
  output.scrollIntoView({ behavior:'smooth', block:'start' });
}

document.getElementById('btnGenerate').addEventListener('click', generateBoards);
</script>
</body>
</html>
