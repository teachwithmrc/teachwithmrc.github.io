<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Word Mapping Generator - PREVIEW MODE</title>
  <script src="newtry_FULL.js" defer></script>
  <script src="multisyllabic_wordbanks.js" defer></script>
  <script src="preview_tryme_mobile_mode.js?v=20260226-tryme4" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    @font-face { font-family:'BoxesFont'; src:url('fonts/boxes2.otf') format('opentype'); }
    @font-face { font-family:'UnderlineFont'; src:url('fonts/underlines.otf') format('opentype'); }

    :root{
      --chip-bg:#f3f6fb; --chip-text:#263238; 
    }

    body { 
      font-family:'Poppins',sans-serif; margin:28px; text-align:center; background:#fafafa; 
      /* Prevent selection */
      user-select: none; -webkit-user-select: none;
    }
    h1 { font-size: 32px; margin-bottom: 6px; }
    .subtitle { color: #555; margin: 0 0 20px; }

    /* Feature Badge */
    .feature-badge {
      display: inline-block;
      background: #e3f2fd;
      color: #1565c0;
      font-weight: 800;
      padding: 8px 16px;
      border-radius: 99px;
      margin-bottom: 15px;
      border: 1px solid #bbdefb;
      font-size: 14px;
    }

    /* COMPACT CONTROL BAR */
    .controls-wrapper {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 20px;
      max-width: 850px;
      margin: 0 auto 20px auto;
      background: #fff;
      border: 2px solid #000;
      border-radius: 12px;
      padding: 15px 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    .options-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center; 
    }
    
    /* On larger screens, align better */
    @media (min-width: 700px) {
      .options-group { align-items: flex-end; }
      .controls-wrapper { flex-wrap: nowrap; }
    }

    .option-row { display: flex; gap: 8px; }
    
    .option-box { 
      display: inline-block; 
      padding: 8px 14px; 
      border: 2px solid #000; 
      border-radius: 8px; 
      font-weight: 600; 
      font-size: 14px; 
      background: #fff; 
      cursor: pointer; 
      transition: 0.1s; 
    }
    .option-box:hover { transform: translateY(-1px); box-shadow: 0 2px 0 #000; }
    .option-box.selected { background-color: #111; color: #fff; }
    .option-box.disabled { opacity: 0.45; pointer-events: none; }

    .actions-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
      min-width: 200px;
    }

    /* Button Styling */
    .try-me-btn {
      background: #111;
      color: #fff;
      border: 3px solid #000;
      font-size: 20px;
      font-weight: 800;
      padding: 12px 30px;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 5px 0 #444;
      transition: all 0.1s;
      width: 100%;
      white-space: nowrap;
    }
    .try-me-btn:active {
      transform: translateY(5px);
      box-shadow: none;
    }
    .print-btn {
      background: #f0f0f0;
      color: #999;
      border: 1px solid #ccc;
      font-size: 12px;
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: not-allowed;
      width: 100%;
    }

    #output { display: flex; justify-content: center; padding: 0 0 20px 0; flex-direction: column; gap: 20px; }

    /* Worksheet Layout */
    .word-table { width:100%; border-collapse:collapse; margin-top:20px; border:2px solid black; }
    .word-table td { width:50%; text-align:center; vertical-align:middle; padding:24px 0; border:2px solid black; }
    .worksheet-title { font-size:40px; margin-bottom:5px; font-weight:700; }
    .worksheet-directions { font-size:22px; margin-bottom:20px; }
    .word { font-size:28px; font-weight:700; margin-bottom:12px; }
    .pattern {
      font-size:60px; transform:scale(1.5); display:inline-block;
      font-family:'BoxesFont', monospace; font-weight:normal; line-height:1;
      margin-top:12px; margin-bottom:16px;
    }
    .pattern.underlines { font-family:'UnderlineFont', monospace; font-weight:normal; letter-spacing:0; }
    .pattern.underlines span { display:inline-block; margin:0 2px; }
    .pattern.syllables {
      font-family:'BoxesFont', monospace;
      transform:scale(1.35);
      letter-spacing:0;
      font-weight:normal;
      font-size:60px;
    }

    /* Screen preview page sizing */
    @media screen {
      #output { display:flex; justify-content:center; padding:16px 0; }
      #output .page {
        width: 8.5in; 
        max-width: calc(100% - 32px);
        background:#fff;
        box-shadow: 0 6px 20px rgba(0,0,0,.12);
        padding: 0.5in; 
        border: 2px solid #000;
        border-radius: 8px;
        position: relative; /* For lock card positioning context if needed */
      }
      #output .worksheet-title,
      #output .worksheet-directions,
      #output .word-table,
      #output #copyright { max-width: 100%; margin-left:auto; margin-right:auto; }
      #output .word-table { width:100%; }
    }

    #copyright { font-size:12px; text-align:right; margin-top:12px; display:block; }

    /* ========= PREVIEW MODE STYLES ========= */
    .preview-wrapper {
      position: relative;
      pointer-events: none;
    }

    .fomo-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;

      /* BLUR FILTER */
      backdrop-filter: blur(2.5px);
      -webkit-backdrop-filter: blur(2.5px);
      background: rgba(255, 255, 255, 0.1);

      /* REPEATING WATERMARK */
      background-image: url("data:image/svg+xml,%3Csvg width='250' height='250' viewBox='0 0 250 250' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext x='20' y='150' fill='%23000' opacity='0.15' transform='rotate(-45 125 125)' font-family='Poppins' font-weight='900' font-size='32'%3EPREVIEW MODE%3C/text%3E%3C/svg%3E");
      
      pointer-events: auto;
    }

    .lock-card {
      background: #111;
      color: #fff;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.25);
      max-width: 400px;
      animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 2px solid #fff;
    }
    @keyframes popIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .lock-icon { font-size: 40px; margin-bottom: 15px; display:block; }
    .lock-title { font-size: 24px; font-weight: 900; margin-bottom: 10px; line-height:1.2; }
    .lock-desc { font-size: 14px; margin-bottom: 25px; opacity: 0.9; line-height: 1.5;}
    
    .cta-btn {
      display: inline-block;
      background: #fff;
      color: #111;
      text-decoration: none;
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 800;
      font-size: 16px;
      transition: all 0.2s;
    }
    .cta-btn:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(255,255,255,0.3); }

    /* Print Block */
    @media print {
      body { display: none !important; }
    }
  </style>
</head>

<body oncontextmenu="return false;">
  <h1>Word Mapping Generator</h1>
  <div class="feature-badge">‚ö° Includes over 40+ Phonics Skills</div>
  <div class="subtitle">Select your settings and hit TRY ME to generate a random worksheet!</div>

  <div class="controls-wrapper">
    
    <div class="options-group">
      <div class="option-row" id="blendOptions">
        <div class="option-box selected" id="includeBlendsNo">No Blends</div>
        <div class="option-box" id="includeBlendsYes">Include Blends</div>
      </div>

      <div class="option-row" id="styleOptions">
        <div class="option-box selected" data-style="boxes">Elkonin Boxes</div>
        <div class="option-box" data-style="underlines">Underlines</div>
      </div>
      <div class="option-row" id="patternModeOptions">
        <div class="option-box selected" data-mode="soundBoxes">Sound Boxes</div>
        <div class="option-box" data-mode="syllables">Syllable Lengths</div>
      </div>
      <div class="option-row" id="syllableCountOptions">
        <div class="option-box selected" data-count="2">2 Syll</div>
        <div class="option-box" data-count="3">3 Syll</div>
        <div class="option-box" data-count="4plus">4+ Syll</div>
      </div>
      <div class="option-row" id="divisionRuleOptions">
        <div class="option-box selected" data-rule="all">All Rules</div>
        <div class="option-box" data-rule="tiger">Tiger</div>
        <div class="option-box" data-rule="rabbit">Rabbit</div>
      </div>
    </div>

    <div class="actions-group">
      <button id="btnGenerate" class="try-me-btn">üé≤ TRY ME!</button>
      <button id="btnPrint" class="print-btn">üñ®Ô∏è Print Worksheet</button>
    </div>

  </div>

 <center><img src="images/chrome.png" class="no-print" style="margin-bottom:10px; opacity:0.8;"></center>

  <div class="preview-wrapper">
    <div class="fomo-overlay">
      <div class="lock-card">
        <span class="lock-icon">üîí</span>
        <div class="lock-title">Premium Resource</div>
        <div class="lock-desc">
          You are viewing a preview of the Word Mapping Generator. 
          Upgrade to Intervention Station Premium to unlock all 40+ skills, printing, and watermark removal.
        </div>
        <a href="#" class="cta-btn">Unlock Full Access</a>
      </div>
    </div>

    <div id="output"></div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // CSS.escape polyfill
  if (typeof CSS === 'undefined' || typeof CSS.escape !== 'function') {
    window.CSS = window.CSS || {};
    CSS.escape = CSS.escape || function(sel){ return (sel+'').replace(/[^a-zA-Z0-9_-]/g,'\\\\$&'); };
  }

  // --- STATE ---
  let includeBlends = false; 
  let cellStyle = 'boxes';
  let patternMode = 'soundBoxes';
  let multisyllableCount = '2';
  let divisionRule = 'all';
  let selectedSkill = null; 

  // --- ALL SKILLS LIST FOR RANDOM PICKER ---
  const MULTISYLLABIC_SKILLS = new Set([
    "Multisyllabic (Closed)",
    "Multisyllabic (Open)",
    "Multisyllabic (VCe)",
    "Multisyllabic (R-Controlled)",
    "Multisyllabic (Vowel Team)",
    "Multisyllabic (C-le)",
    "Multisyllabic Mixed",
    "Multisyllabic (All 6 Types)"
  ]);

  const ALL_SKILLS = [
    "Short A", "Short E", "Short I", "Short O", "Short U", "Mixed CVC", "FLSZ Words",
    "Digraph(ck)", "Digraph(sh)", "Digraph(th)", "Digraph(ch)", "Digraph(wh)", "Digraphs Mixed",
    "Glued(all)", "Glued(-ng)", "Glued(-nk)", "Glued Mixed",
    "VCe(a_e)", "VCe(i_e)", "VCe(o_e)", "VCe(u_e)", "Mixed VCe",
    "R-Controlled(ar)", "R-Controlled(or)", "R-Controlled(er,ir,ur)", "Mixed R-Controlled",
    "Long A (ai/ay)", "Long E (ee/ea)", "Long I (igh/y/ie)", "Long O (oa/ow/oe)", "Long U (oo/ew/ue)", "Mixed Vowel Teams",
    "Diphthongs (oy/oi)", "Diphthongs (ow/ou)",
    "Variant Vowels (au/aw)", "Variant Vowel (oo)",
    "Soft Endings",
    "Multisyllabic (Closed)", "Multisyllabic (Open)", "Multisyllabic (VCe)",
    "Multisyllabic (R-Controlled)", "Multisyllabic (Vowel Team)", "Multisyllabic (C-le)",
    "Multisyllabic Mixed", "Multisyllabic (All 6 Types)"
  ];

  // --- UI TOGGLES ---
  
  // Blends
  const yesBlend = document.getElementById('includeBlendsYes');
  const noBlend  = document.getElementById('includeBlendsNo');
  function syncBlendControlsForSkill(skill) {
    const lockBlends = MULTISYLLABIC_SKILLS.has(skill);
    yesBlend.classList.toggle('disabled', lockBlends);
    noBlend.classList.toggle('disabled', lockBlends);
    if (lockBlends) {
      includeBlends = false;
      noBlend.classList.add('selected');
      yesBlend.classList.remove('selected');
    }
  }
  
  yesBlend.addEventListener('click', ()=>{ 
    if (yesBlend.classList.contains('disabled')) return;
    includeBlends = true; 
    yesBlend.classList.add('selected'); 
    noBlend.classList.remove('selected'); 
  });
  
  noBlend.addEventListener('click', ()=>{ 
    if (noBlend.classList.contains('disabled')) return;
    includeBlends = false; 
    noBlend.classList.add('selected'); 
    yesBlend.classList.remove('selected'); 
  });

  // Style
  document.querySelectorAll('#styleOptions .option-box').forEach(box => {
    box.addEventListener('click', ()=>{
      document.querySelectorAll('#styleOptions .option-box').forEach(b=>b.classList.remove('selected'));
      box.classList.add('selected');
      cellStyle = box.dataset.style;
    });
  });

  // Pattern Mode
  document.querySelectorAll('#patternModeOptions .option-box').forEach(box => {
    box.addEventListener('click', ()=>{
      document.querySelectorAll('#patternModeOptions .option-box').forEach(b=>b.classList.remove('selected'));
      box.classList.add('selected');
      patternMode = box.dataset.mode;
    });
  });

  // Syllable Count (for multisyllabic banks)
  document.querySelectorAll('#syllableCountOptions .option-box').forEach(box => {
    box.addEventListener('click', ()=>{
      document.querySelectorAll('#syllableCountOptions .option-box').forEach(b=>b.classList.remove('selected'));
      box.classList.add('selected');
      multisyllableCount = box.dataset.count;
    });
  });

  // Syllable Division Rule (for multisyllabic banks)
  document.querySelectorAll('#divisionRuleOptions .option-box').forEach(box => {
    box.addEventListener('click', ()=>{
      document.querySelectorAll('#divisionRuleOptions .option-box').forEach(b=>b.classList.remove('selected'));
      box.classList.add('selected');
      divisionRule = box.dataset.rule;
    });
  });

  // --- GENERATE BUTTON LOGIC (WITH FAIL-SAFE) ---
  document.getElementById('btnGenerate').addEventListener('click', () => {
    
    if (typeof soundBoxWords === 'undefined') { 
        // Silent fail or minimal fallback if data is missing, but assume data exists
        return; 
    }

    const source = soundBoxWords;
    let validSkills = [];

    // 1. Scan for skills that ACTUALLY have data for current settings
    ALL_SKILLS.forEach(skill => {
        const words = getWordsForSkill(skill, source, includeBlends);
        if (words && words.length > 0) {
            validSkills.push(skill);
        }
    });

    // 2. If no valid skills found (rare), force fallback to "Mixed CVC" with NO blends to ensure display
    if (validSkills.length === 0) {
        // Force fallback
        selectedSkill = "Mixed CVC";
        // Temporarily override blends locally for this generation only if needed, 
        // but for now let's just pick Mixed CVC and let the generator handle it.
    } else {
        // 3. Pick random valid skill
        selectedSkill = validSkills[Math.floor(Math.random() * validSkills.length)];
    }
    syncBlendControlsForSkill(selectedSkill);
    
    // 4. Generate without scroll
    generatePage();
  });

  // --- LOCKED PRINT ---
  function lockedPrint(){
      alert("This feature is locked in Preview Mode.\nPlease upgrade to print worksheets.");
  }
  document.getElementById('btnPrint')?.addEventListener('click', lockedPrint);


  // --- DATA FETCH & HELPERS ---
  function currentCellFont(){
    if (patternMode === 'syllables') return 'BoxesFont';
    return (cellStyle === 'underlines') ? 'UnderlineFont' : 'BoxesFont';
  }
  function currentCellClass(){
    if (patternMode === 'syllables') return 'syllables';
    return (cellStyle === 'underlines') ? 'underlines' : 'boxes';
  }
  function renderPatternHTML(pattern, useUnder){
    const safePattern = (pattern || "").toString();
    return useUnder ? Array.from(safePattern).map(d=>`<span>${d}</span>`).join('') : safePattern;
  }
  function getEffectiveSyllableCount(item){
    const normalized = Number(item && item.syllableCount);
    if (Number.isFinite(normalized) && normalized > 0) return normalized;
    return Array.isArray(item?.syllables) ? item.syllables.length : 0;
  }
  function syllableCount(item){
    return getEffectiveSyllableCount(item);
  }
  function shouldForceSyllableCode(item){
    return patternMode !== 'syllables' && syllableCount(item) > 3;
  }
  function getPatternForDisplay(item, useUnder) {
    if (patternMode === 'syllables' || shouldForceSyllableCode(item)) {
      if (item && item.syllableCode) return renderPatternHTML(item.syllableCode, false);
      if (window.multisyllableTools && item) {
        const fromTool = window.multisyllableTools.buildSyllableLengthCode(item);
        return renderPatternHTML(fromTool, false);
      }
      return "";
    }

    const basePattern = (item && item.pattern) ? item.pattern :
      ((window.multisyllableTools && item) ? window.multisyllableTools.buildBoxPattern(item) : "");
    return renderPatternHTML(basePattern, useUnder);
  }
  function shuffle(arr){ return [...arr].sort(() => Math.random() - 0.5); }
  function filterMultisyllabicWords(words) {
    if (!Array.isArray(words)) return [];
    return words.filter((item) => {
      const n = getEffectiveSyllableCount(item);
      const countMatch = multisyllableCount === '4plus' ? n >= 4 : n === Number(multisyllableCount);
      const ruleMatch = divisionRule === 'all' || (item && item.divisionRule === divisionRule);
      return countMatch && ruleMatch;
    });
  }

  function getWordsForSkill(skill, source, blends) {
    const blendSuffixes = [" with Blends", " with Digraphs and Blends"];

    function fetchBase(base){
      if (MULTISYLLABIC_SKILLS.has(base) || MULTISYLLABIC_SKILLS.has(skill)) {
        return filterMultisyllabicWords(source[base] || []);
      }
      // If we want blends, we try to find the blend version. 
      // If none found, we might return empty or base depending on logic.
      // Here we strictly look for what is requested to ensure accuracy.
      if (!blends) return source[base] || [];
      
      let result = [];
      blendSuffixes.forEach(suffix => {
        const key = `${base}${suffix}`;
        if (source[key]) result = result.concat(source[key]);
      });
      return result;
    }

    function dedupe(list){
      const seen = new Set();
      const out = [];
      for (const w of list) {
        const key = (w && w.word && w.pattern) ? `${w.word}|${w.pattern}` : JSON.stringify(w);
        if (!seen.has(key)) { seen.add(key); out.push(w); }
      }
      return out;
    }

    switch (skill) {
      // Short vowels & Mixed CVC
      case "Short A": return fetchBase("Short A");
      case "Short E": return fetchBase("Short E");
      case "Short I": return fetchBase("Short I");
      case "Short O": return fetchBase("Short O");
      case "Short U": return fetchBase("Short U");
      case "Mixed CVC":
        return [].concat(
          fetchBase("Short A"), fetchBase("Short E"), fetchBase("Short I"),
          fetchBase("Short O"), fetchBase("Short U")
        );

      // Digraphs
      case "Digraph(ck)": return fetchBase("Digraph(ck)");
      case "Digraph(sh)": return fetchBase("Digraph(sh)");
      case "Digraph(th)": return fetchBase("Digraph(th)");
      case "Digraph(ch)": return fetchBase("Digraph(ch)");
      case "Digraph(wh)": return fetchBase("Digraph(wh)");
      case "Digraphs Mixed":
        return [].concat(
          fetchBase("Digraph(ck)"), fetchBase("Digraph(sh)"),
          fetchBase("Digraph(th)"), fetchBase("Digraph(ch)"),
          fetchBase("Digraph(wh)")
        );

      // Glued Sounds
      case "Glued(all)": return fetchBase("Glued(all)");
      case "Glued(-ng)":
        return dedupe([].concat(
          fetchBase("Glued(ang)"), fetchBase("Glued(ing)"),
          fetchBase("Glued(ong)"), fetchBase("Glued(ung)")
        ));
      case "Glued(-nk)":
        return dedupe([].concat(
          fetchBase("Glued(ank)"), fetchBase("Glued(ink)"),
          fetchBase("Glued(onk)"), fetchBase("Glued(unk)")
        ));
      case "Glued Mixed":
        return dedupe([].concat(
          fetchBase("Glued(all)"),
          fetchBase("Glued(ang)"), fetchBase("Glued(ing)"),
          fetchBase("Glued(ong)"), fetchBase("Glued(ung)"),
          fetchBase("Glued(ank)"), fetchBase("Glued(ink)"),
          fetchBase("Glued(onk)"), fetchBase("Glued(unk)")
        ));

      // VCe
      case "VCe(a_e)": return fetchBase("VCe(a_e)");
      case "VCe(i_e)": return fetchBase("VCe(i_e)");
      case "VCe(o_e)": return fetchBase("VCe(o_e)");
      case "VCe(u_e)": return fetchBase("VCe(u_e)");
      case "Mixed VCe":
        return [].concat(
          fetchBase("VCe(a_e)"), fetchBase("VCe(i_e)"),
          fetchBase("VCe(o_e)"), fetchBase("VCe(u_e)")
        );

      // R-Controlled
      case "R-Controlled(ar)": return fetchBase("R-Controlled(ar)");
      case "R-Controlled(or)": return fetchBase("R-Controlled(or)");
      case "R-Controlled(er,ir,ur)": return fetchBase("R-Controlled(er,ir,ur)");
      case "Mixed R-Controlled":
        return [].concat(
          fetchBase("R-Controlled(ar)"), fetchBase("R-Controlled(or)"),
          fetchBase("R-Controlled(er,ir,ur)")
        );

      // Vowel Teams
      case "Long A (ai/ay)": return [].concat(fetchBase("Long A(ai)"), fetchBase("Long A(ay)"));
      case "Long E (ee/ea)": return [].concat(fetchBase("Long E(ee)"), fetchBase("Long E(ea)"));
      case "Long I (igh/y/ie)": return [].concat(fetchBase("Long I(igh)"), fetchBase("Long I(y)"), fetchBase("Long I(ie)"));
      case "Long O (oa/ow/oe)": return [].concat(fetchBase("Long O(oa)"), fetchBase("Long O(ow)"), fetchBase("Long O(oe)"));
      case "Long U (oo/ew/ue)": return [].concat(fetchBase("Long U(oo)"), fetchBase("Long U(ew)"), fetchBase("Long U(ue)"));
      case "Mixed Vowel Teams":
        return [].concat(
          fetchBase("Long A(ai)"), fetchBase("Long A(ay)"),
          fetchBase("Long E(ee)"), fetchBase("Long E(ea)"),
          fetchBase("Long I(igh)"), fetchBase("Long I(y)"), fetchBase("Long I(ie)"),
          fetchBase("Long O(oa)"), fetchBase("Long O(ow)"), fetchBase("Long O(oe)"),
          fetchBase("Long U(oo)"), fetchBase("Long U(ew)"), fetchBase("Long U(ue)")
        );

      // Diphthongs
      case "Diphthongs (oy/oi)": return [].concat(fetchBase("Diphthong(oy)"), fetchBase("Diphthong(oi)"));
      case "Diphthongs (ow/ou)": return [].concat(fetchBase("Diphthong(ow)"), fetchBase("Diphthong(ou)"));

      // Variant vowels
      case "Variant Vowels (au/aw)": return [].concat(fetchBase("Variant Vowel(aw)"), fetchBase("Variant Vowel(au)"));
      case "Variant Vowel (oo)": return fetchBase("Variant Vowel(oo)");

      // Soft C/G endings only
      case "Soft Endings":
        return [].concat(fetchBase("Soft C(ce)"), fetchBase("Soft G(ge)"), fetchBase("Soft G(dge)"));

      // Multisyllabic
      case "Multisyllabic (Closed)": return fetchBase("Multisyllabic (Closed)");
      case "Multisyllabic (Open)": return fetchBase("Multisyllabic (Open)");
      case "Multisyllabic (VCe)": return fetchBase("Multisyllabic (VCe)");
      case "Multisyllabic (R-Controlled)": return fetchBase("Multisyllabic (R-Controlled)");
      case "Multisyllabic (Vowel Team)": return fetchBase("Multisyllabic (Vowel Team)");
      case "Multisyllabic (C-le)": return fetchBase("Multisyllabic (C-le)");
      case "Multisyllabic Mixed": return fetchBase("Multisyllabic Mixed");
      case "Multisyllabic (All 6 Types)": return fetchBase("Multisyllabic (All 6 Types)");

      default: return fetchBase(skill);
    }
  }

  // Generate worksheet
  function generatePage() {
    if (typeof soundBoxWords === 'undefined') { return; } // Silent fail if data missing

    const source = soundBoxWords;
    let allWords = getWordsForSkill(selectedSkill, source, includeBlends);
    
    // Safety check again inside generation
    if (!allWords || allWords.length === 0) {
        // If somehow we got here with no words, try fallback
        selectedSkill = "Mixed CVC";
        allWords = getWordsForSkill("Mixed CVC", source, false); // No blends Mixed CVC is safest fallback
    }

    while (allWords.length < 8) allWords = allWords.concat(allWords);
    
    allWords = shuffle(allWords).slice(0,8);

    const output = document.getElementById('output');
    output.innerHTML = '';

    const page = document.createElement('div');
    page.className = 'page';

    const title = document.createElement('div');
    title.className = 'worksheet-title';
    title.textContent = `${selectedSkill} Word Mapping`;

    const directions = document.createElement('div');
    directions.className = 'worksheet-directions';
    directions.textContent = (patternMode === 'syllables')
      ? "Read each word, write its syllable length code, read it again."
      : "Read each word, write it in sound boxes. 4+ syllable words use syllable code.";

    page.appendChild(title);
    page.appendChild(directions);

    const table = document.createElement('table');
    table.className = 'word-table';

    const useUnder = (patternMode === 'soundBoxes' && cellStyle === 'underlines');

    for (let r=0; r<4; r++){
      const tr = document.createElement('tr');
      for (let c=0; c<2; c++){
        const td = document.createElement('td');
        const idx = r*2 + c;
        if (idx < allWords.length) {
          const item = allWords[idx];
          const forceSyllableCode = shouldForceSyllableCode(item);
          const patternHTML = getPatternForDisplay(item, forceSyllableCode ? false : useUnder);
          const patternClass = forceSyllableCode ? 'syllables' : currentCellClass();
          const fontName = forceSyllableCode ? 'BoxesFont' : currentCellFont();
          td.innerHTML = `
            <div class="word">${item.word}</div>
            <div class="pattern ${patternClass}" style="font-family:'${fontName}', monospace;">${patternHTML}</div>
          `;
        }
        tr.appendChild(td);
      }
      table.appendChild(tr);
    }
    page.appendChild(table);

    const copy = document.createElement('div');
    copy.id = 'copyright';
    copy.innerHTML = '<br>Copyright - InterventionStation.com - @TeachwithMrC';
    page.appendChild(copy);

    output.appendChild(page);
    
    // Scroll to wrapper to see lock card
    document.querySelector('.preview-wrapper').scrollIntoView({ behavior:'smooth', block:'start' });
  }

  // Generate on load with small delay
  window.onload = function() {
      setTimeout(()=> document.getElementById('btnGenerate').click(), 200);
  };

});
</script>
</body>
</html>
